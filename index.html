<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dompet Modern + Piutang</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4338ca', // Indigo-700
                        primaryLight: '#6366f1', // Indigo-500
                        secondary: '#10B981',
                        danger: '#EF4444',
                        surface: '#F8FAFC',
                        piutang: '#06b6d4' // Cyan-500 for Piutang
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(99, 102, 241, 0.3)'
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: #F8FAFC;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .loader {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.25em;
            height: 1.25em;
            border: 2px solid #cbd5e1;
            border-radius: 0.35em;
            display: grid;
            place-content: center;
            transition: all 0.2s ease-in-out;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            background-color: #EF4444;
            border-color: #EF4444;
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        .bg-pattern {
            background-color: #F8FAFC;
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 font-sans h-[100dvh] w-full overflow-hidden text-sm sm:text-base">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl z-[60] transition-all duration-300 opacity-0 pointer-events-none flex items-center gap-3 w-max max-w-[90%] border border-slate-700">
        <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
        <span id="toast-message" class="text-sm font-medium truncate">Berhasil</span>
    </div>

    <!-- Delete Floating Action Bar -->
    <div id="delete-bar" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-full shadow-xl shadow-red-100/50 z-[50] transition-all duration-300 translate-y-32 flex items-center gap-4 border border-red-100">
        <span class="text-sm font-bold text-slate-700"><span id="selected-count">0</span> Dipilih</span>
        <div class="h-4 w-px bg-slate-300"></div>
        <button id="btn-confirm-delete" onclick="deleteSelectedItems()" class="text-red-600 font-bold text-sm flex items-center gap-2 active:scale-95 transition hover:text-red-700">
            <i class="fas fa-trash-alt"></i> Hapus
        </button>
    </div>

    <!-- ================== LOGIN VIEW ================== -->
    <section id="login-view" class="h-full w-full flex flex-col items-center justify-center p-6 bg-pattern absolute inset-0 z-50 overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-indigo-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float" style="animation-delay: 2s"></div>

        <div class="w-full max-w-[360px] flex flex-col items-center relative z-10 animate-slide-up">
            <div class="w-full bg-white/70 backdrop-blur-xl border border-white/50 rounded-[2rem] shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-8">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-tr from-primary to-primaryLight rounded-2xl flex items-center justify-center shadow-glow mb-4 rotate-3 hover:rotate-6 transition-transform duration-300">
                        <i class="fas fa-wallet text-2xl text-white -rotate-3"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-900 tracking-tight">DompetKu</h1>
                    <p class="text-slate-500 text-xs font-medium mt-1">Kelola finansial dengan presisi</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div class="space-y-1.5">
                        <label for="email" class="text-xs font-semibold text-slate-600 ml-1">Email</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-slate-400 group-focus-within:text-primary transition-colors"></i>
                            </div>
                            <input type="email" id="email" class="w-full pl-11 pr-4 py-3.5 bg-white border border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none text-sm font-medium shadow-sm" placeholder="nama@email.com" autocomplete="email" required value="admin@uangku.com">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center ml-1">
                            <label for="password" class="text-xs font-semibold text-slate-600">Password</label>
                        </div>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-lock text-slate-400 group-focus-within:text-primary transition-colors"></i>
                            </div>
                            <input type="password" id="password" class="w-full pl-11 pr-11 py-3.5 bg-white border border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none text-sm font-medium shadow-sm" placeholder="••••••••" autocomplete="current-password" required value="123456">
                            <button type="button" onclick="togglePassword()" class="absolute right-0 top-0 bottom-0 px-4 text-slate-400 hover:text-slate-600 transition-colors focus:outline-none">
                                <i class="fas fa-eye text-xs" id="eye-icon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-1">
                        <label class="flex items-center gap-2 cursor-pointer touch-manipulation group">
                            <input type="checkbox" class="w-4 h-4 text-primary rounded border-slate-300 focus:ring-primary focus:ring-offset-0 transition cursor-pointer">
                            <span class="text-xs text-slate-500 group-hover:text-slate-700 transition-colors">Ingat Saya</span>
                        </label>
                        <a href="#" class="text-xs font-semibold text-primary hover:text-primaryDark transition-colors">Lupa Akses?</a>
                    </div>

                    <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-slate-200 transition-all transform active:scale-[0.98] mt-2 flex items-center justify-center gap-2 group">
                        <span>Masuk Aplikasi</span>
                        <i class="fas fa-arrow-right text-xs group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>
            </div>
            <div class="mt-8 text-center animate-fade-in" style="animation-delay: 0.2s">
                <div class="text-[10px] text-slate-400 font-medium">
                    Versi 3.5 • Ringkasan Hutang
                </div>
            </div>
        </div>
    </section>

    <!-- ================== APP VIEW ================== -->
    <section id="app-view" class="hidden h-full flex flex-col animate-fade-in relative bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm z-10 shrink-0 sticky top-0">
            <div>
                <h1 class="text-lg font-bold text-slate-900 tracking-tight">DompetKu</h1>
                <p class="text-[10px] text-slate-500 flex items-center gap-1 font-medium">
                    <span id="current-date">Memuat...</span>
                    <span id="offline-indicator" class="hidden text-orange-500 font-bold ml-1">• Offline</span>
                </p>
            </div>
            <div class="flex gap-2">
                 <button onclick="fetchData(true)" class="p-2 w-9 h-9 rounded-full bg-slate-50 border border-slate-200 hover:bg-slate-100 active:bg-slate-200 transition flex items-center justify-center text-slate-600">
                    <i class="fas fa-sync-alt text-xs" id="refresh-icon"></i>
                </button>
                <button onclick="handleLogout()" class="p-2 w-9 h-9 rounded-full bg-red-50 border border-red-100 hover:bg-red-100 text-red-600 active:bg-red-200 transition flex items-center justify-center">
                    <i class="fas fa-power-off text-xs"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative p-4 pb-32 w-full max-w-md mx-auto" id="main-container">
            
            <!-- Dashboard View -->
            <div id="view-dashboard">
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <!-- Balance Card -->
                    <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 rounded-[1.5rem] p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition-transform duration-700">
                            <i class="fas fa-wallet text-9xl"></i>
                        </div>
                        <div class="relative z-10">
                            <p class="text-indigo-200 text-xs font-medium mb-1 tracking-wide uppercase">Saldo Total</p>
                            <h2 class="text-3xl font-bold tracking-tight" id="total-balance">Rp 0</h2>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-100">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-7 h-7 rounded-full bg-green-100 flex items-center justify-center text-green-600 shrink-0">
                                    <i class="fas fa-arrow-down text-[10px]"></i>
                                </div>
                                <span class="text-xs text-slate-500 font-medium truncate">Masuk</span>
                            </div>
                            <p class="text-base font-bold text-slate-800 truncate" id="total-income">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-100">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-7 h-7 rounded-full bg-red-100 flex items-center justify-center text-red-600 shrink-0">
                                    <i class="fas fa-arrow-up text-[10px]"></i>
                                </div>
                                <span class="text-xs text-slate-500 font-medium truncate">Keluar</span>
                            </div>
                            <p class="text-base font-bold text-slate-800 truncate" id="total-expense">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- Search & Filter & Edit Toggle -->
                <div class="mb-4 sticky top-0 pt-2 pb-2 bg-slate-50/95 backdrop-blur z-20 space-y-3">
                    <div class="flex gap-2 items-center">
                        <div class="relative flex-1 group">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs group-focus-within:text-primary transition-colors"></i>
                            <input type="text" id="search-input" onkeyup="renderHistory()" placeholder="Cari transaksi..." class="w-full bg-white border border-slate-200 rounded-full pl-9 pr-4 py-2.5 text-xs outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 shadow-sm transition-all">
                        </div>
                        <div class="relative">
                            <select id="month-filter" onchange="renderHistory()" class="appearance-none bg-white border border-slate-200 text-slate-600 text-xs font-medium rounded-full pl-4 pr-8 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 shadow-sm h-full max-w-[110px] truncate transition-all">
                                <!-- Populated by JS -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <i class="fas fa-chevron-down text-[10px]"></i>
                            </div>
                        </div>
                        <!-- Toggle Edit Mode Button -->
                        <button onclick="toggleEditMode()" id="edit-mode-btn" class="bg-white border border-slate-200 text-slate-500 w-10 h-10 rounded-full shadow-sm hover:bg-slate-50 hover:text-slate-800 active:bg-slate-100 transition flex items-center justify-center shrink-0">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                    </div>
                    <!-- Select All Helper (Hidden by default) -->
                    <div id="edit-helper" class="hidden flex justify-between items-center px-2 text-[10px] text-slate-500 animate-fade-in font-medium">
                        <span>Pilih item untuk dihapus</span>
                        <button onclick="toggleSelectAll()" class="text-primary hover:text-primaryDark transition-colors">Pilih Semua</button>
                    </div>
                </div>

                <div id="transaction-list" class="space-y-3 pb-safe">
                    <div class="text-center py-10 text-slate-300">
                        <div class="loader border-slate-300 border-t-primary mx-auto mb-3"></div>
                        <p class="text-xs">Menyiapkan data...</p>
                    </div>
                </div>
            </div>

            <!-- Report View -->
            <div id="view-report" class="hidden pb-safe space-y-5">
                <div class="bg-white p-5 rounded-[1.5rem] shadow-soft border border-slate-100">
                    <h3 class="font-bold text-slate-800 mb-4 text-sm">Analisis Bulan Ini</h3>
                    <div class="h-56 relative">
                        <canvas id="chart-pie"></canvas>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-[1.5rem] shadow-soft border border-slate-100">
                    <h3 class="font-bold text-slate-800 mb-4 text-sm">Tren Harian</h3>
                    <div class="h-48 relative">
                        <canvas id="chart-bar"></canvas>
                    </div>
                </div>
            </div>

        </main>

        <!-- FAB (Main Add Button) -->
        <button id="main-fab" onclick="openModal()" class="fixed bottom-[calc(5.5rem+env(safe-area-inset-bottom,20px))] right-5 bg-slate-900 text-white w-14 h-14 rounded-full shadow-2xl shadow-slate-900/30 flex items-center justify-center text-xl active:scale-90 transition-all duration-300 z-30 touch-manipulation hover:rotate-90">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Navigation -->
        <nav class="glass border-t border-slate-200 fixed bottom-0 w-full z-40 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
            <div class="flex justify-around items-center h-16 max-w-md mx-auto px-1">
                <button onclick="switchTab('home')" class="nav-btn active flex-1 flex flex-col items-center justify-center h-full gap-1 text-primary transition active:scale-95" data-target="home">
                    <i class="fas fa-home text-lg"></i>
                    <span class="text-[9px] sm:text-[10px] font-semibold">Beranda</span>
                </button>
                <button onclick="switchTab('hutang')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-slate-400 hover:text-slate-600 transition active:scale-95" data-target="hutang">
                    <i class="fas fa-hand-holding-usd text-lg"></i>
                    <span class="text-[9px] sm:text-[10px] font-semibold">Hutang</span>
                </button>
                <!-- Tombol Piutang Baru -->
                <button onclick="switchTab('piutang')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-slate-400 hover:text-slate-600 transition active:scale-95" data-target="piutang">
                    <i class="fas fa-money-bill-transfer text-lg"></i>
                    <span class="text-[9px] sm:text-[10px] font-semibold">Piutang</span>
                </button>
                <button onclick="switchTab('laporan')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-slate-400 hover:text-slate-600 transition active:scale-95" data-target="laporan">
                    <i class="fas fa-chart-pie text-lg"></i>
                    <span class="text-[9px] sm:text-[10px] font-semibold">Laporan</span>
                </button>
            </div>
        </nav>
    </section>

    <!-- Modal Input -->
    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 transform transition-transform duration-300 translate-y-full sm:translate-y-0 shadow-2xl flex flex-col max-h-[90dvh]" id="modal-content">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h3 class="text-lg font-bold text-slate-900">Catat Transaksi</h3>
                <button onclick="closeModal()" class="p-2 -mr-2 text-slate-400 hover:text-slate-600 active:text-slate-900 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="transaction-form" onsubmit="submitForm(event)" class="overflow-y-auto no-scrollbar pb-safe">
                <div class="space-y-6">
                    <!-- Type Selector (Modified) -->
                    <div class="grid grid-cols-5 gap-1.5 bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                        <label class="cursor-pointer touch-manipulation">
                            <input type="radio" name="tipe" value="Masuk" class="peer hidden" checked>
                            <div class="peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm peer-checked:ring-1 peer-checked:ring-black/5 py-2.5 text-center rounded-lg text-[9px] sm:text-[10px] font-bold text-slate-400 transition-all">Masuk</div>
                        </label>
                        <label class="cursor-pointer touch-manipulation">
                            <input type="radio" name="tipe" value="Keluar" class="peer hidden">
                            <div class="peer-checked:bg-white peer-checked:text-red-600 peer-checked:shadow-sm peer-checked:ring-1 peer-checked:ring-black/5 py-2.5 text-center rounded-lg text-[9px] sm:text-[10px] font-bold text-slate-400 transition-all">Keluar</div>
                        </label>
                        <label class="cursor-pointer touch-manipulation">
                            <input type="radio" name="tipe" value="Hutang" class="peer hidden">
                            <div class="peer-checked:bg-white peer-checked:text-orange-600 peer-checked:shadow-sm peer-checked:ring-1 peer-checked:ring-black/5 py-2.5 text-center rounded-lg text-[9px] sm:text-[10px] font-bold text-slate-400 transition-all">Hutang</div>
                        </label>
                        <label class="cursor-pointer touch-manipulation">
                            <input type="radio" name="tipe" value="Piutang" class="peer hidden">
                            <div class="peer-checked:bg-white peer-checked:text-cyan-600 peer-checked:shadow-sm peer-checked:ring-1 peer-checked:ring-black/5 py-2.5 text-center rounded-lg text-[9px] sm:text-[10px] font-bold text-slate-400 transition-all">Piutang</div>
                        </label>
                        <label class="cursor-pointer touch-manipulation">
                            <input type="radio" name="tipe" value="Lainnya" class="peer hidden">
                            <div class="peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm peer-checked:ring-1 peer-checked:ring-black/5 py-2.5 text-center rounded-lg text-[9px] sm:text-[10px] font-bold text-slate-400 transition-all">Lainnya</div>
                        </label>
                    </div>

                    <!-- Amount Input -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-2 ml-1">Jumlah Nominal</label>
                        <div class="relative">
                            <span class="absolute left-0 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">Rp</span>
                            <input type="tel" inputmode="numeric" name="jumlah" required class="w-full text-3xl font-bold text-slate-800 border-b border-slate-200 focus:border-primary outline-none py-2 pl-8 placeholder-slate-200 transition bg-transparent" placeholder="0">
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="space-y-4">
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-500 ml-1">Tanggal</label>
                            <input type="date" name="tanggal" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/10 transition text-slate-700 font-medium">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-500 ml-1">Keterangan</label>
                            <input type="text" name="keterangan" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/10 transition text-slate-700 font-medium" placeholder="Contoh: Makan Siang / Dipinjam Budi">
                        </div>
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl mt-8 shadow-lg shadow-slate-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2 touch-manipulation mb-2">
                    <span>Simpan</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkVDFQGadQlKCE79pAv9pNu_ROuzNOu8AV1k0tvqvEzGI7xibMSHtIPo9KK9ePrrDv/exec"; 
        // =================================================

        let rawData = [];
        let pieChart = null;
        let barChart = null;
        
        let isEditMode = false;
        let selectedIds = new Set();

        // --- Auth Logic ---
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('dompetku_auth');
            if (isLoggedIn) {
                showApp();
            } else {
                showLogin();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            if (email && pass) {
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="loader"></div>';
                setTimeout(() => {
                    localStorage.setItem('dompetku_auth', 'true');
                    showApp();
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 800);
            }
        }

        function handleLogout() {
            if(confirm('Keluar dari aplikasi?')) {
                localStorage.removeItem('dompetku_auth');
                showLogin();
            }
        }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            initApp();
        }

        function showLogin() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('hidden');
        }

        function togglePassword() {
            const input = document.getElementById('password');
            const icon = document.getElementById('eye-icon');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // --- App Logic ---

        function initApp() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="tanggal"]').value = today;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
            
            const cachedData = localStorage.getItem('dompetku_data');
            if (cachedData) {
                rawData = JSON.parse(cachedData);
                populateMonthFilter();
                renderHistory();
            }
            fetchData();
        }

        async function fetchData(manual = false) {
            const icon = document.getElementById('refresh-icon');
            if(icon) icon.classList.add('fa-spin');
            
            try {
                if (!WEB_APP_URL && rawData.length > 0 && !manual) return;
                const response = await fetch(`${WEB_APP_URL}?action=read`);
                const result = await response.json();
                if (result.status === 'success') {
                    rawData = result.data;
                    localStorage.setItem('dompetku_data', JSON.stringify(rawData));
                    document.getElementById('offline-indicator').classList.add('hidden');
                    populateMonthFilter();
                    renderHistory();
                    if(manual) showToast('Data diperbarui', 'success');
                } else {
                    if(manual) showToast('Gagal memuat data', 'error');
                }
            } catch (error) {
                console.error(error);
                if (rawData.length > 0) {
                    const ind = document.getElementById('offline-indicator');
                    if(ind) ind.classList.remove('hidden');
                }
            } finally {
                if(icon) icon.classList.remove('fa-spin');
            }
        }

        // --- Transaksi Logic ---

        async function submitForm(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loader border-slate-400 border-t-white"></div>';

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Set status default untuk Hutang dan Piutang
            if (data.tipe === 'Hutang' || data.tipe === 'Piutang') {
                data.status = 'Belum Lunas';
            } else {
                data.status = '-';
            }

            try {
                const response = await fetch(`${WEB_APP_URL}?action=create`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Tersimpan', 'success');
                    closeModal();
                    e.target.reset();
                    document.querySelector('input[name="tanggal"]').value = new Date().toISOString().split('T')[0];
                    fetchData(true); 
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function markAsPaid(id) {
            if(!confirm("Tandai sebagai lunas?")) return;
            const card = document.getElementById(`card-${id}`);
            if(card) card.style.opacity = '0.5';

            try {
                const response = await fetch(`${WEB_APP_URL}?action=updateStatus`, {
                    method: 'POST',
                    body: JSON.stringify({ id: id, status: 'Lunas' })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('Lunas!', 'success');
                    fetchData(true);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showToast('Gagal update', 'error');
                if(card) card.style.opacity = '1';
            }
        }

        // --- DELETE LOGIC ---

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            const fab = document.getElementById('main-fab');
            const helper = document.getElementById('edit-helper');
            
            if (isEditMode) {
                btn.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                btn.innerHTML = '<i class="fas fa-times"></i>';
                fab.classList.add('scale-0'); 
                helper.classList.remove('hidden');
            } else {
                btn.classList.remove('bg-red-50', 'text-red-600', 'border-red-200');
                btn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
                fab.classList.remove('scale-0'); 
                helper.classList.add('hidden');
                selectedIds.clear();
                updateDeleteBar();
            }
            renderHistory();
        }

        function toggleSelection(id) {
            if (!isEditMode) return;
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            renderHistory(); 
            updateDeleteBar();
        }

        function toggleSelectAll() {
            const visibleIds = getVisibleIds();
            const allSelected = visibleIds.every(id => selectedIds.has(id));
            if (allSelected) {
                visibleIds.forEach(id => selectedIds.delete(id));
            } else {
                visibleIds.forEach(id => selectedIds.add(id));
            }
            renderHistory();
            updateDeleteBar();
        }

        function getVisibleIds() {
            const filterValue = document.getElementById('month-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            let filteredData = rawData;
            if (filterValue) filteredData = filteredData.filter(item => item.tanggal.startsWith(filterValue));
            if (searchTerm) filteredData = filteredData.filter(item => item.keterangan.toLowerCase().includes(searchTerm) || item.jumlah.toString().includes(searchTerm));
            return filteredData.map(item => item.id);
        }

        function updateDeleteBar() {
            const bar = document.getElementById('delete-bar');
            const count = document.getElementById('selected-count');
            count.innerText = selectedIds.size;
            if (selectedIds.size > 0) {
                bar.classList.remove('translate-y-32');
            } else {
                bar.classList.add('translate-y-32');
            }
        }

        async function deleteSelectedItems() {
            if (selectedIds.size === 0) return;
            if (!confirm(`Yakin ingin menghapus ${selectedIds.size} item ini?`)) return;

            const idsToDelete = Array.from(selectedIds);
            const originalData = [...rawData]; 
            
            // Optimistic Update
            rawData = rawData.filter(item => !selectedIds.has(item.id));
            localStorage.setItem('dompetku_data', JSON.stringify(rawData));
            
            toggleEditMode(); 
            showToast('Menghapus...', 'success');

            try {
                const response = await fetch(`${WEB_APP_URL}?action=delete`, {
                    method: 'POST',
                    body: JSON.stringify({ ids: idsToDelete })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    console.log('Sync delete success');
                } else {
                    throw new Error(result.message || 'Gagal menghapus di server');
                }
            } catch (error) {
                console.error("Delete failed", error);
                rawData = originalData;
                localStorage.setItem('dompetku_data', JSON.stringify(rawData));
                renderHistory(); 
                showToast('Gagal! Data dikembalikan.', 'error');
            }
        }

        // --- Render UI ---

        function populateMonthFilter() {
            const select = document.getElementById('month-filter');
            const currentVal = select.value;
            const uniqueMonths = [...new Set(rawData.map(item => {
                const d = new Date(item.tanggal);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();

            select.innerHTML = uniqueMonths.map(m => {
                const [y, monthNum] = m.split('-');
                const monthName = new Date(y, monthNum - 1).toLocaleString('id-ID', { month: 'long' });
                return `<option value="${m}">${monthName} ${y}</option>`;
            }).join('');
            
            if (uniqueMonths.length === 0) select.innerHTML = `<option value="">Bulan Ini</option>`;
            if (currentVal && uniqueMonths.includes(currentVal)) select.value = currentVal;
            else if (uniqueMonths.length > 0) select.value = uniqueMonths[0];
        }

        function renderHistory() {
            const filterValue = document.getElementById('month-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('transaction-list');
            
            let filteredData = rawData;
            if (filterValue) filteredData = filteredData.filter(item => item.tanggal.startsWith(filterValue));
            if (searchTerm) filteredData = filteredData.filter(item => item.keterangan.toLowerCase().includes(searchTerm) || item.jumlah.toString().includes(searchTerm));

            // Calc totals
            let income = 0, expense = 0;
            filteredData.forEach(item => {
                const val = parseInt(item.jumlah);
                if (item.tipe === 'Masuk' || item.tipe === 'Lainnya') income += val;
                // Piutang dianggap pengeluaran (uang keluar) dalam perhitungan saldo dompet saat ini
                if (item.tipe === 'Keluar' || item.tipe === 'Hutang' || item.tipe === 'Piutang') expense += val;
            });

            document.getElementById('total-income').textContent = formatRupiah(income);
            document.getElementById('total-expense').textContent = formatRupiah(expense);
            document.getElementById('total-balance').textContent = formatRupiah(income - expense);

            // Handle Tab Switching
            const activeTab = document.querySelector('.nav-btn.active').dataset.target;
            if (activeTab === 'hutang') {
                renderDebtList(rawData, searchTerm, 'Hutang');
                return;
            } else if (activeTab === 'piutang') {
                renderReceivableList(rawData, searchTerm);
                return;
            } else if (activeTab === 'laporan') {
                renderReports(filteredData);
                return;
            }

            if (filteredData.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-slate-300"><i class="fas fa-receipt text-3xl mb-3 opacity-20"></i><p class="text-xs">Belum ada transaksi</p></div>`;
                return;
            }

            container.innerHTML = filteredData.map(item => {
                const isExpense = ['Keluar', 'Hutang', 'Piutang'].includes(item.tipe);
                const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                
                // Color Logic
                let iconBg = 'bg-slate-50 text-slate-600';
                if(item.tipe === 'Masuk') iconBg = 'bg-green-50 text-green-600';
                if(item.tipe === 'Keluar') iconBg = 'bg-red-50 text-red-600';
                if(item.tipe === 'Hutang') iconBg = 'bg-orange-50 text-orange-600';
                if(item.tipe === 'Piutang') iconBg = 'bg-cyan-50 text-cyan-600';
                
                const isSelected = selectedIds.has(item.id);
                const selectStyle = isSelected ? 'bg-red-50 border-red-200' : 'bg-white border-slate-100';
                
                let leftContent = ``;
                if (isEditMode) {
                    leftContent = `
                    <div class="pr-3 pointer-events-none">
                        <input type="checkbox" id="check-${item.id}" class="custom-checkbox text-red-500" ${isSelected ? 'checked' : ''}>
                    </div>
                    `;
                }

                return `
                <div id="container-${item.id}" onclick="isEditMode ? toggleSelection('${item.id}') : null" class="${selectStyle} p-4 rounded-xl shadow-soft border flex items-center justify-between active:scale-[0.99] transition-all duration-200 select-none cursor-pointer">
                    <div class="flex items-center gap-3 overflow-hidden">
                        ${leftContent}
                        <div class="w-10 h-10 rounded-full ${iconBg} flex items-center justify-center shrink-0 transition-transform ${isEditMode ? 'scale-90' : ''}">
                            <i class="${getIcon(item.tipe)} text-sm"></i>
                        </div>
                        <div class="min-w-0">
                            <p class="font-bold text-slate-800 text-sm truncate">${item.keterangan}</p>
                            <p class="text-[10px] text-slate-400 font-medium mt-0.5">${new Date(item.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })} • ${item.tipe}</p>
                        </div>
                    </div>
                    <div class="text-right shrink-0 ml-2">
                        <p class="font-bold ${colorClass} text-sm">${isExpense ? '-' : '+'} ${formatRupiah(item.jumlah)}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // Render List Hutang (Updated with Summary)
        function renderDebtList(data, search, type) {
            const container = document.getElementById('transaction-list');
            let debts = data.filter(item => item.tipe === type);
            if(search) debts = debts.filter(item => item.keterangan.toLowerCase().includes(search));

            // Hitung Total Hutang
            const totalHutang = debts.reduce((acc, curr) => acc + parseInt(curr.jumlah), 0);
            const totalBelumLunas = debts.filter(p => p.status !== 'Lunas').reduce((acc, curr) => acc + parseInt(curr.jumlah), 0);
            const totalSudahLunas = totalHutang - totalBelumLunas;

            let html = `
            <!-- Summary Card for Hutang -->
            <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl p-4 text-white shadow-lg shadow-orange-200 mb-4">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <p class="text-[10px] text-orange-100 font-medium">Total Hutang</p>
                        <h2 class="text-xl font-bold">${formatRupiah(totalHutang)}</h2>
                    </div>
                    <div class="text-right">
                         <p class="text-[10px] text-orange-100 font-medium">Sisa Tagihan</p>
                         <p class="font-bold text-white">${formatRupiah(totalBelumLunas)}</p>
                    </div>
                </div>
                <div class="w-full bg-black/20 h-1.5 rounded-full overflow-hidden mt-1">
                    <div class="bg-white h-full" style="width: ${totalHutang > 0 ? (totalSudahLunas/totalHutang)*100 : 0}%"></div>
                </div>
                <p class="text-[9px] text-orange-50 mt-1 text-right">${totalHutang > 0 ? Math.round((totalSudahLunas/totalHutang)*100) : 0}% Lunas</p>
            </div>
            `;

            if (debts.length === 0) {
                html += `<div class="text-center py-10 text-slate-400 text-xs">Tidak ada data ${type.toLowerCase()}.</div>`;
                container.innerHTML = html;
                return;
            }

            html += debts.map(item => {
                const isLunas = item.status === 'Lunas';
                return `
                <div id="card-${item.id}" class="bg-white p-4 rounded-xl shadow-soft border border-slate-100 mb-3 relative overflow-hidden active:scale-[0.99] transition-transform">
                    ${isLunas ? '<div class="absolute top-0 right-0 bg-green-500 text-white text-[9px] font-bold px-2 py-1 rounded-bl-lg tracking-wider">LUNAS</div>' : ''}
                    <div class="flex justify-between items-start mb-2">
                        <div class="min-w-0 pr-2"><h4 class="font-bold text-slate-800 truncate text-sm">${item.keterangan}</h4><p class="text-[10px] text-slate-500 mt-0.5">${new Date(item.tanggal).toLocaleDateString('id-ID')}</p></div>
                        <p class="font-bold text-red-600 shrink-0 text-sm">${formatRupiah(item.jumlah)}</p>
                    </div>
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-50">
                        <span class="text-[10px] font-bold px-2 py-1 rounded ${isLunas ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">${item.status}</span>
                        ${!isLunas ? `<button onclick="markAsPaid('${item.id}')" class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-100 active:scale-95 transition">Lunasi</button>` : ''}
                    </div>
                </div>`;
            }).join('');
            
            container.innerHTML = html;
        }

        // NEW: Render List Piutang (Pengeluaran Piutang Detail)
        function renderReceivableList(data, search) {
            const container = document.getElementById('transaction-list');
            
            // Filter Data Piutang
            let piutangs = data.filter(item => item.tipe === 'Piutang');
            if(search) piutangs = piutangs.filter(item => item.keterangan.toLowerCase().includes(search));

            // Hitung Detail Pengeluaran Piutang
            const totalPiutang = piutangs.reduce((acc, curr) => acc + parseInt(curr.jumlah), 0);
            const totalBelumLunas = piutangs.filter(p => p.status !== 'Lunas').reduce((acc, curr) => acc + parseInt(curr.jumlah), 0);
            const totalSudahLunas = totalPiutang - totalBelumLunas;

            let html = `
            <!-- Summary Card for Piutang -->
            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 rounded-2xl p-4 text-white shadow-lg shadow-cyan-200 mb-4">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <p class="text-[10px] text-cyan-100 font-medium">Total Dipinjamkan</p>
                        <h2 class="text-xl font-bold">${formatRupiah(totalPiutang)}</h2>
                    </div>
                    <div class="text-right">
                         <p class="text-[10px] text-cyan-100 font-medium">Belum Dibayar</p>
                         <p class="font-bold text-yellow-300">${formatRupiah(totalBelumLunas)}</p>
                    </div>
                </div>
                <div class="w-full bg-black/20 h-1.5 rounded-full overflow-hidden mt-1">
                    <div class="bg-white h-full" style="width: ${totalPiutang > 0 ? (totalSudahLunas/totalPiutang)*100 : 0}%"></div>
                </div>
                <p class="text-[9px] text-cyan-50 mt-1 text-right">${totalPiutang > 0 ? Math.round((totalSudahLunas/totalPiutang)*100) : 0}% Kembali</p>
            </div>
            `;

            if (piutangs.length === 0) {
                html += `<div class="text-center py-10 text-slate-400 text-xs">Belum ada data piutang.</div>`;
                container.innerHTML = html;
                return;
            }

            html += piutangs.map(item => {
                const isLunas = item.status === 'Lunas';
                return `
                <div id="card-${item.id}" class="bg-white p-4 rounded-xl shadow-soft border border-slate-100 mb-3 relative overflow-hidden active:scale-[0.99] transition-transform">
                    ${isLunas ? '<div class="absolute top-0 right-0 bg-green-500 text-white text-[9px] font-bold px-2 py-1 rounded-bl-lg tracking-wider">LUNAS</div>' : ''}
                    <div class="flex justify-between items-start mb-2">
                        <div class="min-w-0 pr-2">
                            <h4 class="font-bold text-slate-800 truncate text-sm">${item.keterangan}</h4>
                            <p class="text-[10px] text-slate-500 mt-0.5">${new Date(item.tanggal).toLocaleDateString('id-ID')} • Piutang</p>
                        </div>
                        <p class="font-bold text-cyan-600 shrink-0 text-sm">${formatRupiah(item.jumlah)}</p>
                    </div>
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-50">
                        <span class="text-[10px] font-bold px-2 py-1 rounded ${isLunas ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'}">${item.status}</span>
                        ${!isLunas ? `<button onclick="markAsPaid('${item.id}')" class="text-[10px] font-bold bg-cyan-50 text-cyan-600 px-3 py-1.5 rounded-lg hover:bg-cyan-100 active:scale-95 transition">Tandai Lunas</button>` : ''}
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;
        }

        function renderReports(data) {
            if (typeof Chart === 'undefined') return;
            if(pieChart) pieChart.destroy();
            if(barChart) barChart.destroy();

            const ctxPie = document.getElementById('chart-pie').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Masuk', 'Keluar', 'Hutang', 'Piutang'],
                    datasets: [{
                        data: [
                            data.filter(i => i.tipe === 'Masuk' || i.tipe === 'Lainnya').reduce((a, b) => a + parseInt(b.jumlah), 0),
                            data.filter(i => i.tipe === 'Keluar').reduce((a, b) => a + parseInt(b.jumlah), 0),
                            data.filter(i => i.tipe === 'Hutang').reduce((a, b) => a + parseInt(b.jumlah), 0),
                            data.filter(i => i.tipe === 'Piutang').reduce((a, b) => a + parseInt(b.jumlah), 0),
                        ],
                        backgroundColor: ['#10B981', '#EF4444', '#F59E0B', '#06b6d4'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10, family: "'Plus Jakarta Sans', sans-serif"} } } } }
            });

            const dailyData = {};
            data.slice(0, 30).forEach(item => {
                const d = item.tanggal.substring(5);
                if(!dailyData[d]) dailyData[d] = 0;
                dailyData[d] += parseInt(item.jumlah);
            });
            const sortedKeys = Object.keys(dailyData).sort().slice(-7);

            const ctxBar = document.getElementById('chart-bar').getContext('2d');
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: sortedKeys,
                    datasets: [{ label: 'Vol', data: sortedKeys.map(k => dailyData[k]), backgroundColor: '#4338ca', borderRadius: 6, barThickness: 12 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: {size: 9} } } }, plugins: { legend: { display: false } } }
            });
        }

        function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); }
        function getIcon(tipe) {
            switch(tipe) { 
                case 'Masuk': return 'fas fa-wallet'; 
                case 'Keluar': return 'fas fa-shopping-bag'; 
                case 'Hutang': return 'fas fa-file-invoice-dollar'; 
                case 'Piutang': return 'fas fa-money-bill-transfer'; 
                default: return 'fas fa-coins'; 
            }
        }
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-message');
            toast.classList.remove('opacity-0', 'pointer-events-none');
            text.innerText = msg;
            icon.className = type === 'error' ? 'fas fa-exclamation-circle text-red-400' : 'fas fa-check-circle text-green-400';
            setTimeout(() => toast.classList.add('opacity-0', 'pointer-events-none'), 3000);
        }

        // --- UI Interactions ---
        function openModal() {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); }, 10);
        }
        function closeModal() {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            modal.classList.add('opacity-0'); content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        function switchTab(target) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === target) {
                    btn.classList.add('active', 'text-primary'); btn.classList.remove('text-slate-400');
                    btn.querySelector('i').classList.add('text-primary'); btn.querySelector('i').classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('active', 'text-primary'); btn.classList.add('text-slate-400');
                    btn.querySelector('i').classList.remove('text-primary'); btn.querySelector('i').classList.add('text-slate-400');
                }
            });
            document.getElementById('view-dashboard').classList.toggle('hidden', target === 'laporan');
            document.getElementById('view-report').classList.toggle('hidden', target !== 'laporan');
            
            if (isEditMode) toggleEditMode();
            else renderHistory();
        }

        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        
        document.addEventListener('DOMContentLoaded', checkAuth);

    </script>
</body>
</html>
