<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#064e3b"> <!-- Emerald Dark -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dompet Ramadan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=VT323&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas & jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Amiri"', 'serif'],
                        mono: ['"VT323"', 'monospace'],
                    },
                    colors: {
                        primary: '#059669',
                        primaryDark: '#064e3b',
                        gold: '#fbbf24',
                        goldDark: '#d97706',
                        surface: '#f0fdf4',
                    },
                    animation: {
                        'float-slow': 'float 8s ease-in-out infinite',
                        'float-medium': 'float 6s ease-in-out infinite',
                        'twinkle': 'twinkle 4s ease-in-out infinite',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-15px) rotate(2deg)' },
                        },
                        twinkle: {
                            '0%, 100%': { opacity: '0.3', transform: 'scale(1)' },
                            '50%': { opacity: '0.8', transform: 'scale(1.2)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    },
                    backgroundImage: {
                        'islamic-pattern': "url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")",
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: #ecfdf5; 
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }
        
        .card-gradient { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
        .prayer-gradient { background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .lantern-string { width: 2px; background: #d97706; margin: 0 auto; }
        
        .crescent-loader {
            width: 30px; height: 30px; border-radius: 50%;
            box-shadow: inset -4px 0 0 2px #059669;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .paper-tear {
            background-image: radial-gradient(circle at 10px -5px, transparent 12px, white 13px);
            background-size: 20px 20px; background-repeat: repeat-x;
            height: 15px; width: 100%; transform: rotate(180deg);
        }

        .report-table th { background-color: #064e3b; color: white; padding: 8px; font-size: 10px; text-transform: uppercase; }
        .report-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 10px; color: #334155; }
        .report-table tr:last-child td { border-bottom: none; }
        .report-table tr:nth-child(even) { background-color: #f8fafc; }
        
        /* === RAMADAN EQUALIZER ANIMATION === */
        .eq-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            height: 14px;
            width: 18px;
        }
        
        .eq-bar {
            width: 3px;
            background-color: #fbbf24; /* Gold Color */
            border-radius: 2px 2px 0 0;
            animation: eq-bounce 1s ease-in-out infinite;
        }
        
        .eq-bar:nth-child(1) { height: 6px; animation-delay: 0.1s; }
        .eq-bar:nth-child(2) { height: 12px; animation-delay: 0.2s; }
        .eq-bar:nth-child(3) { height: 8px; animation-delay: 0.4s; }
        .eq-bar:nth-child(4) { height: 5px; animation-delay: 0.0s; }

        @keyframes eq-bounce {
            0%, 100% { height: 4px; opacity: 0.7; }
            50% { height: 14px; opacity: 1; background-color: #d97706; }
        }
    </style>
</head>

<body class="text-slate-800 font-sans h-[100dvh] w-full overflow-hidden text-sm sm:text-base relative">

    <!-- Audio Element (Dynamic Source) -->
    <audio id="bg-music"></audio>

    <!-- Background Decorations -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-0 left-[15%] animate-float-slow">
            <div class="lantern-string h-16"></div>
            <div class="text-goldDark text-4xl drop-shadow-lg opacity-80"><i class="fas fa-mosque"></i></div>
        </div>
        <div class="absolute top-0 right-[20%] animate-float-medium" style="animation-delay: 1s">
            <div class="lantern-string h-24"></div>
            <div class="text-gold text-3xl drop-shadow-md opacity-90"><i class="fas fa-star-and-crescent"></i></div>
        </div>
         <div class="absolute top-10 right-[-20px] text-yellow-200/40 text-[150px] animate-twinkle blur-sm z-[-1]">
            <i class="fas fa-moon"></i>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 glass-panel bg-emerald-900/90 text-white px-5 py-3 rounded-full shadow-xl shadow-emerald-900/20 z-[70] transition-all duration-500 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3 w-max border border-emerald-700/50">
        <div class="w-6 h-6 rounded-full bg-gold flex items-center justify-center text-emerald-900 shadow-lg">
            <i id="toast-icon" class="fas fa-check text-[10px]"></i>
        </div>
        <span id="toast-message" class="text-xs font-bold font-sans tracking-wide">Alhamdulillah</span>
    </div>

    <!-- Delete Bar -->
    <div id="delete-bar" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-xl border border-red-100 text-slate-800 px-4 py-2 pr-6 rounded-full shadow-2xl z-[50] transition-all duration-500 translate-y-40 flex items-center gap-4">
        <div class="bg-red-50 text-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xs shadow-inner">
            <span id="selected-count">0</span>
        </div>
        <button id="btn-confirm-delete" onclick="deleteSelectedItems()" class="text-red-500 font-bold text-xs uppercase tracking-wider flex items-center gap-2 active:scale-95 transition">
            <i class="fas fa-trash-alt"></i> Hapus Data
        </button>
    </div>

    <!-- ================== LOGIN VIEW ================== -->
    <section id="login-view" class="h-full w-full flex flex-col items-center justify-center p-6 absolute inset-0 z-50 overflow-hidden bg-gradient-to-b from-emerald-900 to-emerald-800">
        <div class="absolute inset-0 bg-islamic-pattern opacity-10"></div>
        <div class="w-full max-w-[340px] flex flex-col items-center relative z-10 animate-slide-up">
            <div class="w-24 h-24 bg-gradient-to-tr from-emerald-600 to-teal-500 rounded-full flex items-center justify-center shadow-2xl shadow-emerald-900/50 mb-6 border-4 border-emerald-400/20 relative group">
                <div class="absolute inset-0 rounded-full border border-gold/40 animate-spin-slow" style="animation-duration: 10s"></div>
                <i class="fas fa-kaaba text-4xl text-white drop-shadow-md"></i>
            </div>
            <div class="glass-panel w-full p-8 rounded-3xl shadow-2xl relative overflow-hidden bg-white/95 border-0">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-serif font-bold text-emerald-900">Dompet Ramadan</h1>
                    <p class="text-emerald-600/80 text-xs font-medium mt-1 uppercase tracking-widest">Kelola Keuangan Penuh Berkah</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div class="space-y-1.5 group">
                        <label class="text-[10px] font-bold text-emerald-700 uppercase ml-4">Email</label>
                        <div class="relative transition-transform duration-300 group-focus-within:scale-[1.02]">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-emerald-300 group-focus-within:text-emerald-600 transition-colors"></i>
                            </div>
                            <input type="email" id="email" class="w-full pl-10 pr-4 py-3.5 bg-emerald-50/50 border border-emerald-100 rounded-2xl text-emerald-900 placeholder-emerald-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500 transition-all outline-none font-medium text-sm" placeholder="email@contoh.com" required value="admin@uangku.com">
                        </div>
                    </div>
                    <div class="space-y-1.5 group">
                        <label class="text-[10px] font-bold text-emerald-700 uppercase ml-4">Password</label>
                        <div class="relative transition-transform duration-300 group-focus-within:scale-[1.02]">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-key text-emerald-300 group-focus-within:text-emerald-600 transition-colors"></i>
                            </div>
                            <input type="password" id="password" class="w-full pl-10 pr-10 py-3.5 bg-emerald-50/50 border border-emerald-100 rounded-2xl text-emerald-900 placeholder-emerald-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500 transition-all outline-none font-medium text-sm" placeholder="••••••••" required value="123456">
                            <button type="button" onclick="togglePassword()" class="absolute right-0 top-0 bottom-0 px-4 text-emerald-400 hover:text-emerald-700 transition-colors focus:outline-none">
                                <i class="fas fa-eye text-xs" id="eye-icon"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-emerald-700 to-teal-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-700/30 mt-4 relative overflow-hidden group active:scale-[0.98] transition-all">
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                        <span class="relative flex items-center justify-center gap-2">
                            Buka Dompet <i class="fas fa-chevron-right text-xs"></i>
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- ================== APP VIEW ================== -->
    <section id="app-view" class="hidden h-full flex flex-col relative z-10">
        
        <!-- Header -->
        <header class="fixed top-0 w-full z-30 glass-panel border-b-0 border-white/20 pt-safe transition-all duration-300">
            <div class="max-w-md mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 border border-emerald-200 flex items-center justify-center text-emerald-700 shadow-sm relative">
                        <i class="fas fa-moon"></i>
                        <div class="absolute -top-1 -right-1 text-gold text-xs animate-pulse"><i class="fas fa-star"></i></div>
                    </div>
                    <div>
                        <h1 class="text-lg font-serif font-bold text-emerald-900 leading-none">DompetKu</h1>
                        <p class="text-[10px] text-emerald-600 font-medium mt-1 flex items-center gap-1">
                            <i class="far fa-calendar-alt"></i> <span id="current-date">...</span>
                            <span id="offline-indicator" class="hidden w-1.5 h-1.5 bg-red-500 rounded-full animate-ping ml-1"></span>
                        </p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Music Controls Deck -->
                    <div class="flex items-center bg-emerald-50 rounded-full border border-emerald-100 p-0.5 shadow-sm">
                        <button onclick="changeTrack('prev')" class="w-8 h-8 flex items-center justify-center text-emerald-400 hover:text-emerald-600 active:scale-90 transition rounded-full">
                            <i class="fas fa-step-backward text-xs"></i>
                        </button>
                        <button onclick="toggleMusic()" id="play-pause-btn" class="w-9 h-9 flex items-center justify-center bg-white text-emerald-600 shadow-sm rounded-full active:scale-90 transition border border-emerald-50 relative overflow-hidden">
                            <!-- Icon Play/Pause akan dihandle JS -->
                            <i class="fas fa-play text-xs pl-0.5"></i>
                        </button>
                        <button onclick="changeTrack('next')" class="w-8 h-8 flex items-center justify-center text-emerald-400 hover:text-emerald-600 active:scale-90 transition rounded-full">
                            <i class="fas fa-step-forward text-xs"></i>
                        </button>
                        <button onclick="openMusicModal()" class="w-8 h-8 flex items-center justify-center text-emerald-500 hover:text-emerald-700 active:scale-90 transition rounded-full border-l border-emerald-100/50">
                            <i class="fas fa-list-ul text-xs"></i>
                        </button>
                    </div>

                    <!-- System Controls -->
                    <button onclick="fetchData(true)" class="w-9 h-9 rounded-full bg-white border border-emerald-100 flex items-center justify-center text-emerald-600 shadow-sm active:scale-90 hover:bg-emerald-50 transition-all group">
                        <i class="fas fa-sync-alt text-xs group-hover:rotate-180 transition-transform duration-500" id="refresh-icon"></i>
                    </button>
                    <button onclick="handleLogout()" class="w-9 h-9 rounded-full bg-red-50 border border-red-100 flex items-center justify-center text-red-400 active:scale-90 hover:bg-red-100 transition-all">
                        <i class="fas fa-power-off text-xs"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative pt-24 pb-32 w-full max-w-md mx-auto px-5" id="main-container">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="animate-slide-up">
                
                <!-- Prayer Times Card -->
                <div class="relative w-full rounded-[2rem] overflow-hidden shadow-xl shadow-orange-500/20 mb-6 prayer-gradient group">
                    <div class="absolute inset-0 bg-islamic-pattern opacity-10 mix-blend-overlay"></div>
                    <div class="relative z-10 p-5 text-white">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-xs opacity-70"></i>
                                <span class="text-xs font-bold uppercase tracking-wide" id="location-name">Jakarta</span>
                            </div>
                            <div class="text-[10px] font-medium bg-white/20 px-2 py-1 rounded-lg backdrop-blur-sm">
                                <span id="hijri-date">...</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <p class="text-[10px] opacity-80 uppercase tracking-widest mb-1">Menuju <span id="next-prayer-name">...</span></p>
                                <h2 class="text-3xl font-mono font-bold tracking-tight" id="countdown-timer">--:--:--</h2>
                            </div>
                            <div class="text-right">
                                <i class="fas fa-kaaba text-4xl opacity-20 absolute right-4 bottom-4"></i>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-black/10 rounded-xl p-2 flex justify-between items-center border border-white/10">
                                <span class="text-[10px] font-bold"><i class="fas fa-cloud-moon mr-1"></i> Imsak</span>
                                <span class="text-sm font-mono font-bold" id="time-imsak">--:--</span>
                            </div>
                            <div class="bg-black/10 rounded-xl p-2 flex justify-between items-center border border-white/10">
                                <span class="text-[10px] font-bold"><i class="fas fa-utensils mr-1"></i> Maghrib</span>
                                <span class="text-sm font-mono font-bold" id="time-maghrib">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Balance Card -->
                <div class="relative w-full h-48 rounded-[2rem] overflow-hidden shadow-2xl shadow-emerald-700/20 mb-6 group transform transition hover:scale-[1.01] duration-500 card-gradient">
                    <div class="absolute inset-0 bg-islamic-pattern opacity-10 mix-blend-overlay"></div>
                    <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-gold/20 rounded-full blur-2xl"></div>
                    <div class="relative z-10 p-6 h-full flex flex-col justify-between text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-emerald-100/80 text-[10px] font-bold uppercase tracking-widest mb-1 font-sans">Total Saldo Bersih</p>
                                <h2 class="text-3xl font-serif font-bold tracking-wide text-white drop-shadow-sm" id="total-balance">Rp 0</h2>
                            </div>
                            <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/10">
                                <i class="fas fa-wallet text-gold"></i>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-2">
                            <div class="flex-1 bg-emerald-900/30 backdrop-blur-md rounded-xl p-3 border border-emerald-400/20">
                                <div class="flex items-center gap-1.5 mb-1">
                                    <div class="w-1 h-3 bg-emerald-400 rounded-full"></div>
                                    <span class="text-[10px] text-emerald-100 font-medium">Pemasukan</span>
                                </div>
                                <p class="font-bold text-sm truncate text-emerald-50" id="total-income">Rp 0</p>
                            </div>
                            <div class="flex-1 bg-emerald-900/30 backdrop-blur-md rounded-xl p-3 border border-emerald-400/20">
                                <div class="flex items-center gap-1.5 mb-1">
                                    <div class="w-1 h-3 bg-red-400 rounded-full"></div>
                                    <span class="text-[10px] text-emerald-100 font-medium">Pengeluaran</span>
                                </div>
                                <p class="font-bold text-sm truncate text-red-50" id="total-expense">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools Bar -->
                <div class="sticky top-[80px] z-20 py-2 -mx-5 px-5 glass-panel border-x-0 backdrop-blur-xl mb-4 transition-all duration-300">
                    <div class="flex gap-2 items-center">
                        <div class="relative flex-1 group">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-emerald-400 text-xs group-focus-within:text-emerald-600 transition-colors"></i>
                            <input type="text" id="search-input" onkeyup="renderHistory()" placeholder="Cari sedekah, belanja..." class="w-full bg-white border border-emerald-100 rounded-full pl-10 pr-4 py-2.5 text-xs font-medium shadow-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all placeholder-emerald-300/70 text-emerald-800">
                        </div>
                         <!-- Struk Button -->
                         <button onclick="openReceiptModal()" class="w-9 h-9 rounded-full bg-emerald-50 border border-emerald-100 shadow-sm flex items-center justify-center text-emerald-600 hover:text-emerald-800 hover:bg-emerald-100 active:scale-90 transition-all shrink-0">
                            <i class="fas fa-receipt text-xs"></i>
                        </button>
                        <div class="relative shrink-0">
                            <select id="month-filter" onchange="renderHistory()" class="appearance-none bg-emerald-50 text-emerald-800 text-xs font-bold rounded-full pl-4 pr-8 py-2.5 border border-emerald-100 shadow-sm focus:ring-2 focus:ring-emerald-500 h-full w-[100px] truncate">
                                <!-- JS -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-emerald-500">
                                <i class="fas fa-chevron-down text-[10px]"></i>
                            </div>
                        </div>
                        <button onclick="toggleEditMode()" id="edit-mode-btn" class="w-9 h-9 rounded-full bg-white border border-emerald-100 shadow-sm flex items-center justify-center text-emerald-500 hover:text-emerald-700 active:scale-90 transition-all shrink-0">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                    </div>
                    <!-- Select All Helper -->
                    <div id="edit-helper" class="hidden flex justify-between items-center mt-2 px-1 text-[10px] text-emerald-600 animate-fade-in font-bold">
                        <span>Pilih item untuk dihapus</span>
                        <button onclick="toggleSelectAll()" class="text-emerald-700 bg-emerald-100 px-3 py-1 rounded-full hover:bg-emerald-200 transition-colors">Pilih Semua</button>
                    </div>
                </div>

                <!-- List Container -->
                <div id="transaction-list" class="space-y-3 pb-safe min-h-[300px]">
                    <div class="flex flex-col items-center justify-center py-20 opacity-60">
                        <div class="crescent-loader mb-4"></div>
                        <p class="text-xs font-medium text-emerald-700">Menyiapkan catatan...</p>
                    </div>
                </div>
            </div>

            <!-- Report View -->
            <div id="view-report" class="hidden pb-safe space-y-6 animate-slide-up">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-serif font-bold text-emerald-900 text-lg">Ringkasan Laporan</h3>
                    <button onclick="openFullReportModal()" class="bg-emerald-800 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-800/20 active:scale-95 transition flex items-center gap-2">
                        <i class="fas fa-file-export"></i> Ekspor Laporan
                    </button>
                </div>

                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-emerald-50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-50 rounded-bl-full opacity-50"></div>
                    <h3 class="font-serif font-bold text-emerald-900 mb-6 text-base flex items-center gap-2 relative z-10">
                        <i class="fas fa-chart-pie text-gold"></i> Analisis Bulan Ini
                    </h3>
                    <div class="h-64 relative z-10">
                        <canvas id="chart-pie"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-emerald-50">
                    <h3 class="font-serif font-bold text-emerald-900 mb-6 text-base flex items-center gap-2">
                        <i class="fas fa-chart-line text-gold"></i> Grafik Harian
                    </h3>
                    <div class="h-48 relative">
                        <canvas id="chart-bar"></canvas>
                    </div>
                </div>
            </div>

        </main>

        <!-- Floating Action Button -->
        <div class="fixed bottom-[calc(5rem+env(safe-area-inset-bottom,20px))] right-5 z-40">
            <button id="main-fab" onclick="openModal()" class="group relative w-14 h-14 rounded-2xl bg-gradient-to-br from-gold to-goldDark text-white shadow-xl shadow-gold/40 flex items-center justify-center text-xl overflow-hidden transition-all duration-300 hover:scale-105 active:scale-95 hover:rotate-90 border-2 border-white/20">
                <div class="absolute inset-0 bg-white/30 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <i class="fas fa-plus relative z-10 drop-shadow-sm"></i>
            </button>
        </div>

        <!-- Navigation Bar -->
        <nav class="fixed bottom-0 w-full z-40 pb-safe bg-white/90 backdrop-blur-xl border-t border-emerald-100 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] rounded-t-[2rem]">
            <div class="flex justify-around items-center h-16 max-w-md mx-auto px-2">
                <button onclick="switchTab('home')" class="nav-btn active flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-600 transition group relative" data-target="home">
                    <div class="absolute -top-[1px] w-8 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator"></div>
                    <i class="fas fa-mosque text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[10px] font-bold">Beranda</span>
                </button>
                <button onclick="switchTab('hutang')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="hutang">
                    <div class="absolute -top-[1px] w-8 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator"></div>
                    <i class="fas fa-hand-holding-heart text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[10px] font-bold">Hutang</span>
                </button>
                <button onclick="switchTab('piutang')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="piutang">
                    <div class="absolute -top-[1px] w-8 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator"></div>
                    <i class="fas fa-hands-helping text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[10px] font-bold">Piutang</span>
                </button>
                <button onclick="switchTab('laporan')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="laporan">
                    <div class="absolute -top-[1px] w-8 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator"></div>
                    <i class="fas fa-quran text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[10px] font-bold">Laporan</span>
                </button>
            </div>
        </nav>
    </section>

    <!-- Modal Input Transaction -->
    <div id="modal" class="fixed inset-0 bg-emerald-900/60 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center transition-all duration-300 opacity-0">
        <div id="modal-content" class="bg-surface w-full sm:max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl transform translate-y-full transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) flex flex-col max-h-[90dvh] border-t border-white/50 relative">
            <div class="w-12 h-1 bg-emerald-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h3 class="text-xl font-serif font-bold text-emerald-900">Catat Transaksi</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center hover:bg-emerald-200 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="transaction-form" onsubmit="submitForm(event)" class="overflow-y-auto no-scrollbar pb-safe">
                <div class="space-y-6">
                    <div class="bg-white p-1.5 rounded-2xl flex justify-between overflow-x-auto no-scrollbar gap-1 border border-emerald-100 shadow-sm">
                        <label class="flex-1 cursor-pointer min-w-[70px]">
                            <input type="radio" name="tipe" value="Masuk" class="peer hidden" checked>
                            <div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-emerald-100 peer-checked:text-emerald-700 transition-all duration-300">Masuk</div>
                        </label>
                        <label class="flex-1 cursor-pointer min-w-[70px]">
                            <input type="radio" name="tipe" value="Keluar" class="peer hidden">
                            <div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-red-50 peer-checked:text-red-600 transition-all duration-300">Keluar</div>
                        </label>
                        <label class="flex-1 cursor-pointer min-w-[70px]">
                            <input type="radio" name="tipe" value="Hutang" class="peer hidden">
                            <div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-orange-50 peer-checked:text-orange-600 transition-all duration-300">Hutang</div>
                        </label>
                        <label class="flex-1 cursor-pointer min-w-[70px]">
                            <input type="radio" name="tipe" value="Piutang" class="peer hidden">
                            <div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-teal-50 peer-checked:text-teal-600 transition-all duration-300">Piutang</div>
                        </label>
                    </div>
                    <div class="py-2 text-center relative">
                        <label class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1 block">Jumlah (Rp)</label>
                        <input type="tel" inputmode="numeric" name="jumlah" required class="w-full text-4xl font-serif font-bold text-emerald-900 text-center bg-transparent border-none outline-none placeholder-emerald-200 focus:placeholder-emerald-100 transition-all" placeholder="0">
                        <i class="fas fa-pen text-xs text-emerald-200 absolute right-4 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <div class="space-y-3">
                        <div class="bg-white p-3 rounded-2xl border border-emerald-100 focus-within:border-emerald-400 focus-within:ring-2 focus-within:ring-emerald-500/20 transition-all">
                            <label class="block text-[10px] font-bold text-emerald-400 mb-1">Tanggal</label>
                            <input type="date" name="tanggal" required class="w-full bg-transparent border-none p-0 text-sm font-semibold text-slate-700 outline-none">
                        </div>
                        <div class="bg-white p-3 rounded-2xl border border-emerald-100 focus-within:border-emerald-400 focus-within:ring-2 focus-within:ring-emerald-500/20 transition-all">
                            <label class="block text-[10px] font-bold text-emerald-400 mb-1">Keterangan</label>
                            <input type="text" name="keterangan" required class="w-full bg-transparent border-none p-0 text-sm font-semibold text-slate-700 outline-none placeholder-slate-300" placeholder="Zakat, Iftar, Bensin...">
                        </div>
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-emerald-800 text-white font-bold py-4 rounded-2xl mt-8 shadow-xl shadow-emerald-900/10 active:scale-[0.98] transition-all flex justify-center items-center gap-2 overflow-hidden relative group">
                    <span class="relative z-10 flex items-center gap-2">Bismillah, Simpan <i class="fas fa-check-circle"></i></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Receipt Generator -->
    <div id="modal-receipt" class="fixed inset-0 bg-emerald-900/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="receipt-content" class="bg-surface w-full max-w-lg rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-emerald-100 flex justify-between items-center bg-white">
                <h3 class="font-serif font-bold text-emerald-900 text-lg flex items-center gap-2"><i class="fas fa-receipt text-gold"></i> Buat Struk</h3>
                <button onclick="closeReceiptModal()" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar p-5 space-y-6">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                         <div class="bg-white p-3 rounded-xl border border-emerald-100">
                            <label class="text-[10px] font-bold text-emerald-400 block mb-1">Nama Toko</label>
                            <input type="text" id="receipt-store" value="Dompet Ramadan" class="w-full text-sm font-bold text-emerald-900 outline-none" oninput="updateReceiptPreview()">
                        </div>
                        <div class="bg-white p-3 rounded-xl border border-emerald-100">
                            <label class="text-[10px] font-bold text-emerald-400 block mb-1">Tanggal</label>
                            <input type="date" id="receipt-date" class="w-full text-sm font-bold text-emerald-900 outline-none" onchange="updateReceiptPreview()">
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-emerald-100">
                        <div class="flex justify-between items-center mb-2">
                             <label class="text-[10px] font-bold text-emerald-400">Daftar Barang</label>
                             <button onclick="addReceiptItem()" class="text-xs text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded hover:bg-emerald-100 transition">+ Tambah</button>
                        </div>
                        <div id="receipt-items-container" class="space-y-2"></div>
                    </div>
                </div>
                <div class="border-t-2 border-dashed border-emerald-200 pt-4">
                     <p class="text-center text-xs text-emerald-400 font-bold mb-2 uppercase tracking-widest">Preview Struk</p>
                     <div id="receipt-preview-container" class="bg-white p-6 shadow-sm mx-auto w-full max-w-[320px] font-mono text-sm text-slate-800 leading-tight relative">
                        <div class="absolute -top-[14px] left-0 w-full h-[15px] bg-white paper-tear" style="transform: rotate(180deg);"></div>
                        <div class="text-center mb-4">
                            <h2 class="font-bold text-xl uppercase tracking-widest" id="preview-store">DOMPET RAMADAN</h2>
                            <p class="text-[10px] text-slate-500 mt-1" id="preview-date">...</p>
                        </div>
                        <div class="border-b border-dashed border-slate-300 mb-2"></div>
                        <div id="preview-items" class="space-y-1 mb-2"></div>
                        <div class="border-b border-dashed border-slate-300 mb-2"></div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>TOTAL</span>
                            <span id="preview-total">Rp 0</span>
                        </div>
                        <div class="text-center mt-6 text-[10px] text-slate-400">
                            <p>Terima Kasih</p>
                            <p>Barakallah Fikum</p>
                        </div>
                         <div class="absolute -bottom-[14px] left-0 w-full h-[15px] bg-white paper-tear"></div>
                     </div>
                </div>
            </div>
            <div class="p-5 border-t border-emerald-100 bg-emerald-50 flex gap-3">
                 <button onclick="downloadReceiptAsImage()" class="flex-1 bg-emerald-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-900 transition flex items-center justify-center gap-2">
                    <i class="fas fa-image"></i> Simpan Gambar (JPG/PNG)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Full Monthly Report -->
    <div id="modal-full-report" class="fixed inset-0 bg-emerald-900/90 backdrop-blur-md z-[70] hidden flex items-center justify-center p-2 opacity-0 transition-opacity duration-300">
        <div id="report-content-wrapper" class="bg-slate-100 w-full max-w-2xl rounded-3xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="font-serif font-bold text-emerald-900 text-base flex items-center gap-2">
                    <i class="fas fa-file-invoice text-gold"></i> Laporan Bulanan
                </h3>
                <button onclick="closeFullReportModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-slate-200/50 flex justify-center">
                <!-- Report Canvas / Container for A4 Look -->
                <div id="monthly-report-container" class="bg-white shadow-xl p-8 w-full max-w-[595px] min-h-[842px] text-slate-800 relative">
                    <!-- Header Report -->
                    <div class="flex justify-between items-start border-b-2 border-emerald-800 pb-6 mb-6">
                        <div>
                            <h1 class="text-2xl font-serif font-bold text-emerald-900 uppercase tracking-widest">Laporan Keuangan</h1>
                            <p class="text-sm text-emerald-600 font-semibold" id="report-period">Periode: -</p>
                        </div>
                        <div class="text-right">
                            <h2 class="font-bold text-lg text-goldDark">Dompet Ramadan</h2>
                            <p class="text-[10px] text-slate-400">Generated by DompetKu App</p>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        <div class="bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                            <p class="text-[10px] font-bold text-emerald-600 uppercase">Pemasukan</p>
                            <p class="text-sm font-bold text-emerald-800" id="report-income">Rp 0</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <p class="text-[10px] font-bold text-red-600 uppercase">Pengeluaran</p>
                            <p class="text-sm font-bold text-red-800" id="report-expense">Rp 0</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <p class="text-[10px] font-bold text-slate-600 uppercase">Sisa Saldo</p>
                            <p class="text-sm font-bold text-slate-800" id="report-balance">Rp 0</p>
                        </div>
                    </div>

                    <!-- Detail Table -->
                    <div class="mb-8">
                        <h4 class="font-bold text-xs text-emerald-900 mb-2 uppercase border-b border-emerald-200 pb-1">Rincian Transaksi</h4>
                        <table class="w-full text-left report-table">
                            <thead>
                                <tr>
                                    <th class="rounded-l-md">Tanggal</th>
                                    <th>Keterangan</th>
                                    <th>Kategori</th>
                                    <th class="text-right rounded-r-md">Jumlah</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Footer -->
                    <div class="absolute bottom-8 left-8 right-8 text-center border-t border-slate-200 pt-4">
                        <p class="text-[10px] text-slate-400 italic">"Dan apa saja yang kamu infakkan, Allah akan menggantinya..." (QS. Saba: 39)</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 bg-white border-t border-slate-200 shrink-0 grid grid-cols-3 gap-3">
                <button onclick="downloadFullReport('pdf')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex flex-col items-center justify-center gap-1 text-xs">
                    <i class="fas fa-file-pdf text-lg"></i> Simpan PDF
                </button>
                <button onclick="downloadFullReport('jpg')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex flex-col items-center justify-center gap-1 text-xs">
                    <i class="fas fa-file-image text-lg"></i> Simpan JPG
                </button>
                <button onclick="downloadFullReport('png')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex flex-col items-center justify-center gap-1 text-xs">
                    <i class="fas fa-image text-lg"></i> Simpan PNG
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Music Playlist Modal -->
    <div id="modal-music" class="fixed inset-0 bg-emerald-900/80 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="music-content" class="bg-surface w-full max-w-sm rounded-3xl shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300 border border-emerald-100">
            <div class="p-4 border-b border-emerald-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
                         <i class="fas fa-music text-emerald-600 text-xs"></i>
                    </div>
                    <div>
                        <h3 class="font-serif font-bold text-emerald-900 leading-none">Daftar Putar</h3>
                        <p class="text-[10px] text-emerald-500">Pilih latar suara</p>
                    </div>
                </div>
                <button onclick="closeMusicModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-4 bg-emerald-50/50 space-y-2 max-h-[60vh] overflow-y-auto" id="playlist-container">
                <!-- Playlist items injected here -->
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkVDFQGadQlKCE79pAv9pNu_ROuzNOu8AV1k0tvqvEzGI7xibMSHtIPo9KK9ePrrDv/exec"; 
        // =================================================

        let rawData = [];
        let pieChart = null;
        let barChart = null;
        let isEditMode = false;
        let selectedIds = new Set();
        let receiptItems = [{name: 'Item 1', qty: 1, price: 0}]; 
        let prayerInterval;
        
        // --- NEW: Audio Playlist Logic ---
        // GANTI URL DI BAWAH INI DENGAN PATH FILE LOKAL
        // Pastikan file .mp3 sudah ada di folder "audio"
        const playlist = [
            { title: "Nasyid Pilihan", url: "audio/audio1.mp3" },
            { title: "Instrumen Tenang", url: "audio/audio2.mp3" },
            { title: "Latar Ramadan", url: "audio/audio3.mp3" } 
        ];
        
        let currentTrackIndex = 0;
        const audioPlayer = document.getElementById('bg-music');

        // Init Audio
        audioPlayer.src = playlist[0].url;
        audioPlayer.addEventListener('ended', () => changeTrack('next')); // Auto next

        function toggleMusic() {
            if (audioPlayer.paused) {
                audioPlayer.play().then(() => updateMusicUI(true)).catch(e => {
                    console.log(e);
                    showToast('File audio tidak ditemukan!', 'error');
                });
            } else {
                audioPlayer.pause();
                updateMusicUI(false);
            }
        }

        function changeTrack(direction) {
            if (direction === 'next') {
                currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            } else {
                currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            }
            playTrack(currentTrackIndex);
        }

        function playTrack(index) {
            currentTrackIndex = index;
            audioPlayer.src = playlist[index].url;
            audioPlayer.play().then(() => {
                updateMusicUI(true);
                renderPlaylist();
                showToast(`Memutar: ${playlist[index].title}`);
            }).catch(e => {
                console.error("Error playing:", e);
                showToast('File audio tidak ditemukan!', 'error');
            });
        }

        function updateMusicUI(isPlaying) {
            const btn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                // Ramadan-themed Equalizer (Gold bars pulsing)
                btn.innerHTML = `
                    <div class="eq-container">
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                    </div>`;
                btn.classList.add('bg-emerald-100', 'border-emerald-200');
                btn.classList.remove('bg-white');
            } else {
                btn.innerHTML = '<i class="fas fa-play text-xs pl-0.5"></i>';
                btn.classList.remove('bg-emerald-100', 'border-emerald-200');
                btn.classList.add('bg-white');
            }
        }
        
        function openMusicModal() {
            renderPlaylist();
            const modal = document.getElementById('modal-music');
            const content = document.getElementById('music-content');
            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                content.classList.remove('scale-95'); 
                content.classList.add('scale-100');
            }, 50);
        }

        function closeMusicModal() {
            const modal = document.getElementById('modal-music');
            const content = document.getElementById('music-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = playlist.map((song, index) => {
                const isActive = index === currentTrackIndex;
                return `
                <div onclick="playTrack(${index})" class="flex items-center justify-between p-3 rounded-xl border ${isActive ? 'bg-emerald-600 border-emerald-600 text-white shadow-lg shadow-emerald-600/30' : 'bg-white border-emerald-100 text-slate-700 hover:bg-emerald-50'} cursor-pointer transition-all active:scale-95">
                    <div class="flex items-center gap-3">
                        <i class="fas ${isActive ? 'fa-volume-up' : 'fa-music'} ${isActive ? 'text-white' : 'text-emerald-300'} text-xs w-4"></i>
                        <span class="text-xs font-bold truncate max-w-[200px]">${song.title}</span>
                    </div>
                    ${isActive ? '<i class="fas fa-check-circle text-white text-xs"></i>' : ''}
                </div>
                `;
            }).join('');
        }

        // --- Common Animation ---
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if(!obj) return;
            const startNum = 0;
            const endNum = parseInt(String(end).replace(/[^0-9-]/g, ''));
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (endNum - startNum) + startNum);
                obj.innerHTML = formatRupiah(value);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- Auth & Init Logic ---
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('dompetku_auth');
            isLoggedIn ? showApp() : showLogin();
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if (email && pass) {
                const btn = e.target.querySelector('button[type="submit"]');
                const originalContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="crescent-loader w-5 h-5 border-2"></div>';
                setTimeout(() => {
                    localStorage.setItem('dompetku_auth', 'true');
                    showApp();
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }, 1200);
            }
        }

        function handleLogout() {
            if(confirm('Akhiri sesi?')) {
                localStorage.removeItem('dompetku_auth');
                showLogin();
            }
        }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            const appView = document.getElementById('app-view');
            appView.classList.remove('hidden');
            appView.classList.add('animate-slide-up');
            initApp();
        }

        function showLogin() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('hidden');
        }

        function togglePassword() {
            const input = document.getElementById('password');
            input.type = input.type === "password" ? "text" : "password";
        }

        // --- App Logic ---
        function initApp() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="tanggal"]').value = today;
            document.getElementById('receipt-date').value = today;
            
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
            
            const cachedData = localStorage.getItem('dompetku_data');
            if (cachedData) {
                rawData = JSON.parse(cachedData);
                populateMonthFilter();
                renderHistory();
            }
            fetchData();
            initPrayerTimes();
        }

        async function fetchData(manual = false) {
            const icon = document.getElementById('refresh-icon');
            if(icon) icon.classList.add('fa-spin');
            
            try {
                if (!WEB_APP_URL && rawData.length > 0 && !manual) return;
                const response = await fetch(`${WEB_APP_URL}?action=read`);
                const result = await response.json();
                if (result.status === 'success') {
                    rawData = result.data;
                    localStorage.setItem('dompetku_data', JSON.stringify(rawData));
                    document.getElementById('offline-indicator').classList.add('hidden');
                    populateMonthFilter();
                    renderHistory();
                    if(manual) showToast('Data Diperbarui', 'success');
                }
            } catch (error) {
                console.error(error);
                if (rawData.length > 0) document.getElementById('offline-indicator').classList.remove('hidden');
            } finally {
                if(icon) icon.classList.remove('fa-spin');
            }
        }

        async function submitForm(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="crescent-loader w-5 h-5 border-2"></div>';

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            if (data.tipe === 'Hutang' || data.tipe === 'Piutang') data.status = 'Belum Lunas';
            else data.status = '-';

            try {
                const response = await fetch(`${WEB_APP_URL}?action=create`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('Barakallah, Tersimpan!', 'success');
                    closeModal();
                    e.target.reset();
                    document.querySelector('input[name="tanggal"]').value = new Date().toISOString().split('T')[0];
                    fetchData(true); 
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function markAsPaid(id) {
            if(!confirm("Sudah lunas? Alhamdulillah.")) return;
            const card = document.getElementById(`card-${id}`);
            if(card) card.style.opacity = '0.5';
            try {
                const response = await fetch(`${WEB_APP_URL}?action=updateStatus`, {
                    method: 'POST',
                    body: JSON.stringify({ id: id, status: 'Lunas' })
                });
                if (await response.json().then(r => r.status === 'success')) {
                    showToast('Lunas, Alhamdulillah', 'success');
                    fetchData(true);
                }
            } catch (error) {
                showToast('Gagal update', 'error');
                if(card) card.style.opacity = '1';
            }
        }

        // --- Prayer Time Logic ---
        async function initPrayerTimes() {
            const city = 'Jakarta';
            const country = 'Indonesia';
            const method = 20; 
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => fetchPrayerTimes(pos.coords.latitude, pos.coords.longitude),
                    err => fetchPrayerTimesByCity(city, country)
                );
            } else {
                fetchPrayerTimesByCity(city, country);
            }
        }

        async function fetchPrayerTimesByCity(city, country) {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=20`);
                const data = await res.json();
                updatePrayerUI(data.data, city);
            } catch (e) {
                console.error("Failed to fetch prayer times", e);
            }
        }

        async function fetchPrayerTimes(lat, long) {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${long}&method=20`);
                const data = await res.json();
                updatePrayerUI(data.data, "Lokasi Anda");
            } catch (e) {
                fetchPrayerTimesByCity("Jakarta", "Indonesia");
            }
        }

        function updatePrayerUI(data, location) {
            const timings = data.timings;
            const hijri = data.date.hijri;
            document.getElementById('location-name').innerText = location;
            document.getElementById('hijri-date').innerText = `${hijri.day} ${hijri.month.en} ${hijri.year} H`;
            document.getElementById('time-imsak').innerText = timings.Imsak;
            document.getElementById('time-maghrib').innerText = timings.Maghrib;
            startCountdown(timings);
        }

        function startCountdown(timings) {
            if (prayerInterval) clearInterval(prayerInterval);
            prayerInterval = setInterval(() => {
                const now = new Date();
                const times = {
                    imsak: parseTime(timings.Imsak),
                    maghrib: parseTime(timings.Maghrib)
                };
                let targetTime, name;
                if (now < times.imsak) { targetTime = times.imsak; name = "Imsak"; } 
                else if (now < times.maghrib) { targetTime = times.maghrib; name = "Berbuka"; } 
                else { targetTime = new Date(times.imsak.getTime() + 24 * 60 * 60 * 1000); name = "Imsak"; }

                const diff = targetTime - now;
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('countdown-timer').innerText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.getElementById('next-prayer-name').innerText = name;
            }, 1000);
        }

        function parseTime(timeStr) {
            const [time, modifier] = timeStr.split(' ');
            let [hours, minutes] = time.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return date;
        }

        // --- Delete Logic ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            const fab = document.getElementById('main-fab');
            const helper = document.getElementById('edit-helper');
            if (isEditMode) {
                btn.classList.add('bg-red-50', 'text-red-500', 'border-red-200');
                btn.innerHTML = '<i class="fas fa-times"></i>';
                fab.classList.add('scale-0'); 
                helper.classList.remove('hidden');
                helper.classList.add('flex');
            } else {
                btn.classList.remove('bg-red-50', 'text-red-500', 'border-red-200');
                btn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
                fab.classList.remove('scale-0'); 
                helper.classList.add('hidden');
                helper.classList.remove('flex');
                selectedIds.clear();
                updateDeleteBar();
            }
            renderHistory();
        }

        function toggleSelection(id) {
            if (!isEditMode) return;
            if (selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
            updateDeleteBar();
            renderHistory(); 
        }

        function toggleSelectAll() {
            const visibleIds = getVisibleIds();
            const allSelected = visibleIds.every(id => selectedIds.has(id));
            if (allSelected) visibleIds.forEach(id => selectedIds.delete(id));
            else visibleIds.forEach(id => selectedIds.add(id));
            renderHistory();
            updateDeleteBar();
        }

        function getVisibleIds() {
            const filterValue = document.getElementById('month-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            let filteredData = rawData;
            if (filterValue) filteredData = filteredData.filter(item => item.tanggal.startsWith(filterValue));
            if (searchTerm) filteredData = filteredData.filter(item => item.keterangan.toLowerCase().includes(searchTerm) || item.jumlah.toString().includes(searchTerm));
            return filteredData.map(item => item.id);
        }

        function updateDeleteBar() {
            const bar = document.getElementById('delete-bar');
            const count = document.getElementById('selected-count');
            count.innerText = selectedIds.size;
            if (selectedIds.size > 0) bar.classList.remove('translate-y-40');
            else bar.classList.add('translate-y-40');
        }

        async function deleteSelectedItems() {
            if (selectedIds.size === 0) return;
            if (!confirm(`Hapus ${selectedIds.size} data?`)) return;
            const idsToDelete = Array.from(selectedIds);
            const originalData = [...rawData]; 
            rawData = rawData.filter(item => !selectedIds.has(item.id));
            localStorage.setItem('dompetku_data', JSON.stringify(rawData));
            toggleEditMode(); 
            showToast('Menghapus...', 'success');
            try {
                await fetch(`${WEB_APP_URL}?action=delete`, {
                    method: 'POST', body: JSON.stringify({ ids: idsToDelete })
                });
            } catch (error) {
                rawData = originalData;
                localStorage.setItem('dompetku_data', JSON.stringify(rawData));
                renderHistory(); 
                showToast('Gagal menghapus!', 'error');
            }
        }

        // --- NEW: Full Report Logic ---
        function openFullReportModal() {
            const monthVal = document.getElementById('month-filter').value;
            if(!monthVal) { showToast('Pilih bulan terlebih dahulu', 'error'); return; }
            const [y, m] = monthVal.split('-');
            const monthName = new Date(y, m - 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            document.getElementById('report-period').innerText = `Periode: ${monthName}`;
            let filteredData = rawData.filter(item => item.tanggal.startsWith(monthVal));
            filteredData.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

            let totalIncome = 0; let totalExpense = 0;
            const tableBody = document.getElementById('report-table-body');
            let tableHtml = '';

            if(filteredData.length === 0) {
                tableHtml = '<tr><td colspan="4" class="text-center italic text-slate-400 py-4">Tidak ada data transaksi.</td></tr>';
            } else {
                filteredData.forEach(item => {
                    const val = parseInt(item.jumlah);
                    const isExp = ['Keluar', 'Hutang', 'Piutang'].includes(item.tipe);
                    if(isExp) totalExpense += val; else totalIncome += val;
                    tableHtml += `<tr>
                        <td>${new Date(item.tanggal).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</td>
                        <td class="font-medium">${item.keterangan}</td>
                        <td><span class="px-2 py-0.5 rounded text-[9px] ${isExp ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">${item.tipe}</span></td>
                        <td class="text-right font-bold ${isExp ? 'text-red-600' : 'text-emerald-600'}">${formatRupiah(val)}</td>
                    </tr>`;
                });
            }
            document.getElementById('report-income').innerText = formatRupiah(totalIncome);
            document.getElementById('report-expense').innerText = formatRupiah(totalExpense);
            document.getElementById('report-balance').innerText = formatRupiah(totalIncome - totalExpense);
            tableBody.innerHTML = tableHtml;

            const modal = document.getElementById('modal-full-report');
            const wrapper = document.getElementById('report-content-wrapper');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); wrapper.classList.remove('scale-95'); wrapper.classList.add('scale-100'); }, 10);
        }

        function closeFullReportModal() {
            const modal = document.getElementById('modal-full-report');
            const wrapper = document.getElementById('report-content-wrapper');
            modal.classList.add('opacity-0'); wrapper.classList.remove('scale-100'); wrapper.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function downloadFullReport(format) {
            const element = document.getElementById('monthly-report-container');
            const btn = event.currentTarget; 
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                if (format === 'pdf') {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`Laporan-DompetRamadan-${Date.now()}.pdf`);
                } else {
                    const link = document.createElement('a');
                    link.download = `Laporan-DompetRamadan-${Date.now()}.${format}`;
                    link.href = canvas.toDataURL(`image/${format === 'jpg' ? 'jpeg' : 'png'}`);
                    link.click();
                }
                showToast('Laporan berhasil disimpan!', 'success');
                btn.innerHTML = originalContent; btn.disabled = false;
            }).catch(err => { console.error(err); showToast('Gagal menyimpan', 'error'); btn.innerHTML = originalContent; btn.disabled = false; });
        }

        // --- Receipt Logic ---
        function openReceiptModal() {
            const modal = document.getElementById('modal-receipt');
            const content = document.getElementById('receipt-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 50);
            renderReceiptInputs(); updateReceiptPreview();
        }

        function closeReceiptModal() {
            const modal = document.getElementById('modal-receipt');
            const content = document.getElementById('receipt-content');
            modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function addReceiptItem() { receiptItems.push({name: '', qty: 1, price: 0}); renderReceiptInputs(); updateReceiptPreview(); }
        function removeReceiptItem(index) { receiptItems.splice(index, 1); renderReceiptInputs(); updateReceiptPreview(); }
        function updateReceiptItem(index, field, value) {
            if (field === 'qty' || field === 'price') value = parseInt(value) || 0;
            receiptItems[index][field] = value; updateReceiptPreview();
        }

        function renderReceiptInputs() {
            const container = document.getElementById('receipt-items-container');
            container.innerHTML = receiptItems.map((item, index) => `
                <div class="flex gap-2 items-center">
                    <input type="text" placeholder="Item" value="${item.name}" oninput="updateReceiptItem(${index}, 'name', this.value)" class="flex-1 bg-emerald-50/50 rounded-lg px-2 py-2 text-xs border border-emerald-100 outline-none focus:border-emerald-300">
                    <input type="number" placeholder="Qty" value="${item.qty}" oninput="updateReceiptItem(${index}, 'qty', this.value)" class="w-12 bg-emerald-50/50 rounded-lg px-2 py-2 text-xs border border-emerald-100 outline-none focus:border-emerald-300 text-center">
                    <input type="number" placeholder="Rp" value="${item.price}" oninput="updateReceiptItem(${index}, 'price', this.value)" class="w-20 bg-emerald-50/50 rounded-lg px-2 py-2 text-xs border border-emerald-100 outline-none focus:border-emerald-300">
                    <button onclick="removeReceiptItem(${index})" class="text-red-400 hover:text-red-600 px-1"><i class="fas fa-trash-alt text-xs"></i></button>
                </div>`).join('');
        }

        function updateReceiptPreview() {
            document.getElementById('preview-store').innerText = document.getElementById('receipt-store').value || 'TOKO';
            const date = document.getElementById('receipt-date').value;
            document.getElementById('preview-date').innerText = date ? new Date(date).toLocaleDateString('id-ID', {weekday:'long', year:'numeric', month:'long', day:'numeric'}) : '...';
            const itemsContainer = document.getElementById('preview-items');
            let total = 0;
            itemsContainer.innerHTML = receiptItems.map(item => {
                const subtotal = item.qty * item.price; total += subtotal;
                if(!item.name) return '';
                return `<div class="flex justify-between items-start"><div class="w-2/3"><span class="block font-bold">${item.name.toUpperCase()}</span><span class="text-[10px] text-slate-500">${item.qty} x ${formatRupiah(item.price)}</span></div><div class="w-1/3 text-right font-bold">${formatRupiah(subtotal)}</div></div>`;
            }).join('');
            document.getElementById('preview-total').innerText = formatRupiah(total);
        }

        function downloadReceiptAsImage() {
            const element = document.getElementById('receipt-preview-container');
            const btn = document.querySelector('#modal-receipt button.bg-emerald-800');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...'; btn.disabled = true;
            html2canvas(element, { scale: 2, backgroundColor: '#ffffff', logging: false, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); link.download = 'Struk-Dompet-Ramadan-' + Date.now() + '.png'; link.href = canvas.toDataURL('image/png'); link.click();
                btn.innerHTML = originalText; btn.disabled = false; showToast('Struk berhasil disimpan!', 'success');
            }).catch(err => { console.error(err); btn.innerHTML = originalText; btn.disabled = false; showToast('Gagal menyimpan gambar', 'error'); });
        }

        // --- Render UI ---
        function populateMonthFilter() {
            const select = document.getElementById('month-filter');
            const currentVal = select.value;
            const uniqueMonths = [...new Set(rawData.map(item => { const d = new Date(item.tanggal); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }))].sort().reverse();
            select.innerHTML = uniqueMonths.map(m => { const [y, monthNum] = m.split('-'); const monthName = new Date(y, monthNum - 1).toLocaleString('id-ID', { month: 'long' }); return `<option value="${m}">${monthName} ${y}</option>`; }).join('');
            if (uniqueMonths.length === 0) select.innerHTML = `<option value="">Bulan Ini</option>`;
            if (currentVal && uniqueMonths.includes(currentVal)) select.value = currentVal; else if (uniqueMonths.length > 0) select.value = uniqueMonths[0];
        }

        function renderHistory() {
            const filterValue = document.getElementById('month-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('transaction-list');
            let filteredData = rawData;
            if (filterValue) filteredData = filteredData.filter(item => item.tanggal.startsWith(filterValue));
            if (searchTerm) filteredData = filteredData.filter(item => item.keterangan.toLowerCase().includes(searchTerm) || item.jumlah.toString().includes(searchTerm));
            let income = 0, expense = 0;
            filteredData.forEach(item => { const val = parseInt(item.jumlah); if (item.tipe === 'Masuk') income += val; if (['Keluar', 'Hutang', 'Piutang'].includes(item.tipe)) expense += val; });
            animateValue('total-balance', 0, income - expense, 800);
            document.getElementById('total-income').textContent = formatRupiah(income);
            document.getElementById('total-expense').textContent = formatRupiah(expense);
            const activeTab = document.querySelector('.nav-btn.active').dataset.target;
            if (activeTab === 'hutang') { renderDebtList(rawData, searchTerm, 'Hutang'); return; }
            else if (activeTab === 'piutang') { renderReceivableList(rawData, searchTerm); return; }
            else if (activeTab === 'laporan') { renderReports(filteredData); return; }
            if (filteredData.length === 0) { container.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-emerald-300 animate-slide-up"><i class="fas fa-moon text-4xl mb-3 opacity-30"></i><p class="text-xs font-medium">Belum ada catatan.</p></div>`; return; }
            container.innerHTML = filteredData.map((item, index) => {
                const isExpense = ['Keluar', 'Hutang', 'Piutang'].includes(item.tipe);
                const colorClass = isExpense ? 'text-red-500' : 'text-emerald-600';
                let iconClass = 'bg-slate-50 text-slate-400'; let iconName = 'fa-coins';
                if(item.tipe === 'Masuk') { iconClass = 'bg-emerald-100 text-emerald-600'; iconName = 'fa-arrow-down'; }
                if(item.tipe === 'Keluar') { iconClass = 'bg-red-50 text-red-500'; iconName = 'fa-shopping-basket'; }
                if(item.tipe === 'Hutang') { iconClass = 'bg-orange-50 text-orange-500'; iconName = 'fa-file-invoice'; }
                if(item.tipe === 'Piutang') { iconClass = 'bg-teal-50 text-teal-600'; iconName = 'fa-hand-holding-usd'; }
                const isSelected = selectedIds.has(item.id);
                const selectStyle = isSelected ? 'bg-emerald-50 border-emerald-300 ring-1 ring-emerald-300' : 'bg-white border-transparent';
                const delay = Math.min(index * 50, 500);
                return `<div id="container-${item.id}" onclick="isEditMode ? toggleSelection('${item.id}') : null" class="${selectStyle} p-4 rounded-2xl shadow-sm border flex items-center justify-between active:scale-[0.98] transition-all duration-300 select-none cursor-pointer animate-slide-up" style="animation-delay: ${delay}ms; animation-fill-mode: forwards; opacity: 0;"><div class="flex items-center gap-4 overflow-hidden">${isEditMode ? `<div class="w-5 h-5 rounded-full border-2 ${isSelected ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'} flex items-center justify-center"><i class="fas fa-check text-white text-[10px] ${isSelected?'':'hidden'}"></i></div>` : ''}<div class="w-10 h-10 rounded-full ${iconClass} flex items-center justify-center shrink-0"><i class="fas ${iconName} text-xs"></i></div><div class="min-w-0"><p class="font-bold text-slate-700 text-sm truncate mb-0.5">${item.keterangan}</p><p class="text-[10px] text-slate-400 font-medium">${new Date(item.tanggal).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})}</p></div></div><div class="text-right shrink-0"><p class="font-bold ${colorClass} text-sm">${isExpense ? '-' : '+'} ${formatRupiah(item.jumlah)}</p></div></div>`;
            }).join('');
        }

        function renderDebtList(data, search, type) {
            const container = document.getElementById('transaction-list');
            let debts = data.filter(item => item.tipe === type);
            if(search) debts = debts.filter(item => item.keterangan.toLowerCase().includes(search));
            const totalHutang = debts.reduce((acc, curr) => acc + parseInt(curr.jumlah), 0);
            const totalBelumLunas = debts.filter(p => p.status !== 'Lunas').reduce((acc, curr) => acc + parseInt(curr.jumlah), 0);
            const percent = totalHutang > 0 ? ((totalHutang - totalBelumLunas)/totalHutang)*100 : 0;
            let bg = type === 'Hutang' ? 'from-orange-400 to-red-500' : 'from-teal-400 to-emerald-500'; let title = type === 'Hutang' ? 'Hutang' : 'Piutang';
            let html = `<div class="bg-gradient-to-r ${bg} rounded-[1.5rem] p-5 text-white shadow-lg mb-6 animate-fade-in relative overflow-hidden"><div class="absolute right-0 top-0 opacity-10 text-6xl"><i class="fas fa-kaaba"></i></div><div class="flex justify-between items-end mb-3 relative z-10"><div><p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Total ${title}</p><h2 class="text-2xl font-serif font-bold">${formatRupiah(totalHutang)}</h2></div><div class="text-right"><p class="text-[10px] font-medium opacity-80">Sisa</p><p class="font-bold text-lg">${formatRupiah(totalBelumLunas)}</p></div></div><div class="w-full bg-black/20 h-1.5 rounded-full overflow-hidden relative z-10"><div class="bg-white h-full transition-all duration-1000 ease-out" style="width: ${percent}%"></div></div></div>`;
            if (debts.length === 0) { container.innerHTML = html + `<div class="text-center py-10 text-slate-400 text-xs">Bersih dari ${title}, Alhamdulillah.</div>`; return; }
            html += debts.map((item, index) => {
                const isLunas = item.status === 'Lunas';
                return `<div id="card-${item.id}" class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-50 mb-3 relative overflow-hidden active:scale-[0.99] transition-all animate-slide-up" style="animation-delay: ${index*50}ms">${isLunas ? '<div class="absolute -right-6 top-3 bg-emerald-500 text-white text-[9px] font-bold px-8 py-1 rotate-45 shadow-sm">LUNAS</div>' : ''}<div class="flex justify-between items-start mb-3"><div class="min-w-0 pr-4"><h4 class="font-bold text-slate-800 truncate text-sm">${item.keterangan}</h4><div class="flex items-center gap-1 text-[10px] text-slate-400 mt-1"><i class="far fa-calendar"></i> ${new Date(item.tanggal).toLocaleDateString('id-ID')}</div></div><p class="font-bold text-slate-700 shrink-0 text-sm">${formatRupiah(item.jumlah)}</p></div>${!isLunas ? `<div class="pt-2 mt-2 border-t border-slate-50 flex justify-end"><button onclick="markAsPaid('${item.id}')" class="text-[10px] font-bold bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg border border-emerald-100 active:scale-95 transition">Lunasi</button></div>` : ''}</div>`;
            }).join('');
            container.innerHTML = html;
        }

        function renderReceivableList(d,s) { renderDebtList(d,s,'Piutang'); }

        function renderReports(data) {
            if (typeof Chart === 'undefined') return;
            if(pieChart) pieChart.destroy(); if(barChart) barChart.destroy();
            Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
            const ctxPie = document.getElementById('chart-pie').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Masuk', 'Keluar', 'Hutang', 'Piutang'],
                    datasets: [{
                        data: [
                            data.filter(i => i.tipe === 'Masuk').reduce((a, b) => a + parseInt(b.jumlah), 0),
                            data.filter(i => i.tipe === 'Keluar').reduce((a, b) => a + parseInt(b.jumlah), 0),
                            data.filter(i => i.tipe === 'Hutang').reduce((a, b) => a + parseInt(b.jumlah), 0),
                            data.filter(i => i.tipe === 'Piutang').reduce((a, b) => a + parseInt(b.jumlah), 0),
                        ],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#14b8a6'], borderWidth: 0, hoverOffset: 10
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 6, font: {size: 10} } } } }
            });
            const dailyData = {};
            for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); dailyData[d.toISOString().split('T')[0]] = { label: d.toLocaleDateString('id-ID', {weekday:'short'}), val: 0 }; }
            data.forEach(item => { if(dailyData[item.tanggal]) dailyData[item.tanggal].val += parseInt(item.jumlah); });
            const ctxBar = document.getElementById('chart-bar').getContext('2d');
            const gradient = ctxBar.createLinearGradient(0, 0, 0, 300); gradient.addColorStop(0, '#10b981'); gradient.addColorStop(1, '#047857');
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: { labels: Object.values(dailyData).map(d => d.label), datasets: [{ label: 'Rp', data: Object.values(dailyData).map(d => d.val), backgroundColor: gradient, borderRadius: 4, barThickness: 12 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: {size: 9} } } }, plugins: { legend: { display: false } } }
            });
        }

        function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); }
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none'), 3000);
        }

        function openModal() { const modal = document.getElementById('modal'); const content = document.getElementById('modal-content'); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); }, 50); }
        function closeModal() { const modal = document.getElementById('modal'); const content = document.getElementById('modal-content'); content.classList.add('translate-y-full'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 350); }
        function switchTab(target) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const indicator = btn.querySelector('.indicator'); const icon = btn.querySelector('i');
                if(btn.dataset.target === target) { btn.classList.add('active', 'text-emerald-600'); btn.classList.remove('text-emerald-300'); indicator.classList.remove('opacity-0'); icon.classList.add('text-emerald-600'); } 
                else { btn.classList.remove('active', 'text-emerald-600'); btn.classList.add('text-emerald-300'); indicator.classList.add('opacity-0'); icon.classList.remove('text-emerald-600'); }
            });
            document.getElementById('view-dashboard').classList.toggle('hidden', target === 'laporan');
            document.getElementById('view-report').classList.toggle('hidden', target !== 'laporan');
            if (isEditMode) toggleEditMode(); else renderHistory();
        }

        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
