<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan Modern</title>
    <!-- Favicon Bertema Uang (Emoji ðŸ’°) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’°</text></svg>">
    <!-- Font Awesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #2563EB;
            --primary-dark: #1E40AF;
            --secondary: #64748B;
            --bg-body: #F1F5F9;
            --bg-card: #FFFFFF;
            --text-main: #0F172A;
            --text-muted: #64748B;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; padding-bottom: 80px; }

        /* --- LAYOUT UTAMA --- */
        .container { max-width: 480px; margin: 0 auto; background: var(--bg-body); min-height: 100vh; position: relative; }
        
        /* HEADER */
        header { background: var(--bg-card); padding: 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        .status-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 20px; background: #e2e8f0; color: #64748b; font-weight: 600; }
        .status-badge.online { background: #dcfce7; color: #166534; }

        /* SALDO CARD */
        .balance-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .balance-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
        .balance-amount { font-size: 2rem; font-weight: 800; letter-spacing: 0.5px; }
        .balance-stats { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .stat-item h4 { font-size: 0.75rem; opacity: 0.8; font-weight: 400; }
        .stat-item p { font-size: 0.95rem; font-weight: 600; }

        /* MENU NAVIGASI (GRID) */
        .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; padding: 0 20px; }
        .action-btn { background: var(--bg-card); border: none; padding: 15px 5px; border-radius: var(--radius); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; box-shadow: var(--shadow); transition: transform 0.2s; }
        .action-btn:active { transform: scale(0.95); }
        .action-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: white; }
        .action-label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
        
        .bg-in { background-color: var(--success); }
        .bg-out { background-color: var(--danger); }
        .bg-debt { background-color: var(--warning); }
        .bg-other { background-color: var(--info); }

        /* FILTER & SUMMARY CARD */
        .filter-card { margin: 0 20px 20px 20px; background: var(--bg-card); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .month-picker { border: 1px solid #E2E8F0; padding: 8px 12px; border-radius: 8px; font-family: inherit; color: var(--text-main); outline: none; background: #F8FAFC; cursor: pointer; }
        .month-picker:focus { border-color: var(--primary); }
        
        .month-summary { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .ms-item { flex: 1; }
        .ms-item.right { text-align: right; }
        .ms-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2px; }
        .ms-value { font-weight: 700; }

        /* HISTORY & CONTENT */
        .section-title { padding: 0 20px; font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .history-list { padding: 0 20px; display: flex; flex-direction: column; gap: 12px; }
        .transaction-card { background: var(--bg-card); padding: 15px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: flex-start; box-shadow: var(--shadow); cursor: default; }
        .t-left { display: flex; align-items: flex-start; gap: 15px; flex: 1; }
        .t-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; background: #F1F5F9; color: var(--text-muted); flex-shrink: 0; }
        .t-info { display: flex; flex-direction: column; gap: 2px; width: 100%; }
        .t-info h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
        .t-info span { font-size: 0.75rem; color: var(--text-muted); }
        .t-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
        .t-amount { font-weight: 700; font-size: 0.95rem; white-space: nowrap; }
        
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-orange { color: var(--warning); }

        /* DEBT STATUS BADGES */
        .badge-debt { font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; display: inline-block; }
        .badge-unpaid { background-color: #FEF2F2; color: var(--danger); border-color: #FECACA; }
        .badge-paid { background-color: #ECFDF5; color: var(--success); border-color: #A7F3D0; }
        .badge-debt:active { transform: scale(0.95); }

        /* MODAL (FORM INPUT) */
        .modal { position: fixed; bottom: -100%; left: 0; right: 0; background: var(--bg-card); border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; max-width: 480px; margin: 0 auto; }
        .modal.active { bottom: 0; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
        .overlay.active { display: block; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-muted); }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #E2E8F0; border-radius: 10px; font-size: 1rem; outline: none; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus { border-color: var(--primary); }
        
        .btn-submit { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-submit:disabled { background: var(--secondary); opacity: 0.7; cursor: not-allowed; }
        
        /* LOADING & NOTIFICATION */
        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 200; width: max-content; }
        .toast.show { opacity: 1; }

        /* UTILITIES */
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .chart-container { padding: 0 20px 20px 20px; height: 200px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- HEADER & SALDO -->
        <header>
            <div class="header-top">
                <div class="app-title"><i class="fas fa-wallet" style="color:var(--primary)"></i> FinSaku</div>
                <div id="connectionStatus" class="status-badge">Demo Mode</div>
            </div>
            
            <div class="balance-card">
                <div class="balance-label">Total Saldo (Semua Waktu)</div>
                <div class="balance-amount" id="displayBalance">Rp 0</div>
            </div>
        </header>

        <!-- MENU NAVIGASI -->
        <div class="quick-actions">
            <button class="action-btn" onclick="openModal('Masuk')">
                <div class="action-icon bg-in"><i class="fas fa-arrow-down"></i></div>
                <span class="action-label">Masuk</span>
            </button>
            <button class="action-btn" onclick="openModal('Keluar')">
                <div class="action-icon bg-out"><i class="fas fa-arrow-up"></i></div>
                <span class="action-label">Keluar</span>
            </button>
            <button class="action-btn" onclick="openModal('Hutang')">
                <div class="action-icon bg-debt"><i class="fas fa-hand-holding-usd"></i></div>
                <span class="action-label">Hutang</span>
            </button>
            <button class="action-btn" onclick="openModal('Lainnya')">
                <div class="action-icon bg-other"><i class="fas fa-ellipsis-h"></i></div>
                <span class="action-label">Lainnya</span>
            </button>
        </div>

        <!-- FILTER & RINGKASAN BULANAN -->
        <div class="section-title">
            <span>Filter & Statistik</span>
        </div>
        <div class="filter-card">
            <div class="filter-header">
                <input type="month" id="monthFilter" class="month-picker" onchange="renderData()">
            </div>
            <div class="month-summary">
                <div class="ms-item">
                    <div class="ms-label">Pemasukan Bulan Ini</div>
                    <div class="ms-value text-green" id="monthIn">Rp 0</div>
                </div>
                <div class="ms-item right">
                    <div class="ms-label">Pengeluaran Bulan Ini</div>
                    <div class="ms-value text-red" id="monthOut">Rp 0</div>
                </div>
            </div>
        </div>

        <!-- GRAFIK -->
        <div class="chart-container">
            <canvas id="financeChart"></canvas>
        </div>

        <!-- RIWAYAT TRANSAKSI -->
        <div class="section-title">
            <span>Riwayat Transaksi</span>
            <span style="font-size: 0.8rem; color: var(--primary); cursor: pointer;" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Refresh</span>
        </div>
        
        <div id="historyList" class="history-list">
            <!-- Item Transaksi akan dirender di sini via JS -->
            <div class="empty-state">
                <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>Belum ada transaksi</p>
            </div>
        </div>
    </div>

    <!-- MODAL FORM INPUT -->
    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div class="modal" id="transactionModal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Tambah Transaksi</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form id="transactionForm" onsubmit="submitTransaction(event)">
            <input type="hidden" id="inputType">
            
            <div class="form-group">
                <label class="form-label">Nominal (Rp)</label>
                <input type="number" id="inputAmount" class="form-input" placeholder="0" required min="1">
            </div>
            
            <div class="form-group">
                <label class="form-label">Kategori</label>
                <select id="inputCategory" class="form-select">
                    <option value="Umum">Umum</option>
                    <option value="Makan">Makan & Minum</option>
                    <option value="Transport">Transportasi</option>
                    <option value="Gaji">Gaji</option>
                    <option value="Belanja">Belanja</option>
                    <option value="Tagihan">Tagihan</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Catatan</label>
                <input type="text" id="inputNote" class="form-input" placeholder="Contoh: Beli Nasi Padang">
            </div>

            <button type="submit" class="btn-submit" id="btnSubmit">
                <span id="btnText">Simpan Transaksi</span>
                <span id="btnLoader" class="loader hidden"></span>
            </button>
        </form>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">Berhasil disimpan</div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxX6XpptFEW32cfhoK_KSP0sDVe0uTQ8gQIqsFY9n60verz0uXmADRuUUSAsRB4ogE4/exec"; 
        
        // State Management
        let transactions = [];
        let myChart = null;

        // --- CORE FUNCTIONS ---

        function init() {
            // Set default filter ke bulan saat ini (YYYY-MM)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthFilter').value = `${year}-${month}`;

            if (GOOGLE_SCRIPT_URL === "https://script.google.com/macros/s/AKfycbxX6XpptFEW32cfhoK_KSP0sDVe0uTQ8gQIqsFY9n60verz0uXmADRuUUSAsRB4ogE4/exec") {
                document.getElementById('connectionStatus').textContent = "Demo Mode";
                loadLocalData();
            } else {
                document.getElementById('connectionStatus').textContent = "Online";
                document.getElementById('connectionStatus').classList.add('online');
                fetchDataFromSheet();
            }
            initChart();
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        // --- UI HANDLERS ---

        function openModal(type) {
            document.getElementById('inputType').value = type;
            document.getElementById('modalTitle').textContent = `Input ${type}`;
            document.getElementById('overlay').classList.add('active');
            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('inputAmount').focus();
        }

        function closeModal() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? "#EF4444" : "#333";
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function renderData() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const filterValue = document.getElementById('monthFilter').value; // format YYYY-MM
            
            let globalBalance = 0;
            let monthIncome = 0;
            let monthExpense = 0;
            
            // 1. Hitung Saldo Global
            transactions.forEach(item => {
                const amount = parseFloat(item.amount);
                // Hutang yang belum lunas tetap mengurangi "Saldo" visual
                if (item.type === 'Masuk') globalBalance += amount;
                else if (item.type === 'Keluar' || item.type === 'Hutang') globalBalance -= amount;
            });
            document.getElementById('displayBalance').textContent = formatRupiah(globalBalance);

            // 2. Filter data berdasarkan Bulan
            const filteredData = transactions.filter(item => {
                if(!item.date) return false;
                const parts = item.date.split('/'); 
                if(parts.length !== 3) return false;
                const itemYearMonth = `${parts[2]}-${parts[1]}`;
                return itemYearMonth === filterValue;
            });

            // 3. Render Data Filtered
            // Karena kita butuh indeks asli untuk update status, kita simpan referensi
            // Tapi untuk simplifikasi demo, kita pakai ID unik jika ada, atau indeks array global
            // Kita akan mapping ulang agar bisa akses index asli
            const dataToRender = filteredData.map(item => ({
                ...item,
                originalIndex: transactions.indexOf(item)
            })).reverse();

            if (dataToRender.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Tidak ada transaksi di bulan ini</p>
                    </div>`;
            }

            dataToRender.forEach(item => {
                const amount = parseFloat(item.amount);
                
                // Hitung Statistik Bulanan
                if (item.type === 'Masuk') monthIncome += amount;
                else if (item.type === 'Keluar' || item.type === 'Hutang') monthExpense += amount;

                // Render Item
                const div = document.createElement('div');
                div.className = 'transaction-card';
                
                let iconClass = 'fa-money-bill';
                let colorClass = 'text-green';
                let amountSign = '+';
                let debtStatusHtml = '';

                if (item.type === 'Masuk') { 
                    iconClass = 'fa-arrow-down'; colorClass = 'text-green'; amountSign = '+'; 
                } else if (item.type === 'Keluar') { 
                    iconClass = 'fa-arrow-up'; colorClass = 'text-red'; amountSign = '-'; 
                } else if (item.type === 'Hutang') { 
                    iconClass = 'fa-hand-holding-usd'; colorClass = 'text-orange'; amountSign = '-'; 
                    
                    // Logic Status Hutang
                    const isPaid = item.status === 'Lunas';
                    const badgeClass = isPaid ? 'badge-paid' : 'badge-unpaid';
                    const badgeText = isPaid ? 'Lunas' : 'Belum Lunas';
                    
                    debtStatusHtml = `
                        <div class="badge-debt ${badgeClass}" 
                             onclick="toggleDebtStatus(${item.originalIndex}, '${item.status}')">
                             ${badgeText} <i class="fas fa-edit" style="font-size:0.6rem; margin-left:2px;"></i>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="t-left">
                        <div class="t-icon">
                            <i class="fas ${iconClass} ${colorClass}"></i>
                        </div>
                        <div class="t-info">
                            <h4>${item.note || item.category}</h4>
                            <span>${item.date} â€¢ ${item.category}</span>
                            ${debtStatusHtml ? `<div style="margin-top:4px;">${debtStatusHtml}</div>` : ''}
                        </div>
                    </div>
                    <div class="t-right">
                        <div class="t-amount ${colorClass}">${amountSign} ${formatRupiah(amount)}</div>
                    </div>
                `;
                historyList.appendChild(div);
            });

            document.getElementById('monthIn').textContent = formatRupiah(monthIncome);
            document.getElementById('monthOut').textContent = formatRupiah(monthExpense);
            
            updateChart(monthIncome, monthExpense);
        }

        function toggleDebtStatus(index, currentStatus) {
            // Hanya bekerja optimal di Mode Demo (Local Storage)
            // Untuk Online Mode, memerlukan Script Google Apps yang mendukung fitur 'Edit'
            
            if (GOOGLE_SCRIPT_URL !== "https://script.google.com/macros/s/AKfycbxX6XpptFEW32cfhoK_KSP0sDVe0uTQ8gQIqsFY9n60verz0uXmADRuUUSAsRB4ogE4/exec") {
                alert("Fitur ubah status hutang hanya tersimpan di browser (Lokal) karena API saat ini hanya mendukung penambahan data (Append Only).");
            }

            const newStatus = currentStatus === 'Lunas' ? 'Belum Lunas' : 'Lunas';
            const confirmMsg = currentStatus === 'Lunas' 
                ? "Tandai kembali sebagai Belum Lunas?" 
                : "Tandai hutang ini sebagai Lunas?";

            if(confirm(confirmMsg)) {
                transactions[index].status = newStatus;
                
                // Simpan perubahan ke LocalStorage (selalu simpan lokal agar UI update)
                localStorage.setItem('finsaku_data', JSON.stringify(transactions));
                
                renderData();
                showToast(`Status diubah menjadi ${newStatus}`);
            }
        }

        // --- DATA HANDLERS ---

        function loadLocalData() {
            const saved = localStorage.getItem('finsaku_data');
            if (saved) {
                transactions = JSON.parse(saved);
                // Migrasi data lama yang belum punya status
                transactions = transactions.map(t => {
                    if (t.type === 'Hutang' && !t.status) t.status = 'Belum Lunas';
                    return t;
                });
            }
            renderData();
        }

        async function fetchDataFromSheet() {
            if (!GOOGLE_SCRIPT_URL) return;
            
            const btnRefresh = document.querySelector('.fa-sync-alt');
            btnRefresh.classList.add('fa-spin');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();
                if (result.status === 'success') {
                    // Backend mungkin belum punya kolom status, jadi kita defaultkan di frontend
                    transactions = result.data.map(t => ({
                        ...t,
                        status: t.status || (t.type === 'Hutang' ? 'Belum Lunas' : 'Selesai')
                    }));
                    renderData();
                }
            } catch (error) {
                console.error(error);
                showToast("Gagal mengambil data", true);
            } finally {
                btnRefresh.classList.remove('fa-spin');
            }
        }

        async function submitTransaction(e) {
            e.preventDefault();
            const btnSubmit = document.getElementById('btnSubmit');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            
            btnSubmit.disabled = true;
            btnText.textContent = "Menyimpan...";
            loader.classList.remove('hidden');

            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const formattedDate = `${dd}/${mm}/${yyyy}`;

            const type = document.getElementById('inputType').value;
            
            // Tentukan status awal
            let initialStatus = 'Selesai';
            if (type === 'Hutang') initialStatus = 'Belum Lunas';

            const data = {
                date: formattedDate,
                type: type,
                amount: document.getElementById('inputAmount').value,
                category: document.getElementById('inputCategory').value,
                note: document.getElementById('inputNote').value || '-',
                status: initialStatus 
            };

            if (GOOGLE_SCRIPT_URL === "https://script.google.com/macros/s/AKfycbxX6XpptFEW32cfhoK_KSP0sDVe0uTQ8gQIqsFY9n60verz0uXmADRuUUSAsRB4ogE4/exec") {
                setTimeout(() => {
                    transactions.push(data);
                    localStorage.setItem('finsaku_data', JSON.stringify(transactions));
                    finishSubmit(true);
                }, 800);
            } else {
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json(); 
                    finishSubmit(true);
                    // Kita reload manual agar data baru muncul
                    // Idealnya fetch ulang, tapi di sini kita push manual ke array lokal sementara
                    transactions.push(data); 
                    renderData();
                } catch (error) {
                    console.error("Error:", error);
                    finishSubmit(true);
                    showToast("Cek koneksi internet", true); 
                }
            }
        }

        function finishSubmit(success) {
            const btnSubmit = document.getElementById('btnSubmit');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            
            btnSubmit.disabled = false;
            btnText.textContent = "Simpan Transaksi";
            loader.classList.add('hidden');
            
            if (success) {
                showToast("Transaksi Berhasil!");
                closeModal();
                renderData();
            }
        }

        function refreshData() {
            if (GOOGLE_SCRIPT_URL === "https://script.google.com/macros/s/AKfycbxX6XpptFEW32cfhoK_KSP0sDVe0uTQ8gQIqsFY9n60verz0uXmADRuUUSAsRB4ogE4/exec") {
                showToast("Mode Demo: Data lokal dimuat ulang");
                loadLocalData();
            } else {
                fetchDataFromSheet();
            }
        }

        // --- CHART JS ---
        function initChart() {
            const ctx = document.getElementById('financeChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut', 
                data: {
                    labels: ['Pemasukan', 'Pengeluaran'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.raw);
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '70%', 
                }
            });
        }

        function updateChart(income, expense) {
            if (myChart) {
                myChart.data.datasets[0].data = [income, expense];
                myChart.update();
            }
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
