<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#064e3b" id="meta-theme-color"> 
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dompet Ramadan 2026 - Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=VT323&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas & jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* === THEME VARIABLES DEFINITION === */
        :root {
            /* Default: Emerald (Green) */
            --c-50: #ecfdf5;
            --c-100: #d1fae5;
            --c-200: #a7f3d0;
            --c-300: #6ee7b7;
            --c-400: #34d399;
            --c-500: #10b981;
            --c-600: #059669;
            --c-700: #047857;
            --c-800: #065f46;
            --c-900: #064e3b;
            --c-950: #022c22;
        }

        /* Theme: Midnight (Blue/Slate) */
        [data-theme="midnight"] {
            --c-50: #f0f9ff;
            --c-100: #e0f2fe;
            --c-200: #bae6fd;
            --c-300: #7dd3fc;
            --c-400: #38bdf8;
            --c-500: #0ea5e9;
            --c-600: #0284c7;
            --c-700: #0369a1;
            --c-800: #075985;
            --c-900: #0c4a6e;
            --c-950: #082f49;
        }

        /* Theme: Royal (Purple) */
        [data-theme="royal"] {
            --c-50: #faf5ff;
            --c-100: #f3e8ff;
            --c-200: #e9d5ff;
            --c-300: #d8b4fe;
            --c-400: #c084fc;
            --c-500: #a855f7;
            --c-600: #9333ea;
            --c-700: #7e22ce;
            --c-800: #6b21a8;
            --c-900: #581c87;
            --c-950: #3b0764;
        }

        /* Theme: Sahara (Gold/Orange) */
        [data-theme="sahara"] {
            --c-50: #fffbeb;
            --c-100: #fef3c7;
            --c-200: #fde68a;
            --c-300: #fcd34d;
            --c-400: #fbbf24;
            --c-500: #f59e0b;
            --c-600: #d97706;
            --c-700: #b45309;
            --c-800: #92400e;
            --c-900: #78350f;
            --c-950: #451a03;
        }

        /* Theme: Crimson (Red/Rose) */
        [data-theme="crimson"] {
            --c-50: #fff1f2;
            --c-100: #ffe4e6;
            --c-200: #fecdd3;
            --c-300: #fda4af;
            --c-400: #fb7185;
            --c-500: #f43f5e;
            --c-600: #e11d48;
            --c-700: #be123c;
            --c-800: #9f1239;
            --c-900: #881337;
            --c-950: #4c0519;
        }

        /* Standard CSS Overrides */
        body { 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background: linear-gradient(-45deg, var(--c-50), var(--c-100), var(--c-50), var(--c-50));
            background-size: 400% 400%;
            animation: gradient-bg 15s ease infinite;
        }

        @keyframes gradient-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .card-gradient { background: linear-gradient(135deg, var(--c-800) 0%, var(--c-700) 100%); }
        .prayer-gradient { background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%); } 
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .lantern-string { width: 2px; background: #d97706; margin: 0 auto; }
        
        .crescent-loader {
            width: 30px; height: 30px; border-radius: 50%;
            box-shadow: inset -4px 0 0 2px var(--c-600);
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .paper-tear {
            background-image: radial-gradient(circle at 10px -5px, transparent 12px, white 13px);
            background-size: 20px 20px; background-repeat: repeat-x;
            height: 15px; width: 100%; transform: rotate(180deg);
        }

        .report-table th { background-color: var(--c-900); color: white; padding: 8px; font-size: 10px; text-transform: uppercase; }
        .report-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 10px; color: #334155; }
        .report-table tr:last-child td { border-bottom: none; }
        .report-table tr:nth-child(even) { background-color: #f8fafc; }
        
        /* EQ Animation */
        .eq-container { display: flex; align-items: flex-end; justify-content: center; gap: 3px; height: 20px; width: 30px; }
        .eq-bar { width: 4px; background-color: #fbbf24; border-radius: 2px 2px 0 0; animation: eq-bounce 1s ease-in-out infinite; }
        .eq-bar:nth-child(1) { height: 6px; animation-delay: 0.1s; }
        .eq-bar:nth-child(2) { height: 12px; animation-delay: 0.2s; }
        .eq-bar:nth-child(3) { height: 8px; animation-delay: 0.4s; }
        .eq-bar:nth-child(4) { height: 5px; animation-delay: 0.0s; }
        @keyframes eq-bounce { 0%, 100% { height: 4px; opacity: 0.7; } 50% { height: 18px; opacity: 1; background-color: #fff; } }
        .pause-anim { animation-play-state: paused; opacity: 0.5; }

        /* Firefly */
        .firefly {
            position: absolute; width: 4px; height: 4px; background-color: #fbbf24; border-radius: 50%; opacity: 0;
            animation: firefly-glow 3s ease-in-out infinite alternate, float-up 10s linear infinite; filter: blur(1px);
        }
        @keyframes firefly-glow { 0% { opacity: 0.2; transform: scale(0.8); } 100% { opacity: 0.8; transform: scale(1.2); } }
        @keyframes float-up { 0% { transform: translateY(100vh) translateX(0); } 100% { transform: translateY(-100px) translateX(50px); } }

        /* === PRO CALENDAR ANIMATIONS === */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day-header { text-align: center; font-size: 10px; font-weight: 800; color: var(--c-500); padding-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .calendar-day { 
            aspect-ratio: 0.85; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; pt-1;
            border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: rgba(255,255,255,0.6); 
            border: 1px solid rgba(255,255,255,0.5); 
            color: #334155; position: relative; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            padding-top: 6px;
        }
        
        /* Staggered Entrance */
        .calendar-day { animation: calPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards; }
        @keyframes calPop { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }

        .calendar-day:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); background-color: white; z-index: 10; border-color: var(--c-300); }
        .calendar-day:active { transform: scale(0.95); }

        .calendar-day.empty { background: transparent; border: none; cursor: default; box-shadow: none; pointer-events: none; }
        
        .calendar-day.today { 
            background: linear-gradient(135deg, var(--c-600), var(--c-800)); 
            color: white; border: none; 
            box-shadow: 0 4px 12px var(--c-300);
        }
        .calendar-day.today .hijri-date { color: rgba(255,255,255,0.8); }
        
        .calendar-day.holiday { border-color: #fee2e2; background-color: #fef2f2; }
        .calendar-day.holiday .date-num { color: #dc2626; }
        .calendar-day.holiday.today { background: #dc2626; color: white; border: none; }
        .calendar-day.holiday.today .date-num { color: white; }

        .calendar-day.friday { background-color: var(--c-50); border-color: var(--c-200); }

        /* Inner Elements */
        .date-num { font-size: 14px; font-weight: 700; line-height: 1; margin-bottom: 2px; }
        .hijri-date { font-size: 8px; font-family: 'Plus Jakarta Sans', sans-serif; opacity: 0.7; font-weight: 500; }
        .marker-dot { width: 4px; height: 4px; border-radius: 50%; background-color: var(--c-500); margin-top: 4px; }
        .holiday .marker-dot { background-color: #dc2626; }
        .today .marker-dot { background-color: #fbbf24; box-shadow: 0 0 5px #fbbf24; }

        /* Slide Transitions */
        .slide-left { animation: slideLeft 0.3s forwards; }
        .slide-right { animation: slideRight 0.3s forwards; }
        @keyframes slideLeft { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideRight { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Amiri"', 'serif'],
                        mono: ['"VT323"', 'monospace'],
                    },
                    colors: {
                        emerald: {
                            50: 'var(--c-50)', 100: 'var(--c-100)', 200: 'var(--c-200)', 300: 'var(--c-300)',
                            400: 'var(--c-400)', 500: 'var(--c-500)', 600: 'var(--c-600)', 700: 'var(--c-700)',
                            800: 'var(--c-800)', 900: 'var(--c-900)', 950: 'var(--c-950)',
                        },
                        primary: 'var(--c-600)', 
                        primaryDark: 'var(--c-900)',
                        gold: '#fbbf24', goldDark: '#d97706', surface: 'var(--c-50)',
                    },
                    animation: {
                        'float-slow': 'float 8s ease-in-out infinite',
                        'twinkle': 'twinkle 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 8s linear infinite',
                        'spin-reverse': 'spin-reverse 10s linear infinite',
                        'shimmer': 'shimmer 2.5s infinite linear',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0) rotate(0deg)' }, '50%': { transform: 'translateY(-15px) rotate(2deg)' } },
                        twinkle: { '0%, 100%': { opacity: '0.3', transform: 'scale(1)' }, '50%': { opacity: '1', transform: 'scale(1.2)' } },
                        slideUp: { '0%': { transform: 'translateY(40px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        'spin-reverse': { '0%': { transform: 'rotate(360deg)' }, '100%': { transform: 'rotate(0deg)' } },
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } },
                        blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
                    },
                    backgroundImage: {
                        'islamic-pattern': "url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")",
                    }
                }
            }
        }
    </script>
</head>

<body class="text-slate-800 font-sans h-[100dvh] w-full overflow-hidden text-sm sm:text-base relative selection:bg-emerald-200">

    <!-- Audio Element -->
    <audio id="bg-music" preload="auto"></audio>
    <audio id="azan-player" src="audio/azan.mp3" preload="auto"></audio>

    <!-- Background Decorations -->
    <div id="particle-container" class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-72 h-72 bg-emerald-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob"></div>
        <div class="absolute top-[-10%] right-[-10%] w-72 h-72 bg-yellow-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-10%] left-[20%] w-72 h-72 bg-teal-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-4000"></div>
        <div class="absolute top-0 left-[10%] animate-float-slow z-[1]">
            <div class="lantern-string h-20"></div>
            <div class="text-goldDark text-5xl drop-shadow-[0_10px_10px_rgba(0,0,0,0.2)] opacity-90 relative">
                <i class="fas fa-mosque"></i>
                <div class="absolute inset-0 text-yellow-300 blur-md opacity-40 animate-pulse"></div>
            </div>
        </div>
        <div class="absolute top-0 right-[15%] animate-float-medium z-[1]" style="animation-delay: 1.5s">
            <div class="lantern-string h-32"></div>
            <div class="text-gold text-4xl drop-shadow-md opacity-90 relative">
                <i class="fas fa-star-and-crescent"></i>
                <div class="absolute inset-0 text-white blur-sm opacity-50 animate-twinkle"></div>
            </div>
        </div>
        <div class="absolute top-20 right-[-40px] text-yellow-100/30 text-[180px] animate-pulse-slow blur-sm z-[-1] rotate-12"><i class="fas fa-moon"></i></div>
        <div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-emerald-50/80 to-transparent z-[0]"></div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 glass-panel bg-emerald-900/90 text-white px-5 py-3 rounded-full shadow-xl shadow-emerald-900/20 z-[70] transition-all duration-500 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3 w-max border border-emerald-700/50">
        <div class="w-6 h-6 rounded-full bg-gold flex items-center justify-center text-emerald-900 shadow-lg animate-bounce"><i id="toast-icon" class="fas fa-check text-[10px]"></i></div>
        <span id="toast-message" class="text-xs font-bold font-sans tracking-wide">Alhamdulillah</span>
    </div>

    <!-- Delete Bar -->
    <div id="delete-bar" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-xl border border-red-100 text-slate-800 px-4 py-2 pr-6 rounded-full shadow-2xl z-[50] transition-all duration-500 translate-y-40 flex items-center gap-4">
        <div class="bg-red-50 text-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xs shadow-inner animate-pulse"><span id="selected-count">0</span></div>
        <button id="btn-confirm-delete" onclick="deleteSelectedItems()" class="text-red-500 font-bold text-xs uppercase tracking-wider flex items-center gap-2 active:scale-95 transition"><i class="fas fa-trash-alt"></i> Hapus Data</button>
    </div>

    <!-- ================== LOGIN VIEW ================== -->
    <section id="login-view" class="h-full w-full flex flex-col items-center justify-center p-6 absolute inset-0 z-50 overflow-hidden bg-gradient-to-b from-emerald-900 to-emerald-800">
        <div class="absolute inset-0 bg-islamic-pattern opacity-10 animate-pulse-slow"></div>
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
             <div class="firefly" style="top: 20%; left: 20%; animation-delay: 0s;"></div>
             <div class="firefly" style="top: 50%; left: 80%; animation-delay: 2s;"></div>
             <div class="firefly" style="top: 80%; left: 40%; animation-delay: 4s;"></div>
        </div>
        <div class="w-full max-w-[340px] flex flex-col items-center relative z-10 animate-slide-up">
            <div class="w-28 h-28 bg-gradient-to-tr from-emerald-600 to-teal-500 rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(16,185,129,0.4)] mb-8 border-4 border-emerald-400/20 relative group">
                <div class="absolute inset-0 rounded-full border border-gold/40 border-dashed animate-spin-slow" style="animation-duration: 15s"></div>
                <div class="absolute inset-2 rounded-full border border-white/20 border-dotted animate-spin-reverse" style="animation-duration: 20s"></div>
                <i class="fas fa-kaaba text-5xl text-white drop-shadow-md group-hover:scale-110 transition-transform duration-500"></i>
                <div class="absolute -top-2 -right-2 w-8 h-8 bg-gold rounded-full flex items-center justify-center border-2 border-emerald-800 animate-bounce"><i class="fas fa-star text-emerald-900 text-[10px]"></i></div>
            </div>
            <div class="glass-panel w-full p-8 rounded-[2rem] shadow-2xl relative overflow-hidden bg-white/95 border-0 transform hover:scale-[1.01] transition-transform duration-500">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 via-gold to-emerald-400 animate-shimmer" style="background-size: 200% 100%;"></div>
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-serif font-bold text-emerald-900">Dompet Ramadan</h1>
                    <p class="text-emerald-600/80 text-xs font-medium mt-1 uppercase tracking-widest">Kelola Keuangan Penuh Berkah</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div class="space-y-1.5 group">
                        <label class="text-[10px] font-bold text-emerald-700 uppercase ml-4">Email</label>
                        <div class="relative transition-transform duration-300 group-focus-within:scale-[1.02]">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-envelope text-emerald-300 group-focus-within:text-emerald-600 transition-colors"></i></div>
                            <input type="email" id="email" class="w-full pl-10 pr-4 py-3.5 bg-emerald-50/50 border border-emerald-100 rounded-2xl text-emerald-900 placeholder-emerald-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500 transition-all outline-none font-medium text-sm" placeholder="email@contoh.com" required value="admin@uangku.com">
                        </div>
                    </div>
                    <div class="space-y-1.5 group">
                        <label class="text-[10px] font-bold text-emerald-700 uppercase ml-4">Password</label>
                        <div class="relative transition-transform duration-300 group-focus-within:scale-[1.02]">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-key text-emerald-300 group-focus-within:text-emerald-600 transition-colors"></i></div>
                            <input type="password" id="password" class="w-full pl-10 pr-10 py-3.5 bg-emerald-50/50 border border-emerald-100 rounded-2xl text-emerald-900 placeholder-emerald-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500 transition-all outline-none font-medium text-sm" placeholder="••••••••" required value="123456">
                            <button type="button" onclick="togglePassword()" class="absolute right-0 top-0 bottom-0 px-4 text-emerald-400 hover:text-emerald-700 transition-colors focus:outline-none"><i class="fas fa-eye text-xs" id="eye-icon"></i></button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-emerald-700 to-teal-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-700/30 mt-4 relative overflow-hidden group active:scale-[0.98] transition-all">
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-shimmer" style="background-size: 200% 100%;"></div>
                        <span class="relative flex items-center justify-center gap-2">Buka Dompet <i class="fas fa-chevron-right text-xs"></i></span>
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- ================== APP VIEW ================== -->
    <section id="app-view" class="hidden h-full flex flex-col relative z-10">
        
        <!-- Header -->
        <header class="fixed top-0 w-full z-30 glass-panel border-b-0 border-white/20 pt-safe transition-all duration-300">
            <div class="max-w-md mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 border border-emerald-200 flex items-center justify-center text-emerald-700 shadow-sm relative overflow-hidden group">
                        <i class="fas fa-moon group-hover:rotate-12 transition-transform"></i>
                        <div class="absolute -top-1 -right-1 text-gold text-xs animate-pulse"><i class="fas fa-star"></i></div>
                        <div class="absolute inset-0 bg-white/50 scale-0 group-hover:scale-100 rounded-full transition-transform opacity-20"></div>
                    </div>
                    <div>
                        <h1 class="text-lg font-serif font-bold text-emerald-900 leading-none">DompetKu</h1>
                        <p class="text-[10px] text-emerald-600 font-medium mt-1 flex items-center gap-1">
                            <i class="far fa-calendar-alt"></i> <span id="current-date">...</span>
                            <span id="offline-indicator" class="hidden w-1.5 h-1.5 bg-red-500 rounded-full animate-ping ml-1"></span>
                        </p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Theme Switcher -->
                    <button onclick="toggleThemeMenu()" class="w-9 h-9 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-600 shadow-sm active:scale-90 transition-all relative group">
                        <i class="fas fa-palette text-xs group-hover:text-emerald-800"></i>
                    </button>

                    <!-- Music Button -->
                    <button onclick="openMusicModal()" class="w-9 h-9 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-600 shadow-sm active:scale-90 transition-all relative group overflow-hidden">
                        <i class="fas fa-music text-xs group-hover:text-emerald-800 relative z-10 group-hover:animate-bounce"></i>
                        <div class="absolute inset-0 bg-emerald-100 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        <div id="header-music-indicator" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-gold rounded-full border-2 border-white animate-pulse shadow-sm z-20"></div>
                    </button>

                    <!-- System Controls -->
                    <button onclick="fetchData(true)" class="w-9 h-9 rounded-full bg-white border border-emerald-100 flex items-center justify-center text-emerald-600 shadow-sm active:scale-90 hover:bg-emerald-50 transition-all group">
                        <i class="fas fa-sync-alt text-xs group-hover:rotate-180 transition-transform duration-700" id="refresh-icon"></i>
                    </button>
                    <button onclick="handleLogout()" class="w-9 h-9 rounded-full bg-red-50 border border-red-100 flex items-center justify-center text-red-400 active:scale-90 hover:bg-red-100 transition-all hover:rotate-90">
                        <i class="fas fa-power-off text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Theme Dropdown -->
            <div id="theme-menu" class="hidden absolute top-[70px] right-6 w-48 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-emerald-50 z-[100] p-2 animate-fade-in origin-top-right">
                <p class="text-[10px] font-bold text-slate-400 px-3 py-2 uppercase tracking-widest">Pilih Tema</p>
                <div class="space-y-1">
                    <button onclick="setTheme('default')" class="w-full flex items-center gap-3 p-2 hover:bg-emerald-50 rounded-xl transition text-xs font-bold text-slate-700" id="btn-theme-default"><div class="w-5 h-5 rounded-full bg-[#059669] shadow-sm"></div> Emerald</button>
                    <button onclick="setTheme('midnight')" class="w-full flex items-center gap-3 p-2 hover:bg-slate-100 rounded-xl transition text-xs font-bold text-slate-700" id="btn-theme-midnight"><div class="w-5 h-5 rounded-full bg-[#0ea5e9] shadow-sm"></div> Midnight</button>
                    <button onclick="setTheme('royal')" class="w-full flex items-center gap-3 p-2 hover:bg-purple-50 rounded-xl transition text-xs font-bold text-slate-700" id="btn-theme-royal"><div class="w-5 h-5 rounded-full bg-[#9333ea] shadow-sm"></div> Royal</button>
                    <button onclick="setTheme('sahara')" class="w-full flex items-center gap-3 p-2 hover:bg-amber-50 rounded-xl transition text-xs font-bold text-slate-700" id="btn-theme-sahara"><div class="w-5 h-5 rounded-full bg-[#d97706] shadow-sm"></div> Sahara</button>
                    <button onclick="setTheme('crimson')" class="w-full flex items-center gap-3 p-2 hover:bg-rose-50 rounded-xl transition text-xs font-bold text-slate-700" id="btn-theme-crimson"><div class="w-5 h-5 rounded-full bg-[#e11d48] shadow-sm"></div> Crimson</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative pt-24 pb-32 w-full max-w-md mx-auto px-5" id="main-container">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="animate-slide-up">
                
                <!-- Prayer Times Card -->
                <div class="relative w-full rounded-[2rem] overflow-hidden shadow-xl shadow-orange-500/20 mb-6 prayer-gradient group hover:shadow-orange-500/40 transition-shadow duration-500">
                    <div class="absolute inset-0 bg-islamic-pattern opacity-10 mix-blend-overlay animate-pulse-slow"></div>
                    <div class="absolute top-0 -left-10 w-full h-full pointer-events-none overflow-hidden">
                        <div class="absolute top-1/2 left-0 w-20 h-[1px] bg-white transform -rotate-45 animate-[firefly_5s_infinite]"></div>
                    </div>

                    <div class="relative z-10 p-5 text-white">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-xs opacity-70 animate-bounce"></i>
                                <span class="text-xs font-bold uppercase tracking-wide" id="location-name">Jakarta</span>
                            </div>
                            <div class="text-[10px] font-medium bg-white/20 px-2 py-1 rounded-lg backdrop-blur-sm border border-white/10">
                                <span id="hijri-date">...</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <p class="text-[10px] opacity-80 uppercase tracking-widest mb-1">Menuju <span id="next-prayer-name">...</span></p>
                                <h2 class="text-3xl font-mono font-bold tracking-tight drop-shadow-sm" id="countdown-timer">--:--:--</h2>
                            </div>
                            <div class="text-right relative"><i class="fas fa-kaaba text-4xl opacity-20 absolute right-4 bottom-4 scale-150 transform group-hover:scale-[1.6] transition-transform duration-700"></i></div>
                        </div>

                        <!-- Modern Prayer Time Widgets -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <!-- Imsak Widget -->
                            <div class="relative bg-gradient-to-br from-blue-900/40 to-slate-900/40 rounded-2xl p-3 border border-blue-400/20 backdrop-blur-sm overflow-hidden group hover:bg-blue-900/50 transition-all duration-300">
                                <div class="absolute -right-2 -top-2 w-12 h-12 bg-blue-500/20 rounded-full blur-xl group-hover:bg-blue-400/30 transition-all"></div>
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-6 h-6 rounded-full bg-blue-500/20 flex items-center justify-center border border-blue-400/30">
                                        <i class="fas fa-cloud-moon text-[10px] text-blue-200"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-blue-100/80 uppercase tracking-wider">Imsak</span>
                                </div>
                                <div class="flex items-baseline gap-1 relative z-10">
                                    <span class="text-2xl font-mono font-bold text-white tracking-tight drop-shadow-sm" id="time-imsak">--:--</span>
                                    <span class="text-[10px] text-blue-200/60 font-medium">WIB</span>
                                </div>
                            </div>

                            <!-- Maghrib Widget -->
                            <div class="relative bg-gradient-to-br from-orange-900/40 to-red-900/40 rounded-2xl p-3 border border-orange-400/20 backdrop-blur-sm overflow-hidden group hover:bg-orange-900/50 transition-all duration-300">
                                <div class="absolute -right-2 -top-2 w-12 h-12 bg-orange-500/20 rounded-full blur-xl group-hover:bg-orange-400/30 transition-all"></div>
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-6 h-6 rounded-full bg-orange-500/20 flex items-center justify-center border border-orange-400/30">
                                        <i class="fas fa-utensils text-[10px] text-orange-200"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-orange-100/80 uppercase tracking-wider">Maghrib</span>
                                </div>
                                <div class="flex items-baseline gap-1 relative z-10">
                                    <span class="text-2xl font-mono font-bold text-white tracking-tight drop-shadow-sm" id="time-maghrib">--:--</span>
                                    <span class="text-[10px] text-orange-200/60 font-medium">WIB</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Main Balance Card -->
                <div class="relative w-full h-48 rounded-[2rem] overflow-hidden shadow-2xl shadow-emerald-700/20 mb-6 group transform transition hover:scale-[1.02] duration-500 card-gradient ring-4 ring-emerald-50/50">
                    <div class="absolute inset-0 bg-islamic-pattern opacity-10 mix-blend-overlay"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent skew-x-12 animate-shimmer" style="background-size: 200% 100%;"></div>
                    <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-gold/20 rounded-full blur-2xl animate-pulse-slow"></div>
                    <div class="relative z-10 p-6 h-full flex flex-col justify-between text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-emerald-100/80 text-[10px] font-bold uppercase tracking-widest mb-1 font-sans">Total Saldo Bersih</p>
                                <h2 class="text-3xl font-serif font-bold tracking-wide text-white drop-shadow-md" id="total-balance">Rp 0</h2>
                            </div>
                            <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/10 group-hover:rotate-12 transition-transform duration-500 shadow-inner"><i class="fas fa-wallet text-gold"></i></div>
                        </div>
                        <div class="flex gap-3 mt-2">
                            <div class="flex-1 bg-emerald-900/30 backdrop-blur-md rounded-xl p-3 border border-emerald-400/20 hover:bg-emerald-900/40 transition-colors">
                                <div class="flex items-center gap-1.5 mb-1">
                                    <div class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div>
                                    <span class="text-[10px] text-emerald-100 font-medium">Pemasukan</span>
                                </div>
                                <p class="font-bold text-sm truncate text-emerald-50" id="total-income">Rp 0</p>
                            </div>
                            <div class="flex-1 bg-emerald-900/30 backdrop-blur-md rounded-xl p-3 border border-emerald-400/20 hover:bg-emerald-900/40 transition-colors">
                                <div class="flex items-center gap-1.5 mb-1">
                                    <div class="w-1.5 h-1.5 bg-red-400 rounded-full animate-pulse"></div>
                                    <span class="text-[10px] text-emerald-100 font-medium">Pengeluaran</span>
                                </div>
                                <p class="font-bold text-sm truncate text-red-50" id="total-expense">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools Bar -->
                <div class="sticky top-[80px] z-20 py-2 -mx-5 px-5 glass-panel border-x-0 backdrop-blur-xl mb-4 transition-all duration-300">
                    <div class="flex gap-2 items-center">
                        <div class="relative flex-1 group">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-emerald-400 text-xs group-focus-within:text-emerald-600 transition-colors group-focus-within:scale-110"></i>
                            <input type="text" id="search-input" onkeyup="renderHistory()" placeholder="Cari sedekah, belanja..." class="w-full bg-white/80 border border-emerald-100 rounded-full pl-10 pr-4 py-2.5 text-xs font-medium shadow-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all placeholder-emerald-300/70 text-emerald-800 focus:bg-white">
                        </div>
                         <button onclick="openReceiptModal()" class="w-9 h-9 rounded-full bg-emerald-50 border border-emerald-100 shadow-sm flex items-center justify-center text-emerald-600 hover:text-emerald-800 hover:bg-emerald-100 active:scale-90 transition-all shrink-0 hover:shadow-md"><i class="fas fa-receipt text-xs"></i></button>
                        <div class="relative shrink-0">
                            <select id="month-filter" onchange="renderHistory()" class="appearance-none bg-emerald-50 text-emerald-800 text-xs font-bold rounded-full pl-4 pr-8 py-2.5 border border-emerald-100 shadow-sm focus:ring-2 focus:ring-emerald-500 h-full w-[100px] truncate hover:bg-emerald-100 transition-colors"><!-- JS --></select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-emerald-500"><i class="fas fa-chevron-down text-[10px]"></i></div>
                        </div>
                        <button onclick="toggleEditMode()" id="edit-mode-btn" class="w-9 h-9 rounded-full bg-white border border-emerald-100 shadow-sm flex items-center justify-center text-emerald-500 hover:text-emerald-700 active:scale-90 transition-all shrink-0 hover:shadow-md"><i class="fas fa-pen text-xs"></i></button>
                    </div>
                    <div id="edit-helper" class="hidden flex justify-between items-center mt-2 px-1 text-[10px] text-emerald-600 animate-fade-in font-bold">
                        <span>Pilih item untuk dihapus</span>
                        <button onclick="toggleSelectAll()" class="text-emerald-700 bg-emerald-100 px-3 py-1 rounded-full hover:bg-emerald-200 transition-colors">Pilih Semua</button>
                    </div>
                </div>

                <!-- List Container -->
                <div id="transaction-list" class="space-y-3 pb-safe min-h-[300px]">
                    <div class="flex flex-col items-center justify-center py-20 opacity-60">
                        <div class="crescent-loader mb-4"></div>
                        <p class="text-xs font-medium text-emerald-700">Menyiapkan catatan...</p>
                    </div>
                </div>
            </div>

            <!-- Report View -->
            <div id="view-report" class="hidden pb-safe space-y-6 animate-slide-up">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-serif font-bold text-emerald-900 text-lg">Ringkasan Laporan</h3>
                    <button onclick="openFullReportModal()" class="bg-emerald-800 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-800/20 active:scale-95 transition flex items-center gap-2 hover:bg-emerald-900 hover:shadow-xl"><i class="fas fa-file-export"></i> Ekspor Laporan</button>
                </div>

                <div class="bg-white/90 p-6 rounded-[2rem] shadow-sm border border-emerald-50 relative overflow-hidden backdrop-blur-sm">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-50 rounded-bl-full opacity-50 animate-pulse-slow"></div>
                    <h3 class="font-serif font-bold text-emerald-900 mb-6 text-base flex items-center gap-2 relative z-10"><i class="fas fa-chart-pie text-gold animate-spin-slow" style="animation-duration: 20s"></i> Analisis Bulan Ini</h3>
                    <div class="h-64 relative z-10"><canvas id="chart-pie"></canvas></div>
                </div>
                <div class="bg-white/90 p-6 rounded-[2rem] shadow-sm border border-emerald-50 backdrop-blur-sm">
                    <h3 class="font-serif font-bold text-emerald-900 mb-6 text-base flex items-center gap-2"><i class="fas fa-chart-line text-gold"></i> Grafik Harian</h3>
                    <div class="h-48 relative"><canvas id="chart-bar"></canvas></div>
                </div>
            </div>

            <!-- PRO CALENDAR VIEW (REMASTERED) -->
            <div id="view-calendar" class="hidden pb-safe space-y-4 animate-slide-up relative">
                
                <!-- Quick Actions & Header -->
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-serif font-bold text-emerald-900 text-xl leading-none">Kalender Hijriah</h3>
                        <p class="text-[10px] text-emerald-600 font-bold mt-1 uppercase tracking-widest">Agenda Ibadah</p>
                    </div>
                    <button onclick="jumpToToday()" class="bg-white/80 border border-emerald-200 text-emerald-700 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-emerald-50 transition flex items-center gap-2">
                        <i class="fas fa-crosshairs"></i> Hari Ini
                    </button>
                </div>

                <!-- Interactive Calendar Card -->
                <div class="bg-white/60 backdrop-blur-2xl rounded-[2rem] shadow-xl shadow-emerald-900/5 border border-white/50 p-5 relative overflow-hidden">
                    <!-- Nav -->
                    <div class="flex justify-between items-center mb-6 relative z-10">
                        <button onclick="changeCalendarMonth(-1)" class="w-10 h-10 rounded-xl bg-white border border-emerald-100 flex items-center justify-center text-slate-500 hover:text-emerald-600 hover:border-emerald-300 hover:bg-emerald-50 hover:shadow-md transition-all active:scale-95 group">
                            <i class="fas fa-chevron-left group-hover:-translate-x-0.5 transition-transform"></i>
                        </button>
                        <div class="text-center group cursor-pointer" onclick="jumpToToday()">
                            <h2 class="text-lg font-bold text-emerald-900 font-serif leading-none" id="cal-month-name">Januari 2026</h2>
                            <p class="text-[10px] text-emerald-600/80 font-bold mt-1 tracking-wide" id="cal-hijri-month">...</p>
                        </div>
                        <button onclick="changeCalendarMonth(1)" class="w-10 h-10 rounded-xl bg-white border border-emerald-100 flex items-center justify-center text-slate-500 hover:text-emerald-600 hover:border-emerald-300 hover:bg-emerald-50 hover:shadow-md transition-all active:scale-95 group">
                            <i class="fas fa-chevron-right group-hover:translate-x-0.5 transition-transform"></i>
                        </button>
                    </div>

                    <!-- Days Header -->
                    <div class="calendar-grid mb-3 pb-2 border-b border-dashed border-emerald-200/50">
                        <div class="calendar-day-header text-red-500">Min</div>
                        <div class="calendar-day-header">Sen</div>
                        <div class="calendar-day-header">Sel</div>
                        <div class="calendar-day-header">Rab</div>
                        <div class="calendar-day-header">Kam</div>
                        <div class="calendar-day-header text-emerald-600">Jum</div>
                        <div class="calendar-day-header">Sab</div>
                    </div>

                    <!-- Days Grid Container for Animation -->
                    <div id="calendar-days" class="calendar-grid min-h-[280px]">
                        <!-- JS Generated -->
                    </div>

                    <!-- Legend -->
                    <div class="mt-6 flex justify-center gap-4 text-[9px] font-bold text-slate-500 uppercase tracking-wide border-t border-emerald-100 pt-4">
                        <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-600"></div> Hari Ini</div>
                        <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-red-500"></div> Libur</div>
                        <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full border border-emerald-400"></div> Jumat</div>
                    </div>
                </div>

                <!-- Agenda / Holiday List -->
                <div class="bg-white/80 backdrop-blur-xl rounded-[2rem] shadow-sm border border-emerald-50 p-5">
                    <h4 class="font-bold text-emerald-900 mb-4 text-xs flex items-center gap-2 uppercase tracking-widest"><i class="far fa-calendar-check text-orange-500"></i> Agenda Bulan Ini</h4>
                    <div id="month-holidays-list" class="space-y-3">
                        <!-- JS Generated -->
                    </div>
                </div>
            </div>

        </main>

        <!-- Floating Action Button -->
        <div class="fixed bottom-[calc(5rem+env(safe-area-inset-bottom,20px))] right-5 z-40">
            <button id="main-fab" onclick="openModal()" class="group relative w-14 h-14 rounded-2xl bg-gradient-to-br from-gold to-goldDark text-white shadow-xl shadow-gold/40 flex items-center justify-center text-xl overflow-hidden transition-all duration-300 hover:scale-110 active:scale-95 border-2 border-white/20 hover:rotate-90">
                <div class="absolute inset-0 bg-white/30 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <div class="absolute inset-0 rounded-2xl border border-white/40 animate-ping opacity-20"></div>
                <i class="fas fa-plus relative z-10 drop-shadow-sm"></i>
            </button>
        </div>

        <!-- Navigation Bar (UPDATED WITH CALENDAR) -->
        <nav class="fixed bottom-0 w-full z-40 pb-safe bg-white/80 backdrop-blur-xl border-t border-emerald-100 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] rounded-t-[2rem]">
            <div class="flex justify-around items-center h-16 max-w-md mx-auto px-1">
                <button onclick="switchTab('home')" class="nav-btn active flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-600 transition group relative" data-target="home">
                    <div class="absolute -top-[1px] w-6 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator shadow-[0_0_10px_#10b981]"></div>
                    <i class="fas fa-mosque text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[9px] font-bold">Beranda</span>
                </button>
                <button onclick="switchTab('hutang')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="hutang">
                    <div class="absolute -top-[1px] w-6 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator shadow-[0_0_10px_#10b981]"></div>
                    <i class="fas fa-hand-holding-heart text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[9px] font-bold">Hutang</span>
                </button>
                <!-- NEW: CALENDAR BUTTON -->
                <button onclick="switchTab('kalender')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="kalender">
                    <div class="absolute -top-[1px] w-6 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator shadow-[0_0_10px_#10b981]"></div>
                    <i class="fas fa-calendar-alt text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[9px] font-bold">Kalender</span>
                </button>
                <button onclick="switchTab('piutang')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="piutang">
                    <div class="absolute -top-[1px] w-6 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator shadow-[0_0_10px_#10b981]"></div>
                    <i class="fas fa-hands-helping text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[9px] font-bold">Piutang</span>
                </button>
                <button onclick="switchTab('laporan')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 text-emerald-300 hover:text-emerald-500 transition group relative" data-target="laporan">
                    <div class="absolute -top-[1px] w-6 h-1 bg-emerald-500 rounded-b-full opacity-0 transition-all duration-300 indicator shadow-[0_0_10px_#10b981]"></div>
                    <i class="fas fa-chart-pie text-lg group-active:scale-90 transition-transform"></i>
                    <span class="text-[9px] font-bold">Laporan</span>
                </button>
            </div>
        </nav>
    </section>

    <!-- Modals (Input, Receipt, Report, Music, DayDetail) -->
    <!-- ... (Previous Modals Hidden for Brevity, Paste here) ... -->
    <!-- Note: Paste the previous Modals (Input, Receipt, Full Report, Music) here. I will include the new DAY DETAIL modal below. -->

    <!-- Modal Input Transaction -->
    <div id="modal" class="fixed inset-0 bg-emerald-900/60 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center transition-all duration-300 opacity-0">
        <div id="modal-content" class="bg-surface w-full sm:max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl transform translate-y-full transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) flex flex-col max-h-[90dvh] border-t border-white/50 relative">
            <div class="w-12 h-1 bg-emerald-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h3 class="text-xl font-serif font-bold text-emerald-900">Catat Transaksi</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center hover:bg-emerald-200 transition rotate-0 hover:rotate-90 duration-300"><i class="fas fa-times"></i></button>
            </div>
            <form id="transaction-form" onsubmit="submitForm(event)" class="overflow-y-auto no-scrollbar pb-safe">
                <div class="space-y-6">
                    <div class="bg-white p-1.5 rounded-2xl flex justify-between overflow-x-auto no-scrollbar gap-1 border border-emerald-100 shadow-sm">
                        <label class="flex-1 cursor-pointer min-w-[70px]"><input type="radio" name="tipe" value="Masuk" class="peer hidden" checked><div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-emerald-100 peer-checked:text-emerald-700 transition-all duration-300 peer-checked:shadow-sm peer-checked:scale-105">Masuk</div></label>
                        <label class="flex-1 cursor-pointer min-w-[70px]"><input type="radio" name="tipe" value="Keluar" class="peer hidden"><div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-red-50 peer-checked:text-red-600 transition-all duration-300 peer-checked:shadow-sm peer-checked:scale-105">Keluar</div></label>
                        <label class="flex-1 cursor-pointer min-w-[70px]"><input type="radio" name="tipe" value="Hutang" class="peer hidden"><div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-orange-50 peer-checked:text-orange-600 transition-all duration-300 peer-checked:shadow-sm peer-checked:scale-105">Hutang</div></label>
                        <label class="flex-1 cursor-pointer min-w-[70px]"><input type="radio" name="tipe" value="Piutang" class="peer hidden"><div class="h-10 flex items-center justify-center rounded-xl text-[10px] font-bold text-slate-400 peer-checked:bg-teal-50 peer-checked:text-teal-600 transition-all duration-300 peer-checked:shadow-sm peer-checked:scale-105">Piutang</div></label>
                    </div>
                    <div class="py-2 text-center relative">
                        <label class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1 block">Jumlah (Rp)</label>
                        <input type="tel" inputmode="numeric" name="jumlah" required class="w-full text-4xl font-serif font-bold text-emerald-900 text-center bg-transparent border-none outline-none placeholder-emerald-200 focus:placeholder-emerald-100 transition-all" placeholder="0">
                        <i class="fas fa-pen text-xs text-emerald-200 absolute right-4 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <div class="space-y-3">
                        <div class="bg-white p-3 rounded-2xl border border-emerald-100 focus-within:border-emerald-400 focus-within:ring-2 focus-within:ring-emerald-500/20 transition-all hover:shadow-sm">
                            <label class="block text-[10px] font-bold text-emerald-400 mb-1">Tanggal</label>
                            <input type="date" name="tanggal" required class="w-full bg-transparent border-none p-0 text-sm font-semibold text-slate-700 outline-none">
                        </div>
                        <div class="bg-white p-3 rounded-2xl border border-emerald-100 focus-within:border-emerald-400 focus-within:ring-2 focus-within:ring-emerald-500/20 transition-all hover:shadow-sm">
                            <label class="block text-[10px] font-bold text-emerald-400 mb-1">Keterangan</label>
                            <input type="text" name="keterangan" required class="w-full bg-transparent border-none p-0 text-sm font-semibold text-slate-700 outline-none placeholder-slate-300" placeholder="Zakat, Iftar, Bensin...">
                        </div>
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-emerald-800 text-white font-bold py-4 rounded-2xl mt-8 shadow-xl shadow-emerald-900/10 active:scale-[0.98] transition-all flex justify-center items-center gap-2 overflow-hidden relative group">
                    <span class="relative z-10 flex items-center gap-2">Bismillah, Simpan <i class="fas fa-check-circle group-hover:scale-125 transition-transform"></i></span>
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Receipt Generator -->
    <div id="modal-receipt" class="fixed inset-0 bg-emerald-900/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="receipt-content" class="bg-surface w-full max-w-lg rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-emerald-100 flex justify-between items-center bg-white">
                <h3 class="font-serif font-bold text-emerald-900 text-lg flex items-center gap-2"><i class="fas fa-receipt text-gold animate-bounce"></i> Buat Struk</h3>
                <button onclick="closeReceiptModal()" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar p-5 space-y-6">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                         <div class="bg-white p-3 rounded-xl border border-emerald-100">
                            <label class="text-[10px] font-bold text-emerald-400 block mb-1">Nama Toko</label>
                            <input type="text" id="receipt-store" value="Dompet Ramadan" class="w-full text-sm font-bold text-emerald-900 outline-none" oninput="updateReceiptPreview()">
                        </div>
                        <div class="bg-white p-3 rounded-xl border border-emerald-100">
                            <label class="text-[10px] font-bold text-emerald-400 block mb-1">Tanggal</label>
                            <input type="date" id="receipt-date" class="w-full text-sm font-bold text-emerald-900 outline-none" onchange="updateReceiptPreview()">
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-emerald-100">
                        <div class="flex justify-between items-center mb-2">
                             <label class="text-[10px] font-bold text-emerald-400">Daftar Barang</label>
                             <button onclick="addReceiptItem()" class="text-xs text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded hover:bg-emerald-100 transition">+ Tambah</button>
                        </div>
                        <div id="receipt-items-container" class="space-y-2"></div>
                    </div>
                </div>
                <div class="border-t-2 border-dashed border-emerald-200 pt-4">
                     <p class="text-center text-xs text-emerald-400 font-bold mb-2 uppercase tracking-widest">Preview Struk</p>
                     <div id="receipt-preview-container" class="bg-white p-6 shadow-sm mx-auto w-full max-w-[320px] font-mono text-sm text-slate-800 leading-tight relative transform hover:scale-[1.01] transition-transform duration-300">
                        <div class="absolute -top-[14px] left-0 w-full h-[15px] bg-white paper-tear" style="transform: rotate(180deg);"></div>
                        <div class="text-center mb-4">
                            <h2 class="font-bold text-xl uppercase tracking-widest" id="preview-store">DOMPET RAMADAN</h2>
                            <p class="text-[10px] text-slate-500 mt-1" id="preview-date">...</p>
                        </div>
                        <div class="border-b border-dashed border-slate-300 mb-2"></div>
                        <div id="preview-items" class="space-y-1 mb-2"></div>
                        <div class="border-b border-dashed border-slate-300 mb-2"></div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>TOTAL</span>
                            <span id="preview-total">Rp 0</span>
                        </div>
                        <div class="text-center mt-6 text-[10px] text-slate-400">
                            <p>Terima Kasih</p>
                            <p>Barakallah Fikum</p>
                        </div>
                         <div class="absolute -bottom-[14px] left-0 w-full h-[15px] bg-white paper-tear"></div>
                     </div>
                </div>
            </div>
            <div class="p-5 border-t border-emerald-100 bg-emerald-50 flex gap-3">
                 <button onclick="downloadReceiptAsImage()" class="flex-1 bg-emerald-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-900 transition flex items-center justify-center gap-2">
                    <i class="fas fa-image"></i> Simpan Gambar (JPG/PNG)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Full Monthly Report -->
    <div id="modal-full-report" class="fixed inset-0 bg-emerald-900/90 backdrop-blur-md z-[70] hidden flex items-center justify-center p-2 opacity-0 transition-opacity duration-300">
        <div id="report-content-wrapper" class="bg-slate-100 w-full max-w-2xl rounded-3xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="font-serif font-bold text-emerald-900 text-base flex items-center gap-2"><i class="fas fa-file-invoice text-gold"></i> Laporan Bulanan</h3>
                <button onclick="closeFullReportModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-slate-200/50 flex justify-center">
                <div id="monthly-report-container" class="bg-white shadow-xl p-8 w-full max-w-[595px] min-h-[842px] text-slate-800 relative">
                    <div class="flex justify-between items-start border-b-2 border-emerald-800 pb-6 mb-6">
                        <div><h1 class="text-2xl font-serif font-bold text-emerald-900 uppercase tracking-widest">Laporan Keuangan</h1><p class="text-sm text-emerald-600 font-semibold" id="report-period">Periode: -</p></div>
                        <div class="text-right"><h2 class="font-bold text-lg text-goldDark">Dompet Ramadan</h2><p class="text-[10px] text-slate-400">Generated by DompetKu App</p></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        <div class="bg-emerald-50 p-3 rounded-lg border border-emerald-100"><p class="text-[10px] font-bold text-emerald-600 uppercase">Pemasukan</p><p class="text-sm font-bold text-emerald-800" id="report-income">Rp 0</p></div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100"><p class="text-[10px] font-bold text-red-600 uppercase">Pengeluaran</p><p class="text-sm font-bold text-red-800" id="report-expense">Rp 0</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200"><p class="text-[10px] font-bold text-slate-600 uppercase">Sisa Saldo</p><p class="text-sm font-bold text-slate-800" id="report-balance">Rp 0</p></div>
                    </div>
                    <div class="mb-8"><h4 class="font-bold text-xs text-emerald-900 mb-2 uppercase border-b border-emerald-200 pb-1">Rincian Transaksi</h4><table class="w-full text-left report-table"><thead><tr><th class="rounded-l-md">Tanggal</th><th>Keterangan</th><th>Kategori</th><th class="text-right rounded-r-md">Jumlah</th></tr></thead><tbody id="report-table-body"></tbody></table></div>
                    <div class="absolute bottom-8 left-8 right-8 text-center border-t border-slate-200 pt-4"><p class="text-[10px] text-slate-400 italic">"Dan apa saja yang kamu infakkan, Allah akan menggantinya..." (QS. Saba: 39)</p></div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-slate-200 shrink-0 grid grid-cols-3 gap-3">
                <button onclick="downloadFullReport('pdf')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex flex-col items-center justify-center gap-1 text-xs"><i class="fas fa-file-pdf text-lg"></i> Simpan PDF</button>
                <button onclick="downloadFullReport('jpg')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex flex-col items-center justify-center gap-1 text-xs"><i class="fas fa-file-image text-lg"></i> Simpan JPG</button>
                <button onclick="downloadFullReport('png')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex flex-col items-center justify-center gap-1 text-xs"><i class="fas fa-image text-lg"></i> Simpan PNG</button>
            </div>
        </div>
    </div>
    
    <!-- Music Player Modal -->
    <div id="modal-music" class="fixed inset-0 bg-emerald-900/80 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="music-content" class="bg-surface w-full max-w-sm rounded-3xl shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300 border border-emerald-100">
            <div class="p-4 border-b border-emerald-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center gap-2"><i class="fas fa-compact-disc text-emerald-600 animate-spin-slow"></i><h3 class="font-serif font-bold text-emerald-900 leading-none">Music Player</h3></div>
                <button onclick="closeMusicModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 bg-gradient-to-br from-emerald-800 to-emerald-900 text-white text-center relative overflow-hidden shrink-0">
                <div class="w-32 h-32 rounded-full bg-white/10 absolute -top-10 -left-10 blur-2xl animate-pulse-slow"></div>
                <div class="w-20 h-20 rounded-full bg-gold/20 absolute -bottom-5 -right-5 blur-xl animate-pulse-slow" style="animation-delay: 1s;"></div>
                <div class="w-28 h-28 mx-auto bg-white/10 rounded-full flex items-center justify-center border-4 border-white/5 mb-5 relative shadow-lg shadow-emerald-900/50">
                     <div id="disk-anim" class="w-full h-full absolute inset-0 rounded-full border-t border-r border-white/30 animate-spin-slow pause-anim"></div>
                     <div class="w-8 h-8 bg-emerald-900 rounded-full absolute z-10 border border-white/20"></div>
                     <i class="fas fa-music text-3xl opacity-50"></i>
                </div>
                <h4 id="current-track-title" class="font-serif font-bold text-lg mb-1 truncate px-4">Pilih Lagu</h4>
                <p class="text-[10px] text-emerald-200 uppercase tracking-widest mb-6 opacity-70">Dompet Ramadan Audio</p>
                <div class="flex items-center justify-center gap-6">
                     <button onclick="changeTrack('prev')" class="text-white/70 hover:text-white active:scale-90 transition hover:scale-110"><i class="fas fa-step-backward text-xl"></i></button>
                     <button onclick="toggleMusic()" id="modal-play-btn" class="w-14 h-14 bg-gradient-to-br from-gold to-goldDark text-white shadow-lg shadow-gold/20 rounded-full flex items-center justify-center active:scale-90 hover:scale-105 transition-all border-2 border-white/20"><i class="fas fa-play ml-1"></i></button>
                     <button onclick="changeTrack('next')" class="text-white/70 hover:text-white active:scale-90 transition hover:scale-110"><i class="fas fa-step-forward text-xl"></i></button>
                </div>
            </div>
            <div class="p-4 bg-emerald-50/50 space-y-2 flex-1 overflow-y-auto min-h-[150px]" id="playlist-container"></div>
        </div>
    </div>

    <!-- NEW: Modal Day Detail (Calendar Interaction) -->
    <div id="modal-day-detail" class="fixed inset-0 bg-emerald-950/70 backdrop-blur-md z-[90] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="day-detail-content" class="bg-surface w-full max-w-xs rounded-[2rem] shadow-2xl flex flex-col overflow-hidden transform scale-90 transition-transform duration-300 relative border border-white/20">
            <button onclick="closeDayDetailModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-black/10 text-white flex items-center justify-center hover:bg-black/20 transition z-20"><i class="fas fa-times"></i></button>
            
            <div class="bg-gradient-to-br from-emerald-600 to-teal-800 p-8 text-white text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-islamic-pattern opacity-10"></div>
                <div class="relative z-10">
                    <p class="text-emerald-200 text-xs font-bold uppercase tracking-widest mb-2" id="detail-day-name">Senin</p>
                    <h2 class="text-5xl font-bold font-mono mb-2" id="detail-date-num">12</h2>
                    <p class="text-base font-serif" id="detail-month-year">Januari 2026</p>
                    <div class="mt-4 inline-block bg-white/10 px-4 py-1.5 rounded-full backdrop-blur-sm border border-white/20">
                        <p class="text-xs font-bold text-gold" id="detail-hijri">...</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6 bg-white space-y-4">
                <div id="detail-holiday-container" class="hidden bg-red-50 border border-red-100 rounded-xl p-3 flex items-start gap-3">
                    <i class="fas fa-calendar-check text-red-500 mt-1"></i>
                    <div>
                        <p class="text-[10px] font-bold text-red-400 uppercase">Hari Libur</p>
                        <p class="text-sm font-bold text-red-800 leading-tight" id="detail-holiday-name">...</p>
                    </div>
                </div>

                <div class="bg-emerald-50/50 border border-emerald-100 rounded-xl p-4">
                    <h4 class="text-[10px] font-bold text-emerald-600 uppercase mb-3 flex items-center gap-2"><i class="far fa-clock"></i> Estimasi Waktu</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="text-center bg-white p-2 rounded-lg shadow-sm">
                            <p class="text-[9px] text-slate-400 font-bold uppercase">Imsak</p>
                            <p class="text-sm font-mono font-bold text-slate-700" id="detail-imsak">--:--</p>
                        </div>
                        <div class="text-center bg-white p-2 rounded-lg shadow-sm">
                            <p class="text-[9px] text-slate-400 font-bold uppercase">Maghrib</p>
                            <p class="text-sm font-mono font-bold text-slate-700" id="detail-maghrib">--:--</p>
                        </div>
                    </div>
                    <p class="text-[9px] text-slate-400 italic text-center mt-3">*Waktu menyesuaikan lokasi Jakarta</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkVDFQGadQlKCE79pAv9pNu_ROuzNOu8AV1k0tvqvEzGI7xibMSHtIPo9KK9ePrrDv/exec"; 
        // =================================================

        let rawData = [];
        let pieChart = null;
        let barChart = null;
        let isEditMode = false;
        let selectedIds = new Set();
        let receiptItems = [{name: 'Item 1', qty: 1, price: 0}]; 
        let prayerInterval;
        
        // --- AUDIO PLAYLIST ---
        const playlist = [
            { title: "Nasyid Pilihan", url: "audio/audio1.mp3" },
            { title: "Instrumen Tenang", url: "audio/audio2.mp3" },
            { title: "Latar Ramadan", url: "audio/audio3.mp3" } 
        ];
        let currentTrackIndex = 0;
        const audioPlayer = document.getElementById('bg-music');
        const azanPlayer = document.getElementById('azan-player');
        let azanHasPlayed = false;

        // --- CALENDAR 2026 DATA & LOGIC (ENHANCED) ---
        let currentCalDate = new Date(2026, 0, 1); // Start at Jan 2026
        const holidays2026 = {
            "2026-01-01": "Tahun Baru Masehi",
            "2026-01-16": "Isra Mi'raj Nabi Muhammad SAW",
            "2026-02-17": "Tahun Baru Imlek 2577",
            "2026-03-19": "Hari Raya Nyepi",
            "2026-03-20": "Idul Fitri 1447 H",
            "2026-03-21": "Cuti Bersama Idul Fitri",
            "2026-03-31": "Wafat Isa Almasih",
            "2026-05-01": "Hari Buruh Internasional",
            "2026-05-14": "Kenaikan Isa Almasih",
            "2026-05-27": "Idul Adha 1447 H",
            "2026-05-31": "Hari Raya Waisak 2570",
            "2026-06-01": "Hari Lahir Pancasila",
            "2026-06-16": "Tahun Baru Islam 1448 H",
            "2026-08-17": "Hari Kemerdekaan RI",
            "2026-08-25": "Maulid Nabi Muhammad SAW",
            "2026-12-25": "Hari Raya Natal"
        };

        // Hijri Formatter using Intl API
        const hijriFormatter = new Intl.DateTimeFormat('id-ID-u-ca-islamic', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });

        function getHijriDate(date) {
            try {
                const parts = hijriFormatter.formatToParts(date);
                const day = parts.find(p => p.type === 'day').value;
                const month = parts.find(p => p.type === 'month').value;
                const year = parts.find(p => p.type === 'year').value;
                return `${day} ${month} ${year}`;
            } catch (e) {
                return "Hijriah Error";
            }
        }

        function renderCalendar(direction = '') {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            document.getElementById('cal-month-name').innerText = `${monthNames[month]} ${year}`;
            
            // Get Hijri Month range for header (Rough estimate based on 1st and last day)
            const hStart = getHijriDate(firstDay).split(' ')[1];
            const hEnd = getHijriDate(lastDay).split(' ')[1];
            document.getElementById('cal-hijri-month').innerText = hStart === hEnd ? hStart : `${hStart} - ${hEnd}`;

            const container = document.getElementById('calendar-days');
            
            // Animation Slide Class
            container.className = 'calendar-grid min-h-[280px]'; // reset
            if (direction) {
                void container.offsetWidth; // trigger reflow
                container.classList.add(direction === 'next' ? 'slide-left' : 'slide-right');
            }

            container.innerHTML = '';
            const listContainer = document.getElementById('month-holidays-list');
            listContainer.innerHTML = '';

            // Empty slots
            for (let i = 0; i < startingDay; i++) {
                container.innerHTML += `<div class="calendar-day empty"></div>`;
            }

            // Days
            let hasHoliday = false;
            const todayDate = new Date();

            for (let i = 1; i <= daysInMonth; i++) {
                const currentDate = new Date(year, month, i);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const isHoliday = holidays2026[dateStr];
                const dayOfWeek = currentDate.getDay(); // 0=Sun, 5=Fri
                const isFriday = dayOfWeek === 5;
                const isSunday = dayOfWeek === 0;
                
                // Hijri Day Num
                const hijriFull = getHijriDate(currentDate);
                const hijriDay = hijriFull.split(' ')[0];

                let classes = 'calendar-day group';
                if (isHoliday || isSunday) classes += ' holiday';
                else if (isFriday) classes += ' friday';

                // Check Today
                let isToday = false;
                if (todayDate.getFullYear() === year && todayDate.getMonth() === month && todayDate.getDate() === i) {
                    classes += ' today';
                    isToday = true;
                }

                // Animation Delay Stagger
                const delay = i * 20; 

                // HTML Build
                const html = `
                    <div class="${classes}" style="animation-delay: ${delay}ms" onclick="openDayDetail('${dateStr}')">
                        <span class="date-num">${i}</span>
                        <span class="hijri-date">${hijriDay}</span>
                        <div class="marker-dot ${isHoliday || isToday ? '' : 'opacity-0 group-hover:opacity-30'}"></div>
                    </div>
                `;
                container.innerHTML += html;

                if (isHoliday) {
                    hasHoliday = true;
                    listContainer.innerHTML += `
                        <div class="flex gap-3 items-center bg-red-50 p-3 rounded-2xl border border-red-100 hover:scale-[1.02] transition-transform shadow-sm animate-slide-up" style="animation-delay: ${delay}ms">
                            <div class="w-10 h-10 rounded-xl bg-red-100 flex flex-col items-center justify-center text-red-600 font-bold shrink-0 border border-red-200">
                                <span class="text-xs leading-none">${i}</span>
                                <span class="text-[8px] uppercase opacity-70">${monthNames[month].substring(0,3)}</span>
                            </div>
                            <div>
                                <h5 class="text-xs font-bold text-red-900 leading-tight">${isHoliday}</h5>
                                <p class="text-[9px] text-red-400 font-medium mt-0.5">${getHijriDate(currentDate)}</p>
                            </div>
                        </div>
                    `;
                }
            }
            if(!hasHoliday) {
                listContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-6 text-slate-400 opacity-70"><i class="far fa-smile-beam text-2xl mb-2"></i><p class="text-xs italic">Bulan yang tenang, tidak ada libur nasional.</p></div>`;
            }
        }

        function changeCalendarMonth(offset) {
            const dir = offset > 0 ? 'next' : 'prev';
            currentCalDate.setMonth(currentCalDate.getMonth() + offset);
            renderCalendar(dir);
        }

        function jumpToToday() {
            currentCalDate = new Date();
            renderCalendar('next');
            showToast("Kembali ke Hari Ini");
        }

        // --- CALENDAR DETAIL MODAL ---
        function openDayDetail(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dayName = date.toLocaleDateString('id-ID', { weekday: 'long' });
            
            // Populate Data
            document.getElementById('detail-day-name').innerText = dayName;
            document.getElementById('detail-date-num').innerText = date.getDate();
            document.getElementById('detail-month-year').innerText = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            document.getElementById('detail-hijri').innerText = getHijriDate(date);

            // Check Holiday
            const holiday = holidays2026[dateStr];
            const holCont = document.getElementById('detail-holiday-container');
            if (holiday) {
                holCont.classList.remove('hidden');
                document.getElementById('detail-holiday-name').innerText = holiday;
            } else {
                holCont.classList.add('hidden');
            }

            // Simple Static Estimation for Demo (In real app, use the API logic but cached)
            // Ideally we pass coordinate data here, but for UI demo we simulate
            const baseImsak = 4; // 04:00 base
            const baseMaghrib = 18; // 18:00 base
            // Slight variation based on day of year
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const variation = Math.sin(dayOfYear * 0.017) * 20; // minutes
            
            const imsakMins = Math.floor(25 + variation); // Base 04:25
            const maghribMins = Math.floor(10 + variation); // Base 18:10

            document.getElementById('detail-imsak').innerText = `04:${imsakMins.toString().padStart(2,'0')}`;
            document.getElementById('detail-maghrib').innerText = `18:${maghribMins.toString().padStart(2,'0')}`;

            // Show Modal
            const modal = document.getElementById('modal-day-detail');
            const content = document.getElementById('day-detail-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-90');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeDayDetailModal() {
            const modal = document.getElementById('modal-day-detail');
            const content = document.getElementById('day-detail-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-90');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- THEME LOGIC ---
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            menu.classList.toggle('hidden');
        }
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('theme-menu');
            const btn = document.querySelector('button[onclick="toggleThemeMenu()"]');
            if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden');
        });
        function setTheme(themeName) {
            if (themeName === 'default') document.body.removeAttribute('data-theme');
            else document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('dompetku_theme', themeName);
            updateMetaThemeColor(themeName);
            document.querySelectorAll('#theme-menu button').forEach(b => b.classList.remove('bg-slate-100'));
            const btnId = `btn-theme-${themeName}`;
            const activeBtn = document.getElementById(btnId);
            if(activeBtn) activeBtn.classList.add('bg-slate-100');
            document.getElementById('theme-menu').classList.add('hidden');
            showToast(`Tema ${themeName} diterapkan`, 'success');
        }
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('dompetku_theme') || 'default';
            setTheme(savedTheme);
        }
        function updateMetaThemeColor(theme) {
            let color = '#064e3b';
            if (theme === 'midnight') color = '#0c4a6e';
            if (theme === 'royal') color = '#581c87';
            if (theme === 'sahara') color = '#78350f';
            if (theme === 'crimson') color = '#881337';
            document.getElementById('meta-theme-color').setAttribute('content', color);
        }

        // --- PARTICLE GENERATOR ---
        function createFireflies() {
            const container = document.getElementById('particle-container');
            const fireflyCount = 15;
            for (let i = 0; i < fireflyCount; i++) {
                const firefly = document.createElement('div');
                firefly.classList.add('firefly');
                const x = Math.random() * 100; const y = Math.random() * 100;
                const duration = 10 + Math.random() * 10; const delay = Math.random() * 5;
                firefly.style.left = `${x}%`; firefly.style.top = `${y}%`;
                firefly.style.animationDuration = `3s, ${duration}s`; firefly.style.animationDelay = `0s, ${delay}s`;
                container.appendChild(firefly);
            }
        }

        // --- AUDIO PLAYLIST LOGIC ---
        audioPlayer.addEventListener('error', (e) => {
            const err = audioPlayer.error;
            let msg = 'Gagal memuat file.'; if(err.code === 4) msg = 'File audio tidak ditemukan.';
            showToast(msg, 'error'); updateMusicUI(false);
        });
        audioPlayer.addEventListener('ended', () => changeTrack('next'));

        async function toggleMusic() {
            if (!azanPlayer.paused) { azanPlayer.pause(); azanPlayer.currentTime = 0; }
            if (audioPlayer.paused) {
                if (!audioPlayer.src || audioPlayer.src === window.location.href) playTrack(currentTrackIndex);
                else {
                    try { await audioPlayer.play(); updateMusicUI(true); } 
                    catch (err) { updateMusicUI(false); showToast("Pilih lagu di daftar putar", 'warning'); }
                }
            } else { audioPlayer.pause(); updateMusicUI(false); }
        }

        function changeTrack(direction) {
            if (direction === 'next') currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            else currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            playTrack(currentTrackIndex);
        }

        async function playTrack(index) {
            if (!azanPlayer.paused) { azanPlayer.pause(); azanPlayer.currentTime = 0; }
            if (index < 0 || index >= playlist.length) index = 0;
            currentTrackIndex = index; const song = playlist[index];
            audioPlayer.src = song.url; audioPlayer.load();
            try { await audioPlayer.play(); updateMusicUI(true); renderPlaylist(); document.getElementById('current-track-title').innerText = song.title; } 
            catch (e) { updateMusicUI(false); showToast("Ketuk tombol putar untuk mulai", 'warning'); }
        }

        function updateMusicUI(isPlaying) {
            const modalBtn = document.getElementById('modal-play-btn');
            const diskAnim = document.getElementById('disk-anim');
            const headerInd = document.getElementById('header-music-indicator');
            if (isPlaying) {
                modalBtn.innerHTML = '<div class="eq-container"><div class="eq-bar bg-white"></div><div class="eq-bar bg-white"></div><div class="eq-bar bg-white"></div></div>';
                diskAnim.classList.remove('pause-anim'); headerInd.classList.remove('hidden');
                document.getElementById('current-track-title').innerText = playlist[currentTrackIndex].title;
            } else {
                modalBtn.innerHTML = '<i class="fas fa-play ml-1"></i>';
                diskAnim.classList.add('pause-anim'); headerInd.classList.add('hidden');
            }
        }
        
        function openMusicModal() {
            renderPlaylist();
            if(playlist[currentTrackIndex]) document.getElementById('current-track-title').innerText = playlist[currentTrackIndex].title;
            const modal = document.getElementById('modal-music'); const content = document.getElementById('music-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 50);
        }

        function closeMusicModal() {
            const modal = document.getElementById('modal-music'); const content = document.getElementById('music-content');
            modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = playlist.map((song, index) => {
                const isActive = index === currentTrackIndex;
                return `<div onclick="playTrack(${index})" class="flex items-center justify-between p-3 rounded-xl border ${isActive ? 'bg-emerald-600 border-emerald-600 text-white shadow-lg shadow-emerald-600/30' : 'bg-white border-emerald-100 text-slate-700 hover:bg-emerald-50'} cursor-pointer transition-all active:scale-95 hover:shadow-md"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${isActive ? 'bg-white/20' : 'bg-emerald-100'} flex items-center justify-center"><i class="fas ${isActive ? 'fa-volume-up' : 'fa-music'} ${isActive ? 'text-white' : 'text-emerald-500'} text-xs"></i></div><span class="text-xs font-bold truncate max-w-[180px]">${song.title}</span></div>${isActive ? '<div class="w-2 h-2 rounded-full bg-white animate-pulse"></div>' : ''}</div>`;
            }).join('');
        }

        // --- Common Animation ---
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            const startNum = 0; const endNum = parseInt(String(end).replace(/[^0-9-]/g, '')); let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (endNum - startNum) + startNum);
                obj.innerHTML = formatRupiah(value); if (progress < 1) window.requestAnimationFrame(step);
            }; window.requestAnimationFrame(step);
        }

        // --- Auth & Init Logic ---
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('dompetku_auth');
            if (isLoggedIn) showApp(); else { loadSavedTheme(); showLogin(); }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value; const pass = document.getElementById('password').value;
            if (email && pass) {
                const btn = e.target.querySelector('button[type="submit"]'); const originalContent = btn.innerHTML;
                btn.disabled = true; btn.innerHTML = '<div class="crescent-loader w-5 h-5 border-2"></div>';
                setTimeout(() => { localStorage.setItem('dompetku_auth', 'true'); showApp(); btn.disabled = false; btn.innerHTML = originalContent; }, 1200);
            }
        }

        function handleLogout() { if(confirm('Akhiri sesi?')) { localStorage.removeItem('dompetku_auth'); showLogin(); } }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            const appView = document.getElementById('app-view');
            appView.classList.remove('hidden'); appView.classList.add('animate-slide-up');
            initApp(); createFireflies();
        }

        function showLogin() { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('app-view').classList.add('hidden'); }
        function togglePassword() { const input = document.getElementById('password'); input.type = input.type === "password" ? "text" : "password"; }

        // --- App Logic ---
        function initApp() {
            loadSavedTheme();
            renderCalendar(); // Initialize Calendar
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="tanggal"]').value = today; document.getElementById('receipt-date').value = today;
            
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
            
            const cachedData = localStorage.getItem('dompetku_data');
            if (cachedData) { rawData = JSON.parse(cachedData); populateMonthFilter(); renderHistory(); }
            fetchData(); initPrayerTimes();
        }

        async function fetchData(manual = false) {
            const icon = document.getElementById('refresh-icon'); if(icon) icon.classList.add('fa-spin');
            try {
                if (!WEB_APP_URL && rawData.length > 0 && !manual) return;
                const response = await fetch(`${WEB_APP_URL}?action=read`); const result = await response.json();
                if (result.status === 'success') {
                    rawData = result.data; localStorage.setItem('dompetku_data', JSON.stringify(rawData));
                    document.getElementById('offline-indicator').classList.add('hidden');
                    populateMonthFilter(); renderHistory(); if(manual) showToast('Data Diperbarui', 'success');
                }
            } catch (error) { if (rawData.length > 0) document.getElementById('offline-indicator').classList.remove('hidden'); } 
            finally { if(icon) icon.classList.remove('fa-spin'); }
        }

        async function submitForm(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn'); const originalHTML = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<div class="crescent-loader w-5 h-5 border-2"></div>';
            const formData = new FormData(e.target); const data = Object.fromEntries(formData);
            if (data.tipe === 'Hutang' || data.tipe === 'Piutang') data.status = 'Belum Lunas'; else data.status = '-';
            try {
                const response = await fetch(`${WEB_APP_URL}?action=create`, { method: 'POST', body: JSON.stringify(data) });
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('Barakallah, Tersimpan!', 'success'); closeModal(); e.target.reset();
                    document.querySelector('input[name="tanggal"]').value = new Date().toISOString().split('T')[0]; fetchData(true); 
                } else throw new Error(result.message);
            } catch (error) { showToast('Gagal: ' + error.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = originalHTML; }
        }

        async function markAsPaid(id) {
            if(!confirm("Sudah lunas? Alhamdulillah.")) return;
            const card = document.getElementById(`card-${id}`); if(card) card.style.opacity = '0.5';
            try {
                const response = await fetch(`${WEB_APP_URL}?action=updateStatus`, { method: 'POST', body: JSON.stringify({ id: id, status: 'Lunas' }) });
                if (await response.json().then(r => r.status === 'success')) { showToast('Lunas, Alhamdulillah', 'success'); fetchData(true); }
            } catch (error) { showToast('Gagal update', 'error'); if(card) card.style.opacity = '1'; }
        }

        // --- Prayer Time Logic ---
        async function initPrayerTimes() {
            const city = 'Jakarta'; const country = 'Indonesia';
            if (navigator.geolocation) navigator.geolocation.getCurrentPosition(pos => fetchPrayerTimes(pos.coords.latitude, pos.coords.longitude), err => fetchPrayerTimesByCity(city, country));
            else fetchPrayerTimesByCity(city, country);
        }
        async function fetchPrayerTimesByCity(city, country) {
            try { const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=20`); const data = await res.json(); updatePrayerUI(data.data, city); } catch (e) { console.error(e); }
        }
        async function fetchPrayerTimes(lat, long) {
            try { const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${long}&method=20`); const data = await res.json(); updatePrayerUI(data.data, "Lokasi Anda"); } catch (e) { fetchPrayerTimesByCity("Jakarta", "Indonesia"); }
        }
        function updatePrayerUI(data, location) {
            const timings = data.timings; const hijri = data.date.hijri;
            document.getElementById('location-name').innerText = location; document.getElementById('hijri-date').innerText = `${hijri.day} ${hijri.month.en} ${hijri.year} H`;
            document.getElementById('time-imsak').innerText = timings.Imsak; document.getElementById('time-maghrib').innerText = timings.Maghrib;
            startCountdown(timings);
        }
        function playAzan() {
            if (!audioPlayer.paused) { audioPlayer.pause(); updateMusicUI(false); }
            azanPlayer.play().then(() => showToast("Waktunya Azan / Imsak!", "success")).catch(e => showToast("Waktu Sholat Tiba", "warning"));
        }
        function startCountdown(timings) {
            if (prayerInterval) clearInterval(prayerInterval);
            prayerInterval = setInterval(() => {
                const now = new Date(); const times = { imsak: parseTime(timings.Imsak), maghrib: parseTime(timings.Maghrib) };
                let targetTime, name;
                if (now < times.imsak) { targetTime = times.imsak; name = "Imsak"; } else if (now < times.maghrib) { targetTime = times.maghrib; name = "Berbuka"; } else { targetTime = new Date(times.imsak.getTime() + 24 * 60 * 60 * 1000); name = "Imsak"; }
                const diff = targetTime - now;
                if (diff <= 1000 && diff > 0 && !azanHasPlayed) { playAzan(); azanHasPlayed = true; setTimeout(() => { azanHasPlayed = false; }, 60000); }
                const h = Math.floor((diff % (86400000)) / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('countdown-timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; document.getElementById('next-prayer-name').innerText = name;
            }, 1000);
        }
        function parseTime(timeStr) { const [time] = timeStr.split(' '); let [h, m] = time.split(':'); const d = new Date(); d.setHours(parseInt(h), parseInt(m), 0, 0); return d; }

        // --- Delete & Edit Logic ---
        function toggleEditMode() {
            isEditMode = !isEditMode; const btn = document.getElementById('edit-mode-btn'); const fab = document.getElementById('main-fab'); const helper = document.getElementById('edit-helper');
            if (isEditMode) { btn.classList.add('bg-red-50', 'text-red-500', 'border-red-200'); btn.innerHTML = '<i class="fas fa-times"></i>'; fab.classList.add('scale-0'); helper.classList.remove('hidden'); helper.classList.add('flex'); } 
            else { btn.classList.remove('bg-red-50', 'text-red-500', 'border-red-200'); btn.innerHTML = '<i class="fas fa-pen text-xs"></i>'; fab.classList.remove('scale-0'); helper.classList.add('hidden'); helper.classList.remove('flex'); selectedIds.clear(); updateDeleteBar(); }
            renderHistory();
        }
        function toggleSelection(id) { if (!isEditMode) return; if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); updateDeleteBar(); renderHistory(); }
        function toggleSelectAll() { const vIds = getVisibleIds(); const allSel = vIds.every(id => selectedIds.has(id)); if (allSel) vIds.forEach(id => selectedIds.delete(id)); else vIds.forEach(id => selectedIds.add(id)); renderHistory(); updateDeleteBar(); }
        function getVisibleIds() {
            const fVal = document.getElementById('month-filter').value; const sTerm = document.getElementById('search-input').value.toLowerCase(); let fData = rawData;
            if (fVal) fData = fData.filter(i => i.tanggal.startsWith(fVal)); if (sTerm) fData = fData.filter(i => i.keterangan.toLowerCase().includes(sTerm) || i.jumlah.toString().includes(sTerm));
            return fData.map(i => i.id);
        }
        function updateDeleteBar() { const bar = document.getElementById('delete-bar'); document.getElementById('selected-count').innerText = selectedIds.size; if (selectedIds.size > 0) bar.classList.remove('translate-y-40'); else bar.classList.add('translate-y-40'); }
        async function deleteSelectedItems() {
            if (selectedIds.size === 0) return; if (!confirm(`Hapus ${selectedIds.size} data?`)) return;
            const ids = Array.from(selectedIds); const orig = [...rawData]; rawData = rawData.filter(i => !selectedIds.has(i.id)); localStorage.setItem('dompetku_data', JSON.stringify(rawData));
            toggleEditMode(); showToast('Menghapus...', 'success');
            try { await fetch(`${WEB_APP_URL}?action=delete`, { method: 'POST', body: JSON.stringify({ ids: ids }) }); } 
            catch (error) { rawData = orig; localStorage.setItem('dompetku_data', JSON.stringify(rawData)); renderHistory(); showToast('Gagal menghapus!', 'error'); }
        }

        // --- Report & Receipt Logic ---
        function openFullReportModal() {
            const mVal = document.getElementById('month-filter').value; if(!mVal) { showToast('Pilih bulan terlebih dahulu', 'error'); return; }
            const [y, m] = mVal.split('-'); document.getElementById('report-period').innerText = `Periode: ${new Date(y, m - 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`;
            let fData = rawData.filter(i => i.tanggal.startsWith(mVal)); fData.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));
            let tIn = 0; let tOut = 0; let tHtml = '';
            if(fData.length === 0) tHtml = '<tr><td colspan="4" class="text-center italic text-slate-400 py-4">Tidak ada data transaksi.</td></tr>';
            else { fData.forEach(i => { const v = parseInt(i.jumlah); const isExp = ['Keluar', 'Hutang', 'Piutang'].includes(i.tipe); if(isExp) tOut += v; else tIn += v; tHtml += `<tr><td>${new Date(i.tanggal).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</td><td class="font-medium">${i.keterangan}</td><td><span class="px-2 py-0.5 rounded text-[9px] ${isExp ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">${i.tipe}</span></td><td class="text-right font-bold ${isExp ? 'text-red-600' : 'text-emerald-600'}">${formatRupiah(v)}</td></tr>`; }); }
            document.getElementById('report-income').innerText = formatRupiah(tIn); document.getElementById('report-expense').innerText = formatRupiah(tOut); document.getElementById('report-balance').innerText = formatRupiah(tIn - tOut); document.getElementById('report-table-body').innerHTML = tHtml;
            const modal = document.getElementById('modal-full-report'); const wrap = document.getElementById('report-content-wrapper'); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); wrap.classList.remove('scale-95'); wrap.classList.add('scale-100'); }, 10);
        }
        function closeFullReportModal() { const modal = document.getElementById('modal-full-report'); const wrap = document.getElementById('report-content-wrapper'); modal.classList.add('opacity-0'); wrap.classList.remove('scale-100'); wrap.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); }
        function downloadFullReport(format) {
            const el = document.getElementById('monthly-report-container'); const btn = event.currentTarget; const orig = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
                if (format === 'pdf') { const img = canvas.toDataURL('image/png'); const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); const w = pdf.internal.pageSize.getWidth(); const h = (canvas.height * w) / canvas.width; pdf.addImage(img, 'PNG', 0, 0, w, h); pdf.save(`Laporan-${Date.now()}.pdf`); } 
                else { const link = document.createElement('a'); link.download = `Laporan-${Date.now()}.${format}`; link.href = canvas.toDataURL(`image/${format === 'jpg' ? 'jpeg' : 'png'}`); link.click(); }
                showToast('Berhasil disimpan!', 'success'); btn.innerHTML = orig; btn.disabled = false;
            }).catch(e => { showToast('Gagal menyimpan', 'error'); btn.innerHTML = orig; btn.disabled = false; });
        }
        function openReceiptModal() { const modal = document.getElementById('modal-receipt'); const content = document.getElementById('receipt-content'); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 50); renderReceiptInputs(); updateReceiptPreview(); }
        function closeReceiptModal() { const modal = document.getElementById('modal-receipt'); const content = document.getElementById('receipt-content'); modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); }
        function addReceiptItem() { receiptItems.push({name: '', qty: 1, price: 0}); renderReceiptInputs(); updateReceiptPreview(); }
        function removeReceiptItem(index) { receiptItems.splice(index, 1); renderReceiptInputs(); updateReceiptPreview(); }
        function updateReceiptItem(index, field, value) { if (field === 'qty' || field === 'price') value = parseInt(value) || 0; receiptItems[index][field] = value; updateReceiptPreview(); }
        function renderReceiptInputs() {
            document.getElementById('receipt-items-container').innerHTML = receiptItems.map((item, index) => `<div class="flex gap-2 items-center"><input type="text" placeholder="Item" value="${item.name}" oninput="updateReceiptItem(${index}, 'name', this.value)" class="flex-1 bg-emerald-50/50 rounded-lg px-2 py-2 text-xs border border-emerald-100 outline-none focus:border-emerald-300"><input type="number" placeholder="Qty" value="${item.qty}" oninput="updateReceiptItem(${index}, 'qty', this.value)" class="w-12 bg-emerald-50/50 rounded-lg px-2 py-2 text-xs border border-emerald-100 outline-none focus:border-emerald-300 text-center"><input type="number" placeholder="Rp" value="${item.price}" oninput="updateReceiptItem(${index}, 'price', this.value)" class="w-20 bg-emerald-50/50 rounded-lg px-2 py-2 text-xs border border-emerald-100 outline-none focus:border-emerald-300"><button onclick="removeReceiptItem(${index})" class="text-red-400 hover:text-red-600 px-1"><i class="fas fa-trash-alt text-xs"></i></button></div>`).join('');
        }
        function updateReceiptPreview() {
            document.getElementById('preview-store').innerText = document.getElementById('receipt-store').value || 'TOKO'; const date = document.getElementById('receipt-date').value;
            document.getElementById('preview-date').innerText = date ? new Date(date).toLocaleDateString('id-ID', {weekday:'long', year:'numeric', month:'long', day:'numeric'}) : '...';
            let total = 0;
            document.getElementById('preview-items').innerHTML = receiptItems.map(item => { const sub = item.qty * item.price; total += sub; if(!item.name) return ''; return `<div class="flex justify-between items-start"><div class="w-2/3"><span class="block font-bold">${item.name.toUpperCase()}</span><span class="text-[10px] text-slate-500">${item.qty} x ${formatRupiah(item.price)}</span></div><div class="w-1/3 text-right font-bold">${formatRupiah(sub)}</div></div>`; }).join('');
            document.getElementById('preview-total').innerText = formatRupiah(total);
        }
        function downloadReceiptAsImage() {
            const el = document.getElementById('receipt-preview-container'); const btn = document.querySelector('#modal-receipt button.bg-emerald-800'); const orig = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...'; btn.disabled = true;
            html2canvas(el, { scale: 2, backgroundColor: '#ffffff', logging: false, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); link.download = 'Struk-' + Date.now() + '.png'; link.href = canvas.toDataURL('image/png'); link.click();
                btn.innerHTML = orig; btn.disabled = false; showToast('Struk disimpan!', 'success');
            }).catch(err => { btn.innerHTML = orig; btn.disabled = false; showToast('Gagal menyimpan', 'error'); });
        }

        // --- Render UI ---
        function populateMonthFilter() {
            const select = document.getElementById('month-filter'); const curr = select.value;
            const uM = [...new Set(rawData.map(i => { const d = new Date(i.tanggal); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }))].sort().reverse();
            select.innerHTML = uM.map(m => { const [y, mn] = m.split('-'); const mName = new Date(y, mn - 1).toLocaleString('id-ID', { month: 'long' }); return `<option value="${m}">${mName} ${y}</option>`; }).join('');
            if (uM.length === 0) select.innerHTML = `<option value="">Bulan Ini</option>`;
            if (curr && uM.includes(curr)) select.value = curr; else if (uM.length > 0) select.value = uM[0];
        }

        function renderHistory() {
            const fVal = document.getElementById('month-filter').value; const sTerm = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('transaction-list'); let fData = rawData;
            if (fVal) fData = fData.filter(i => i.tanggal.startsWith(fVal)); if (sTerm) fData = fData.filter(i => i.keterangan.toLowerCase().includes(sTerm) || i.jumlah.toString().includes(sTerm));
            let inc = 0, exp = 0; fData.forEach(i => { const v = parseInt(i.jumlah); if (i.tipe === 'Masuk') inc += v; if (['Keluar', 'Hutang', 'Piutang'].includes(i.tipe)) exp += v; });
            animateValue('total-balance', 0, inc - exp, 800); document.getElementById('total-income').textContent = formatRupiah(inc); document.getElementById('total-expense').textContent = formatRupiah(exp);
            
            const activeTab = document.querySelector('.nav-btn.active').dataset.target;
            if (activeTab === 'hutang') { renderDebtList(rawData, sTerm, 'Hutang'); return; }
            else if (activeTab === 'piutang') { renderReceivableList(rawData, sTerm); return; }
            else if (activeTab === 'laporan') { renderReports(fData); return; }
            else if (activeTab === 'kalender') { return; } // Handled in switchTab

            if (fData.length === 0) { container.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-emerald-300 animate-slide-up"><i class="fas fa-moon text-4xl mb-3 opacity-30"></i><p class="text-xs font-medium">Belum ada catatan.</p></div>`; return; }
            container.innerHTML = fData.map((item, index) => {
                const isExp = ['Keluar', 'Hutang', 'Piutang'].includes(item.tipe); const colorClass = isExp ? 'text-red-500' : 'text-emerald-600';
                let iconClass = 'bg-slate-50 text-slate-400'; let iconName = 'fa-coins';
                if(item.tipe === 'Masuk') { iconClass = 'bg-emerald-100 text-emerald-600'; iconName = 'fa-arrow-down'; }
                if(item.tipe === 'Keluar') { iconClass = 'bg-red-50 text-red-500'; iconName = 'fa-shopping-basket'; }
                if(item.tipe === 'Hutang') { iconClass = 'bg-orange-50 text-orange-500'; iconName = 'fa-file-invoice'; }
                if(item.tipe === 'Piutang') { iconClass = 'bg-teal-50 text-teal-600'; iconName = 'fa-hand-holding-usd'; }
                const isSel = selectedIds.has(item.id); const selStyle = isSel ? 'bg-emerald-50 border-emerald-300 ring-1 ring-emerald-300' : 'bg-white border-transparent';
                return `<div id="container-${item.id}" onclick="isEditMode ? toggleSelection('${item.id}') : null" class="${selStyle} p-4 rounded-2xl shadow-sm border flex items-center justify-between active:scale-[0.98] transition-all duration-300 select-none cursor-pointer animate-slide-up hover:shadow-md hover:scale-[1.01]" style="animation-delay: ${Math.min(index * 50, 500)}ms; animation-fill-mode: forwards; opacity: 0;"><div class="flex items-center gap-4 overflow-hidden">${isEditMode ? `<div class="w-5 h-5 rounded-full border-2 ${isSel ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'} flex items-center justify-center"><i class="fas fa-check text-white text-[10px] ${isSel?'':'hidden'}"></i></div>` : ''}<div class="w-10 h-10 rounded-full ${iconClass} flex items-center justify-center shrink-0"><i class="fas ${iconName} text-xs"></i></div><div class="min-w-0"><p class="font-bold text-slate-700 text-sm truncate mb-0.5">${item.keterangan}</p><p class="text-[10px] text-slate-400 font-medium">${new Date(item.tanggal).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})}</p></div></div><div class="text-right shrink-0"><p class="font-bold ${colorClass} text-sm">${isExp ? '-' : '+'} ${formatRupiah(item.jumlah)}</p></div></div>`;
            }).join('');
        }

        function renderDebtList(data, search, type) {
            const container = document.getElementById('transaction-list');
            let debts = data.filter(item => item.tipe === type); if(search) debts = debts.filter(item => item.keterangan.toLowerCase().includes(search));
            const totalH = debts.reduce((a, c) => a + parseInt(c.jumlah), 0); const totalBL = debts.filter(p => p.status !== 'Lunas').reduce((a, c) => a + parseInt(c.jumlah), 0); const pct = totalH > 0 ? ((totalH - totalBL)/totalH)*100 : 0;
            let bg = type === 'Hutang' ? 'from-orange-400 to-red-500' : 'from-teal-400 to-emerald-500'; let title = type === 'Hutang' ? 'Hutang' : 'Piutang';
            let html = `<div class="bg-gradient-to-r ${bg} rounded-[1.5rem] p-5 text-white shadow-lg mb-6 animate-fade-in relative overflow-hidden"><div class="absolute right-0 top-0 opacity-10 text-6xl"><i class="fas fa-kaaba"></i></div><div class="flex justify-between items-end mb-3 relative z-10"><div><p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Total ${title}</p><h2 class="text-2xl font-serif font-bold">${formatRupiah(totalH)}</h2></div><div class="text-right"><p class="text-[10px] font-medium opacity-80">Sisa</p><p class="font-bold text-lg">${formatRupiah(totalBL)}</p></div></div><div class="w-full bg-black/20 h-1.5 rounded-full overflow-hidden relative z-10"><div class="bg-white h-full transition-all duration-1000 ease-out" style="width: ${pct}%"></div></div></div>`;
            if (debts.length === 0) { container.innerHTML = html + `<div class="text-center py-10 text-slate-400 text-xs">Bersih dari ${title}, Alhamdulillah.</div>`; return; }
            html += debts.map((item, index) => {
                const isLunas = item.status === 'Lunas';
                return `<div id="card-${item.id}" class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-50 mb-3 relative overflow-hidden active:scale-[0.99] transition-all animate-slide-up" style="animation-delay: ${index*50}ms">${isLunas ? '<div class="absolute -right-6 top-3 bg-emerald-500 text-white text-[9px] font-bold px-8 py-1 rotate-45 shadow-sm">LUNAS</div>' : ''}<div class="flex justify-between items-start mb-3"><div class="min-w-0 pr-4"><h4 class="font-bold text-slate-800 truncate text-sm">${item.keterangan}</h4><div class="flex items-center gap-1 text-[10px] text-slate-400 mt-1"><i class="far fa-calendar"></i> ${new Date(item.tanggal).toLocaleDateString('id-ID')}</div></div><p class="font-bold text-slate-700 shrink-0 text-sm">${formatRupiah(item.jumlah)}</p></div>${!isLunas ? `<div class="pt-2 mt-2 border-t border-slate-50 flex justify-end"><button onclick="markAsPaid('${item.id}')" class="text-[10px] font-bold bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg border border-emerald-100 active:scale-95 transition">Lunasi</button></div>` : ''}</div>`;
            }).join(''); container.innerHTML = html;
        }
        function renderReceivableList(d,s) { renderDebtList(d,s,'Piutang'); }
        function renderReports(data) {
            if (typeof Chart === 'undefined') return;
            if(pieChart) pieChart.destroy(); if(barChart) barChart.destroy();
            Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
            const ctxPie = document.getElementById('chart-pie').getContext('2d');
            pieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Masuk', 'Keluar', 'Hutang', 'Piutang'], datasets: [{ data: [ data.filter(i => i.tipe === 'Masuk').reduce((a, b) => a + parseInt(b.jumlah), 0), data.filter(i => i.tipe === 'Keluar').reduce((a, b) => a + parseInt(b.jumlah), 0), data.filter(i => i.tipe === 'Hutang').reduce((a, b) => a + parseInt(b.jumlah), 0), data.filter(i => i.tipe === 'Piutang').reduce((a, b) => a + parseInt(b.jumlah), 0), ], backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#14b8a6'], borderWidth: 0, hoverOffset: 10 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 6, font: {size: 10} } } } } });
            const dData = {}; for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); dData[d.toISOString().split('T')[0]] = { label: d.toLocaleDateString('id-ID', {weekday:'short'}), val: 0 }; }
            data.forEach(i => { if(dData[i.tanggal]) dData[i.tanggal].val += parseInt(i.jumlah); });
            const ctxBar = document.getElementById('chart-bar').getContext('2d'); const grad = ctxBar.createLinearGradient(0, 0, 0, 300); grad.addColorStop(0, '#10b981'); grad.addColorStop(1, '#047857');
            barChart = new Chart(ctxBar, { type: 'bar', data: { labels: Object.values(dData).map(d => d.label), datasets: [{ label: 'Rp', data: Object.values(dData).map(d => d.val), backgroundColor: grad, borderRadius: 4, barThickness: 12 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: {size: 9} } } }, plugins: { legend: { display: false } } } });
        }
        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); document.getElementById('toast-message').innerText = msg; t.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none'), 3000); }
        function openModal() { const m = document.getElementById('modal'); const c = document.getElementById('modal-content'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('translate-y-full'); }, 50); }
        function closeModal() { const m = document.getElementById('modal'); const c = document.getElementById('modal-content'); c.classList.add('translate-y-full'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 350); }
        
        // --- SWITCH TAB (Updated) ---
        function switchTab(target) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const ind = btn.querySelector('.indicator'); const icon = btn.querySelector('i');
                if(btn.dataset.target === target) { btn.classList.add('active', 'text-emerald-600'); btn.classList.remove('text-emerald-300'); ind.classList.remove('opacity-0'); icon.classList.add('text-emerald-600'); } 
                else { btn.classList.remove('active', 'text-emerald-600'); btn.classList.add('text-emerald-300'); ind.classList.add('opacity-0'); icon.classList.remove('text-emerald-600'); }
            });
            // Handle Views
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-report').classList.add('hidden');
            document.getElementById('view-calendar').classList.add('hidden');

            if (target === 'home' || target === 'hutang' || target === 'piutang') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                if (isEditMode) toggleEditMode(); else renderHistory();
            } else if (target === 'laporan') {
                document.getElementById('view-report').classList.remove('hidden');
                if (isEditMode) toggleEditMode();
                renderReports(rawData.filter(i => { const m = document.getElementById('month-filter').value; return m ? i.tanggal.startsWith(m) : true; }));
            } else if (target === 'kalender') {
                document.getElementById('view-calendar').classList.remove('hidden');
                renderCalendar();
            }
        }

        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
